<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="努力，奋斗！"><title>Nginx应用篇 | 其斤.匕禾页</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Nginx应用篇</h1><a id="logo" href="/.">其斤.匕禾页</a><p class="description">永远相信美好的事情即将发生</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="https://blog.xhzyxed.cn/2017/09/25/408基础/"><i class="fa fa-archive"> 计算机基础</i></a><a href="https://blog.xhzyxed.cn/2018/09/17/resume/"><i class="fa fa-user"> resume</i></a><a href="https://www.xhzyxed.cn/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Nginx应用篇</h1><div class="post-meta">Sep 9, 2018<span> | </span><span class="category"><a href="/categories/Nginx/">Nginx</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx虚拟主机配置"><span class="toc-number">1.</span> <span class="toc-text">Nginx虚拟主机配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#配置项"><span class="toc-number">1.1.</span> <span class="toc-text">配置项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#虚拟主机配置"><span class="toc-number">1.2.</span> <span class="toc-text">虚拟主机配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基于域名的虚拟主机"><span class="toc-number">1.2.1.</span> <span class="toc-text">基于域名的虚拟主机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基于端口的虚拟主机配置"><span class="toc-number">1.2.2.</span> <span class="toc-text">基于端口的虚拟主机配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#日志管理"><span class="toc-number">2.</span> <span class="toc-text">日志管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#main格式是什么"><span class="toc-number">2.1.</span> <span class="toc-text">main格式是什么?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义自己的日志格式"><span class="toc-number">2.2.</span> <span class="toc-text">自定义自己的日志格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#日志切割"><span class="toc-number">2.3.</span> <span class="toc-text">日志切割</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#具体操作"><span class="toc-number">2.3.1.</span> <span class="toc-text">具体操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#bash脚本"><span class="toc-number">2.3.1.1.</span> <span class="toc-text">bash脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#定时任务"><span class="toc-number">2.3.1.2.</span> <span class="toc-text">定时任务</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx与gzip设置"><span class="toc-number">3.</span> <span class="toc-text">Nginx与gzip设置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#location-语法"><span class="toc-number">3.1.</span> <span class="toc-text">location 语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#匹配准则总结"><span class="toc-number">3.2.</span> <span class="toc-text">匹配准则总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rewrite重写"><span class="toc-number">3.3.</span> <span class="toc-text">rewrite重写</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gzip压缩提升网站速度"><span class="toc-number">3.4.</span> <span class="toc-text">gzip压缩提升网站速度</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#gzip配置的常用参数"><span class="toc-number">3.4.1.</span> <span class="toc-text">gzip配置的常用参数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx与浏览器缓存配置"><span class="toc-number">4.</span> <span class="toc-text">Nginx与浏览器缓存配置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx反向代理和负载均衡"><span class="toc-number">5.</span> <span class="toc-text">Nginx反向代理和负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#反向代理"><span class="toc-number">5.1.</span> <span class="toc-text">反向代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#负载均衡"><span class="toc-number">5.2.</span> <span class="toc-text">负载均衡</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#nginx-与memcached的组合"><span class="toc-number">6.</span> <span class="toc-text">nginx 与memcached的组合</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx第三方模块"><span class="toc-number">6.1.</span> <span class="toc-text">Nginx第三方模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#下载扩展"><span class="toc-number">6.1.1.</span> <span class="toc-text">下载扩展</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编译第三方模块"><span class="toc-number">6.1.2.</span> <span class="toc-text">编译第三方模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx上配置memcached集群"><span class="toc-number">6.1.3.</span> <span class="toc-text">nginx上配置memcached集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#writemmen-php"><span class="toc-number">6.1.4.</span> <span class="toc-text">writemmen.php</span></a></li></ol></li></ol></li></ol></div></div><div class="post-content"><p>应用篇主要学习以下几项：</p>
<ul>
<li>Nginx虚拟主机配置</li>
<li>Nginx日志切割</li>
<li>Nginx与gzip设置</li>
<li>Nginx与浏览器缓存配置</li>
<li>Nginx反向代理</li>
<li>nginx 与memcached的组合</li>
</ul>
<a id="more"></a>
<h1 id="Nginx虚拟主机配置"><a href="#Nginx虚拟主机配置" class="headerlink" title="Nginx虚拟主机配置"></a>Nginx虚拟主机配置</h1><h2 id="配置项"><a href="#配置项" class="headerlink" title="配置项"></a>配置项</h2><p>nginx.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// 全局区</span><br><span class="line">worker_processes 1; // 有1个工作的子进程,可以自行修改,但太大无益,因为要争夺CPU,一般设置为 CPU数*核数</span><br><span class="line"></span><br><span class="line">Event &#123;</span><br><span class="line">// 一般是配置nginx连接的特性</span><br><span class="line">// 如1个word能同时允许多少连接</span><br><span class="line"> worker_connections  1024; // 这是指 一个子进程最大允许连1024个连接</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;  //这是配置http服务器的主要段</span><br><span class="line">     Server &#123; // 这是虚拟主机段</span><br><span class="line">       </span><br><span class="line">            Location &#123;  //定位,把特殊的路径或文件再次定位 ,如image目录单独处理</span><br><span class="line">            &#125;             /// 如.php单独处理</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     Server &#123;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="虚拟主机配置"><a href="#虚拟主机配置" class="headerlink" title="虚拟主机配置"></a>虚拟主机配置</h2><h3 id="基于域名的虚拟主机"><a href="#基于域名的虚拟主机" class="headerlink" title="基于域名的虚拟主机"></a>基于域名的虚拟主机</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;  <span class="comment">#监听端口</span></span><br><span class="line">    server_name a.com; <span class="comment">#监听域名</span></span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">            root /var/www/a.com;   <span class="comment">#根目录定位</span></span><br><span class="line">            index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="基于端口的虚拟主机配置"><a href="#基于端口的虚拟主机配置" class="headerlink" title="基于端口的虚拟主机配置"></a>基于端口的虚拟主机配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 8080;</span><br><span class="line">    server_name 192.168.1.204;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">            root /var/www/html8080;</span><br><span class="line">            index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="日志管理"><a href="#日志管理" class="headerlink" title="日志管理"></a>日志管理</h1><p>在nginx的server段,我们可以看到日志的存储路径</p>
<p> #access_log  logs/host.access.log  main;<br>这说明 该server, 它的访问日志的文件是  logs/host.access.log ,</p>
<p>使用的格式”main”格式.</p>
<p>除了main格式,你可以自定义其他格式.</p>
<h2 id="main格式是什么"><a href="#main格式是什么" class="headerlink" title="main格式是什么?"></a>main格式是什么?</h2><p>在http段中，我们可以看到：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line"><span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line"><span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br></pre></td></tr></table></figure>
<p>main格式是我们定义好一种日志的格式,并起个名字,便于引用.</p>
<p>默认的日志格式: main<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line"><span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line"><span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br></pre></td></tr></table></figure></p>
<p>如默认的main日志格式,记录这么几项<br>远程IP- 远程用户/用户时间 请求方法(如GET/POST) 请求体body长度 referer来源信息<br>http-user-agent用户代理/蜘蛛 ,被转发的请求的原始IP</p>
<p>http_x_forwarded_for:在经过代理时,代理把你的本来IP加在此头信息中,传输你的原始IP</p>
<h2 id="自定义自己的日志格式"><a href="#自定义自己的日志格式" class="headerlink" title="自定义自己的日志格式"></a>自定义自己的日志格式</h2><p>2: 声明一个独特的log_format并命名</p>
<pre><code>log_format  mylog &apos;$remote_addr- &quot;$request&quot; &apos;
                 &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;
                    &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;
</code></pre><p>在下面的server/location,我们就可以引用 mylog</p>
<p>在server段中,这样来声明</p>
<p>Nginx允许针对不同的server做不同的Log ,(有的web服务器不支持,如lighttp)</p>
<p>access_log logs/access_8080.log mylog;<br>声明log   log位置          log格式;</p>
<h2 id="日志切割"><a href="#日志切割" class="headerlink" title="日志切割"></a>日志切割</h2><p>问题：假如每天的访问量很大，日志文件会越来越大，造成后期不好管理以及处理，我们就需要对日志进行切割</p>
<p>解决方案：</p>
<p>shell+定时任务+nginx信号管理，完成日志按日期存储</p>
<p>分析思路：</p>
<ul>
<li>凌晨 00:00:01 把昨天的日志重名，放在相应的目录下</li>
<li>再用信号USR1控制Nginx重新生成新的日志文件</li>
</ul>
<h3 id="具体操作"><a href="#具体操作" class="headerlink" title="具体操作"></a>具体操作</h3><h4 id="bash脚本"><a href="#bash脚本" class="headerlink" title="bash脚本"></a>bash脚本</h4><p>log.sh<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">base_path=<span class="string">'/usr/local/nginx/logs'</span></span><br><span class="line">log_path=$(date -d yesterday +<span class="string">"%Y%m"</span>)</span><br><span class="line">day=$(date -d yesterday +<span class="string">"%d"</span>)</span><br><span class="line">mkdir -p <span class="variable">$base_path</span>/<span class="variable">$log_path</span></span><br><span class="line">mv <span class="variable">$base_path</span>/access.log <span class="variable">$base_path</span>/<span class="variable">$log_path</span>/access_<span class="variable">$day</span>.<span class="built_in">log</span></span><br><span class="line"><span class="built_in">kill</span> -USR1 `cat /usr/<span class="built_in">local</span>/nginx/logs/nginx.pid`</span><br></pre></td></tr></table></figure></p>
<h4 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h4><p>Crontab 编辑定时任务<br>01 00 <em> </em> * /xxx/path/log.sh  每天0时1分(建议在02-04点之间,系统负载小)</p>
<h1 id="Nginx与gzip设置"><a href="#Nginx与gzip设置" class="headerlink" title="Nginx与gzip设置"></a>Nginx与gzip设置</h1><h2 id="location-语法"><a href="#location-语法" class="headerlink" title="location 语法"></a>location 语法</h2><p>location匹配可分为三种：</p>
<ul>
<li><p>location = patt {} [精准匹配]</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location = / &#123;</span><br><span class="line">              root   /var/www/html/;</span><br><span class="line">             index  index.htm index.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>location patt{}  [一般匹配]</p>
</li>
</ul>
<ul>
<li>location ~ patt{} [正则匹配]<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    location ~ image &#123;</span><br><span class="line">           root /var/www/; //注意此处不用再写img目录</span><br><span class="line">           index index.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="匹配准则总结"><a href="#匹配准则总结" class="headerlink" title="匹配准则总结"></a>匹配准则总结</h2><p><img src="location.png" alt=""></p>
<h2 id="rewrite重写"><a href="#rewrite重写" class="headerlink" title="rewrite重写"></a>rewrite重写</h2><p>重写中用到的指令</p>
<ul>
<li>if  (条件) {}  设定条件,再进行重写 </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">If 空格 (条件) &#123;</span><br><span class="line">    重写模式</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>条件又怎么写?<br>答:3种写法<br>1: “=”来判断相等, 用于字符串比较<br>2: “~” 用正则来匹配(此处的正则区分大小写)<br>   ~* 不区分大小写的正则<br>3: -f -d -e来判断是否为文件,为目录,是否存在.</p>
<p>例子：</p>
<ul>
<li>禁用IP</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>  (<span class="variable">$remote_addr</span> = 192.168.1.100) &#123;</span><br><span class="line">                <span class="built_in">return</span> 403;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ie浏览器重写</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ MSIE) &#123;</span><br><span class="line">               rewrite ^.*$ /ie.htm;</span><br><span class="line">               <span class="built_in">break</span>; <span class="comment">#(不break会循环重定向)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>自定义404页面</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!-e <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>) &#123;</span><br><span class="line">              rewrite ^.*$ /404.html <span class="built_in">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>set #设置变量</li>
</ul>
<p>例子如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~* msie) &#123;</span><br><span class="line">      <span class="built_in">set</span> <span class="variable">$isie</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$fastcgi_script_name</span> = ie.html) &#123;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$isie</span> 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$isie</span> 1) &#123;</span><br><span class="line">    rewrite ^.*$ ie.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>return #返回状态码 </li>
</ul>
<ul>
<li>break #跳出rewrite</li>
<li>rewrite #重写</li>
</ul>
<p>可参考如下例子对ecshop网址的重写：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Rewrite语法</span><br><span class="line">Rewrite 正则表达式  定向后的位置 模式</span><br><span class="line"></span><br><span class="line">Goods-3.html ----&gt;Goods.php?goods_id=3</span><br><span class="line">goods-([\d]+)\.html ---&gt; goods.php?goods_id =<span class="variable">$1</span>  </span><br><span class="line"></span><br><span class="line">location /ecshop &#123;</span><br><span class="line">index index.php;</span><br><span class="line">rewrite goods-([\d]+)\.html$ /ecshop/goods.php?id=<span class="variable">$1</span>;</span><br><span class="line">rewrite article-([\d]+)\.html$ /ecshop/article.php?id=<span class="variable">$1</span>;</span><br><span class="line">rewrite category-(\d+)-b(\d+)\.html /ecshop/category.php?id=<span class="variable">$1</span>&amp;brand=<span class="variable">$2</span>;</span><br><span class="line"></span><br><span class="line">rewrite category-(\d+)-b(\d+)-min(\d+)-max(\d+)-attr([\d\.]+)\.html /ecshop/category.php?id=<span class="variable">$1</span>&amp;brand=<span class="variable">$2</span>&amp;price_min=<span class="variable">$3</span>&amp;price_max=<span class="variable">$4</span>&amp;filter_attr=<span class="variable">$5</span>;</span><br><span class="line"></span><br><span class="line">rewrite category-(\d+)-b(\d+)-min(\d+)-max(\d+)-attr([\d+\.])-(\d+)-([^-]+)-([^-]+)\.html /ecshop/category.php?id=<span class="variable">$1</span>&amp;brand=<span class="variable">$2</span>&amp;price_min=<span class="variable">$3</span>&amp;price_max=<span class="variable">$4</span>&amp;filter_attr=<span class="variable">$5</span>&amp;page=<span class="variable">$6</span>&amp;sort=<span class="variable">$7</span>&amp;order=<span class="variable">$8</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="gzip压缩提升网站速度"><a href="#gzip压缩提升网站速度" class="headerlink" title="gzip压缩提升网站速度"></a>gzip压缩提升网站速度</h2><p>在浏览器访问网站，打开f12的时候，经常能看到：</p>
<p>请求:<br>Accept-Encoding:gzip,deflate,sdch<br>响应:<br>Content-Encoding:gzip<br>Content-Length:36093<br>再把页面另存下来,观察,约10W字节,实际传输的36093字节<br>原因——-就在于gzip压缩上.</p>
<p>原理:<br>浏览器—请求—-&gt; 声明可以接受 gzip压缩 或 deflate压缩 或compress 或 sdch压缩<br>从http协议的角度看–请求头 声明 acceopt-encoding: gzip deflate sdch  (是指压缩算法,其中sdch是google倡导的一种压缩方式,目前支持的服务器尚不多)<br>服务器–&gt;回应—把内容用gzip方式压缩—-&gt;发给浏览器<br>浏览&lt;—–解码gzip—–接收gzip压缩内容—-</p>
<h3 id="gzip配置的常用参数"><a href="#gzip配置的常用参数" class="headerlink" title="gzip配置的常用参数"></a>gzip配置的常用参数</h3><p>gzip可以写在http,server,location上下文</p>
<ul>
<li>gzip on|off;  #是否开启gzip</li>
<li>gzip_buffers 32 4K| 16 8K #缓冲(压缩在内存中缓冲几块? 每块多大?)</li>
<li>gzip_comp_level [1-9] #推荐6 压缩级别(级别越高,压的越小,越浪费CPU计算资源)</li>
<li>gzip_disable #正则匹配UA 什么样的Uri不进行gzip</li>
<li>gzip_min_length 200 # 开始压缩的最小长度(再小就不要压缩了,意义不在)</li>
<li>gzip_http_version 1.0|1.1 # 开始压缩的http协议版本(可以不设置,目前几乎全是1.1协议)</li>
<li>gzip_proxied          # 设置请求者代理服务器,该如何缓存内容</li>
<li>gzip_types text/plain  application/xml # 对哪些类型的文件用压缩 如txt,xml,html ,css</li>
<li>gzip_vary on|off  # 是否传输gzip压缩标志</li>
</ul>
<p>注意:<br>图片/mp3这样的二进制文件,不必压缩<br>因为压缩率比较小, 比如100-&gt;80字节,而且压缩也是耗费CPU资源的.<br>比较小的文件不必压缩</p>
<h1 id="Nginx与浏览器缓存配置"><a href="#Nginx与浏览器缓存配置" class="headerlink" title="Nginx与浏览器缓存配置"></a>Nginx与浏览器缓存配置</h1><p>nginx的缓存设置有助于提高网站性能<br>对于网站的图片,尤其是新闻站, 图片一旦发布, 改动的可能是非常小的.我们希望 能否在用户访问一次后, 图片缓存在用户的浏览器端,且时间比较长的缓存.<br>可以, 用到 nginx的expires设置。</p>
<p>nginx中设置过期时间,非常简单,<br>在location或if段里,来写.<br>格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">expires 30s;</span><br><span class="line">expires 30m;</span><br><span class="line">expires 2h;</span><br><span class="line">expires 30d;</span><br></pre></td></tr></table></figure>
<p>(注意:服务器的日期要准确,如果服务器的日期落后于实际日期,可能导致缓存失效)</p>
<p>原理是: 服务器响应文件内容是,同时响应etag标签(内容的签名,内容一变,他也变), 和 last_modified_since 2个标签值<br>浏览器下次去请求时,头信息发送这两个标签, 服务器检测文件有没有发生变化,如无,直接头信息返回 etag,last_modified_since<br>浏览器知道内容无改变,于是直接调用本地缓存.<br>这个过程,也请求了服务器,但是传着的内容极少.<br>对于变化周期较短的,如静态html,js,css,比较适于用这个方式</p>
<h1 id="Nginx反向代理和负载均衡"><a href="#Nginx反向代理和负载均衡" class="headerlink" title="Nginx反向代理和负载均衡"></a>Nginx反向代理和负载均衡</h1><p>之所以两个合在一起的原因是负载均衡通过反向代理来实现的</p>
<h2 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h2><p>使用proxy_pass ,就这么简单<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    </span><br><span class="line">location / &#123;</span><br><span class="line">      proxy_pass        http://www.baidu.com;</span><br><span class="line">      proxy_set_header   X-Forwarded-For  <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><p>网站的访问量越来越大，服务器的服务模式也得进行相应的升级，比如分离出数据库服务器、分离出图片作为单独服务，这些是简单的数据的负载均衡，将压力分散到不同的机器上。有时候来自web前端的压力，也能让人十分头痛。怎样将同一个域名的访问分散到两台或更多的机器上呢？这其实就是另一种负载均衡了，nginx自身就可以做到，只需要做个简单的配置就行。<br>nginx不单可以作为强大的web服务器，也可以作为一个反向代理服务器，而且nginx还可以按照调度规则实现动态、静态页面的分离，可以按照轮询、ip哈希、URL哈希、权重等多种方式对后端服务器做负载均衡，同时还支持后端服务器的健康检查。<br>Nginx负载均衡一些基础知识：</p>
<p>负载均衡也是很简单，就是upstream和upstream的配置，如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#在server上添加此upstream节点</span></span><br><span class="line">upstream mytomcat&#123;</span><br><span class="line">    <span class="comment">#分权 即访问131与134的次数比例为1比1</span></span><br><span class="line">        server 192.168.14.131:8080 weight=1;</span><br><span class="line">        server 192.168.14.134:8080 weight=1;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    <span class="comment">#即所有请求都到这里去找分配</span></span><br><span class="line">    location / &#123;</span><br><span class="line">   <span class="comment">#使用mytomcat分配规则，即刚自定义添加的upstream节点</span></span><br><span class="line">       proxy_pass http://mytomcat;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="nginx-与memcached的组合"><a href="#nginx-与memcached的组合" class="headerlink" title="nginx 与memcached的组合"></a>nginx 与memcached的组合</h1><p>用法: nginx响应请求时,直接请求memcached,如果没有相应的内容,再回调PHP页面,去查询database,并写入memcached<br>用这个方法我们可以做页面的缓存</p>
<p>分析：<br>一般用 uri arg 做key,  如 /news.php?id=3</p>
<p>Nginx很容易支持配置memcache,如下所示：</p>
<h2 id="Nginx第三方模块"><a href="#Nginx第三方模块" class="headerlink" title="Nginx第三方模块"></a>Nginx第三方模块</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">  root html;</span><br><span class="line">  <span class="built_in">set</span> <span class="variable">$memcached_key</span> <span class="variable">$uri</span>;   //设置要查询的key值</span><br><span class="line">  memcached_pass memserver;  // memserver为上面的memcache节点的名称</span><br><span class="line">  error_page 404 /writemem.php; //查询不到时候要调用的脚本</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是我们要memcache集群，在nginx中做集群与负载均衡,步骤都是一样的，Upstream {}模块 把多台服务器加入到一个组，<br>nginx做集群，使用一致性哈希算法，需要安装第三方模块，具体步骤如下：</p>
<h3 id="下载扩展"><a href="#下载扩展" class="headerlink" title="下载扩展"></a>下载扩展</h3><p>上官网下载ngx——http_consistent_hash</p>
<h3 id="编译第三方模块"><a href="#编译第三方模块" class="headerlink" title="编译第三方模块"></a>编译第三方模块</h3><p>在nginx源码目录下，注意是nginx的源码<br>如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/nginx --add_module=/path/ngx_module/下载的第三方目录</span><br><span class="line">Make &amp;&amp; make instal</span><br></pre></td></tr></table></figure></p>
<h3 id="nginx上配置memcached集群"><a href="#nginx上配置memcached集群" class="headerlink" title="nginx上配置memcached集群"></a>nginx上配置memcached集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">upstream memserver &#123;  </span><br><span class="line">    consistent_hash <span class="variable">$request_uri</span>; // <span class="built_in">hash</span>计算时的依据,以uri做依据来<span class="built_in">hash</span></span><br><span class="line">    server 127.0.0.1:11211;</span><br><span class="line">    server 127.0.0.1:11212;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">location / &#123;</span><br><span class="line">   <span class="comment"># root   html;</span></span><br><span class="line">   <span class="built_in">set</span> <span class="variable">$memcached_key</span> <span class="variable">$uri</span>;</span><br><span class="line">   memcached_pass memserver;  // memserver为上面的memcache节点的名称</span><br><span class="line">   error_page 404 /writemem.php;</span><br><span class="line">   index  index.php index.html index.htm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="writemmen-php"><a href="#writemmen-php" class="headerlink" title="writemmen.php"></a>writemmen.php</h3><p>这个文件的逻辑是访问的页面没有缓存的时候，需要查询数据库插入到memcache中<br>memcached同样也需要使用一致性哈希算法做集群。</p>
<p>php使用一致性哈希算法很简单，直接修改php.ini<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">memcache.<span class="attribute">hash_strategy</span>=consistent</span><br></pre></td></tr></table></figure></p>
<p>然后就可以美滋滋的使用Nginx和memcache的勾结了。</p>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2018/09/09/Linux学习之bash-shell/">Linux学习之bash_shell</a><a class="next" href="/2018/09/08/Nginx基础篇/">Nginx基础篇</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://blog.xhzyxed.cn"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/http/">http</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/memcached/">memcached</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vuejs/">vuejs</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web安全/">web安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端构建工具/">前端构建工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/推文/">推文</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/项目/">项目</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/09/24/mysql优化之btree索引/">mysql优化之btree索引</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/24/mysql优化之类型的选择/">mysql优化之类型的选择</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/24/mysql优化之mysql进程状态/">mysql优化之mysql进程状态</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/24/mysql优化之mysql-status的周期变化/">mysql优化之mysql status的周期变化</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/23/编译安装mysql/">编译安装mysql以及安装sysbench</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/17/resume/">resume</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/14/php核心学习-设计模式的学习-简单工厂模式以及改进的工厂模式/">php核心学习-设计模式的学习-简单工厂模式以及改进的工厂模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/14/php核心学习-设计模式的学习-单例模式/">php核心学习-设计模式的学习-单例模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/13/Linux学习之进程管理/">Linux学习之进程管理</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/13/Linux学习之服务与进程管理/">Linux学习之服务与进程管理</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://org.xhzyxed.cn/" title="小猴子与小耳朵" target="_blank">小猴子与小耳朵</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">其斤.匕禾页.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>