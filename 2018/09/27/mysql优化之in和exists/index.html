<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="努力，奋斗！"><title>mysql优化之in,exists,count,group by和union | 其斤.匕禾页</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">mysql优化之in,exists,count,group by和union</h1><a id="logo" href="/.">其斤.匕禾页</a><p class="description">永远相信美好的事情即将发生</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="https://blog.xhzyxed.cn/2018/09/22/408基础/"><i class="fa fa-archive"> 计算机基础</i></a><a href="https://blog.xhzyxed.cn/2018/09/17/resume/"><i class="fa fa-user"> resume</i></a><a href="https://www.xhzyxed.cn/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">mysql优化之in,exists,count,group by和union</h1><div class="post-meta">Sep 27, 2018<span> | </span><span class="category"><a href="/categories/mysql/">mysql</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#in"><span class="toc-number">1.</span> <span class="toc-text">in</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#exists"><span class="toc-number">2.</span> <span class="toc-text">exists</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#from-型子查询"><span class="toc-number">3.</span> <span class="toc-text">from 型子查询:</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#count-优化"><span class="toc-number">4.</span> <span class="toc-text">count() 优化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#group-by"><span class="toc-number">5.</span> <span class="toc-text">group by</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#union优化"><span class="toc-number">6.</span> <span class="toc-text">union优化</span></a></li></ol></div></div><div class="post-content"><p>慎用in和exists</p>
<a id="more"></a>
<h1 id="in"><a href="#in" class="headerlink" title="in"></a>in</h1><p>in 型子查询引出的陷阱</p>
<p>题: 在ecshop商城表中,查询6号栏目的商品, (注,6号是一个大栏目)<br>最直观的:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select goods_id,cat_id,goods_name from  goods <span class="built_in">where</span> cat_id <span class="keyword">in</span> (select</span><br><span class="line">cat_id from ecs_category <span class="built_in">where</span> parent_id=6);</span><br></pre></td></tr></table></figure></p>
<p>误区: 给我们的感觉是, 先查到内层的6号栏目的子栏目,如7,8,9,11<br>然后外层, cat_id in (7,8,9,11)</p>
<p>事实: 如下图, goods表全扫描, 并逐行与category表对照,看parent_id=6是否成立<br><img src="in.jpg" alt=""></p>
<p>原因: mysql的查询优化器,针对In型做优化,被改成了exists的执行效果.<br>当goods表越大时, 查询速度越慢.</p>
<p>改进: 用连接查询来代替子查询</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">explain select goods_id,g.cat_id,g.goods_name from  goods as g</span><br><span class="line"> inner join (select cat_id from ecs_category <span class="built_in">where</span> parent_id=6) as t</span><br><span class="line"> using(cat_id) \G</span><br><span class="line"></span><br><span class="line">内层 select cat_id from ecs_category <span class="built_in">where</span> parent_id=6 ; 用到Parent_id索引, 返回4行</span><br><span class="line">+--------+</span><br><span class="line">| cat_id |</span><br><span class="line">+--------+</span><br><span class="line">|      7 |</span><br><span class="line">|      8 |</span><br><span class="line">|      9 |</span><br><span class="line">|     11 |</span><br><span class="line">+--------+    形成结果,设为t	</span><br><span class="line">*************************** 3. row ***************************</span><br><span class="line">           id: 2</span><br><span class="line">  select_type: DERIVED</span><br><span class="line">        table: ecs_category</span><br><span class="line">         <span class="built_in">type</span>: ref</span><br><span class="line">possible_keys: parent_id</span><br><span class="line">          key: parent_id</span><br><span class="line">      key_len: 2</span><br><span class="line">          ref:</span><br><span class="line">         rows: 4</span><br><span class="line">        Extra:</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">第2次查询, </span><br><span class="line">t和 goods 通过 cat_id 相连, </span><br><span class="line">因为cat_id在 goods表中有索引, 所以相当于用7,8,911,快速匹配上 goods的行.</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: PRIMARY</span><br><span class="line">        table: g</span><br><span class="line">         <span class="built_in">type</span>: ref</span><br><span class="line">possible_keys: cat_id</span><br><span class="line">          key: cat_id</span><br><span class="line">      key_len: 2</span><br><span class="line">          ref: t.cat_id</span><br><span class="line">         rows: 6</span><br><span class="line">        Extra:</span><br><span class="line"></span><br><span class="line">第1次查询 :</span><br><span class="line">是把上面2次的中间结果,直接取回.</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: PRIMARY</span><br><span class="line">        table: &lt;derived2&gt;</span><br><span class="line">         <span class="built_in">type</span>: ALL</span><br><span class="line">possible_keys: NULL</span><br><span class="line">          key: NULL</span><br><span class="line">      key_len: NULL</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 4</span><br><span class="line">        Extra:</span><br></pre></td></tr></table></figure>
<h1 id="exists"><a href="#exists" class="headerlink" title="exists"></a>exists</h1><p>exists子查询<br>题: 查询有商品的栏目.<br>按上面的理解,我们用join来操作,如下:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select c.cat_id,cat_name from ecs_category as c inner join goods as g</span><br><span class="line">on c.cat_id=g.cat_id group by cat_name; 见下面query36</span><br></pre></td></tr></table></figure></p>
<p>优化1:  在group时, 用带有索引的列来group, 速度会稍快一些,另外,<br>用int型 比 char型 分组,也要快一些. 见下面query37</p>
<p>优化2: 在group时, 我们假设只取了A表的内容,group by 的列,尽量用A表的列,<br>会比B表的列要快. 见下面query38</p>
<p>优化3: 从语义上去优化<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select cat_id,cat_name from ecs_category </span><br><span class="line"><span class="built_in">where</span> exists(select *from  goods <span class="built_in">where</span>  goods.cat_id=ecs_category.cat_id) 见下面query40</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">|       36 | 0.00039075 | select c.cat_id,cat_name from ecs_category as c inner</span><br><span class="line">join  goods as g on c.cat_id=g.cat_id group by cat_name</span><br><span class="line">              |</span><br><span class="line">|       37 | 0.00038675 | select c.cat_id,cat_name from ecs_category as c inner</span><br><span class="line">join  goods as g on c.cat_id=g.cat_id group by cat_id</span><br><span class="line">              |</span><br><span class="line">|       38 | 0.00035650 | select c.cat_id,cat_name from ecs_category as c inner</span><br><span class="line">join  goods as g on c.cat_id=g.cat_id group by c.cat_id</span><br><span class="line">              |</span><br><span class="line">|       40 | 0.00033500 | select cat_id,cat_name from ecs_category <span class="built_in">where</span> exists</span><br><span class="line">(select * from  goods <span class="built_in">where</span>  goods.cat_id=ecs_category.cat_id)</span><br></pre></td></tr></table></figure>
<h1 id="from-型子查询"><a href="#from-型子查询" class="headerlink" title="from 型子查询:"></a>from 型子查询:</h1><p>注意::内层from语句查到的临时表, 是没有索引的.<br>所以: from的返回内容要尽量少.</p>
<h1 id="count-优化"><a href="#count-优化" class="headerlink" title="count() 优化"></a>count() 优化</h1><p>误区:<br>1:myisam的count()非常快<br>答: 是比较快,.但仅限于查询表的”所有行”比较快, 因为Myisam对行数进行了存储.<br>一旦有条件的查询, 速度就不再快了.尤其是where条件的列上没有索引.</p>
<p>2: 假如,id&lt;100的商家都是我们内部测试的,我们想查查真实的商家有多少?<br>select count(<em>) from lx_com where id&gt;=100;  (1000多万行用了6.X秒)<br>小技巧:<br>select count(</em>) from lx_com; 快<br>select count(<em>) from lx_com where id&lt;100; 快<br>select count(</em>) frol lx_com -select count(<em>) from lx_com where id&lt;100; 快<br>select (select count(</em>) from lx_com) - (select count(*) from lx_com where id&lt;100)</p>
<h1 id="group-by"><a href="#group-by" class="headerlink" title="group by"></a>group by</h1><p>注意:<br>1:分组用于统计,而不用于筛选数据.<br>比如: 统计平均分,最高分,适合, 但用于筛选重复数据,则不适合.<br>以及用索引来避免临时表和文件排序</p>
<p>2:  以A,B表连接为例 ,主要查询A表的列,<br>那么 group by ,order by 的列尽量相同,而且列应该显示声明为A的列</p>
<h1 id="union优化"><a href="#union优化" class="headerlink" title="union优化"></a>union优化</h1><p>注意: union all 不过滤 效率提高,如非必须,请用union all<br>因为 union去重的代价非常高, 因此只能放在程序里去重.</p>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2018/09/28/使用docker部署快速部署wordpress/">使用docker部署快速部署wordpress</a><a class="next" href="/2018/09/26/mysql优化之学习explain分析sql语句/">mysql优化之学习explain分析sql语句</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://blog.xhzyxed.cn"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/408/">408</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/http/">http</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/memcached/">memcached</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vuejs/">vuejs</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web安全/">web安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端构建工具/">前端构建工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/推文/">推文</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/项目/">项目</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/09/29/mysql优化之sql语句优化脑图/">mysql优化之sql语句优化脑图</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/29/mysql事务/">mysql事务</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/29/mysql表分区/">mysql表分区</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/29/mysql主从读写分离/">mysql主从读写分离</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/29/mysql主主复制/">mysql主主复制</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/28/mysql主从复制/">mysql主从复制</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/28/使用docker部署快速部署wordpress/">使用docker部署快速部署wordpress</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/27/mysql优化之in和exists/">mysql优化之in,exists,count,group by和union</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/26/mysql优化之学习explain分析sql语句/">mysql优化之学习explain分析sql语句</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/26/mysql优化之索引学习脑图/">mysql优化之索引学习脑图</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://org.xhzyxed.cn/" title="小猴子与小耳朵" target="_blank">小猴子与小耳朵</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">其斤.匕禾页.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>