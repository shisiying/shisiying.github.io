<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="努力，奋斗！"><title>laravel学习之中间件 | 其斤.匕禾页</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">laravel学习之中间件</h1><a id="logo" href="/.">其斤.匕禾页</a><p class="description">站在巨人的肩膀上，做只勤奋的小蜜蜂！</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/2018/10/02/lnmp技术栈文章汇总/"><i class="fa fa-archive"> LNMP技术栈</i></a><a href="/2018/10/02/速读laravel源码/"><i class="fa fa-archive"> laravel框架学习</i></a><a href="https://zhimap.com/mmap/773f7025d57f4c24b3c680bd9972c7e8"><i class="fa fa-archive"> 秒杀系统学习</i></a><a href="/2018/11/01/nosql学习汇总/"><i class="fa fa-archive"> nosql</i></a><a href="/2018/09/22/408基础/"><i class="fa fa-archive"> 计算机基础</i></a><a href="/2018/09/17/resume/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">laravel学习之中间件</h1><div class="post-meta">Oct 14, 2018<span> | </span><span class="category"><a href="/categories/php/">php</a></span></div><a class="ds-thread-count" href="/2018/10/14/laravel学习之中间件/#SOHUCS"><span id="changyan_count_unit" style="font-size: 15px; color: #6E7173;">0</span><span> 条评论</span></a><script src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js" async></script><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#中间件"><span class="toc-number">1.</span> <span class="toc-text">中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#中间件的好处"><span class="toc-number">1.1.</span> <span class="toc-text">中间件的好处</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#中间件的实现"><span class="toc-number">1.2.</span> <span class="toc-text">中间件的实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#中间件的源码"><span class="toc-number">1.3.</span> <span class="toc-text">中间件的源码</span></a></li></ol></li></ol></div></div><div class="post-content"><p>重要的中间件了解一下<br><a id="more"></a></p>
<h1 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h1><h2 id="中间件的好处"><a href="#中间件的好处" class="headerlink" title="中间件的好处"></a>中间件的好处</h2><p>中间件(Middleware)在Laravel中起着过滤进入应用的HTTP请求对象(Request)和完善离开应用的HTTP响应对象(Reponse)的作用, 而且可以通过应用多个中间件来层层过滤请求、逐步完善相应。这样就做到了程序的解耦，如果没有中间件那么我们必须在控制器中来完成这些步骤，这无疑会造成控制器的臃肿。</p>
<p>举一个简单的例子，在一个电商平台上用户既可以是一个普通用户在平台上购物也可以在开店后是一个卖家用户，这两种用户的用户体系往往都是一套，那么在只有卖家用户才能访问的控制器里我们只需要应用两个中间件来完成卖家用户的身份认证：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MerchantController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	public function __construct()</span><br><span class="line">	&#123;</span><br><span class="line">		$<span class="keyword">this</span>-&gt;middleware(<span class="symbol">'aut</span>h');</span><br><span class="line">		$<span class="keyword">this</span>-&gt;middleware(<span class="symbol">'mechatnt_aut</span>h');</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在auth中间件里做了通用的用户认证，成功后HTTP Request会走到merchant_auth中间件里进行商家用户信息的认证，两个中间件都通过后HTTP Request就能进入到要去的控制器方法中了。利用中间件，我们就能把这些认证代码抽离到对应的中间件中了，而且可以根据需求自由组合多个中间件来对HTTP Request进行过滤。</p>
<p>再比如Laravel自动给所有路由应用的<code>VerifyCsrfToken</code>中间件，在HTTP Requst进入应用走过<code>VerifyCsrfToken</code>中间件时会验证Token防止跨站请求伪造，在Http Response 离开应用前会给响应添加合适的Cookie。（laravel5.5开始CSRF中间件只自动应用到web路由上）</p>
<p>上面概述了下中间件在laravel中的角色，以及什么类型的代码应该从控制器挪到中间件里，至于如何定义和使用自己的laravel 中间件请参考<a href="https://d.laravel-china.org/docs/5.5/middleware" target="_blank" rel="noopener">官方文档</a>。</p>
<h2 id="中间件的实现"><a href="#中间件的实现" class="headerlink" title="中间件的实现"></a>中间件的实现</h2><p>下面我们主要来看一下Laravel中是怎么实现中间件的，中间件的设计应用了一种叫做装饰器的设计模式，在之前的基础篇中已经简单的介绍这种设计模式，具体可看之前推荐的文章<a href="https://www.cnblogs.com/firstForEver/p/8001711.html" target="_blank" rel="noopener">装饰器模式</a></p>
<h2 id="中间件的源码"><a href="#中间件的源码" class="headerlink" title="中间件的源码"></a>中间件的源码</h2><p>Laravel实例化Application后，会从服务容器里解析出Http Kernel对象，通过类的名字也能看出来Http Kernel就是Laravel里负责HTTP请求和响应的核心。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@var</span> \App\Http\Kernel $kernel</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br><span class="line"></span><br><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$response-&gt;send();</span><br><span class="line"></span><br><span class="line">$kernel-&gt;terminate($request, $response);</span><br></pre></td></tr></table></figure>
<p>在<code>index.php</code>里可以看到，从服务容器里解析出Http Kernel，因为在<code>bootstrap/app.php</code>里绑定了<code>Illuminate\Contracts\Http\Kernel</code>接口的实现类<code>App\Http\Kernel</code>所以$kernel实际上是<code>App\Http\Kernel</code>类的对象。<br>解析出Http Kernel后Laravel将进入应用的请求对象传递给Http Kernel的handle方法，在handle方法负责处理流入应用的请求对象并返回响应对象。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  /**</span><br><span class="line"> * Handle an incoming HTTP request.</span><br><span class="line"> *</span><br><span class="line"> * @param  \Illuminate\Http\Request  <span class="variable">$request</span></span><br><span class="line"> * @<span class="built_in">return</span> \Illuminate\Http\Response</span><br><span class="line"> */</span><br><span class="line">public <span class="keyword">function</span> handle(<span class="variable">$request</span>)</span><br><span class="line">&#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        <span class="variable">$request</span>-&gt;enableHttpMethodParameterOverride();</span><br><span class="line"></span><br><span class="line">        <span class="variable">$response</span> = <span class="variable">$this</span>-&gt;sendRequestThroughRouter(<span class="variable">$request</span>);</span><br><span class="line">    &#125; catch (Exception <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;reportException(<span class="variable">$e</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$response</span> = <span class="variable">$this</span>-&gt;renderException(<span class="variable">$request</span>, <span class="variable">$e</span>);</span><br><span class="line">    &#125; catch (Throwable <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;reportException(<span class="variable">$e</span> = new FatalThrowableError(<span class="variable">$e</span>));</span><br><span class="line"></span><br><span class="line">        <span class="variable">$response</span> = <span class="variable">$this</span>-&gt;renderException(<span class="variable">$request</span>, <span class="variable">$e</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$this</span>-&gt;app[<span class="string">'events'</span>]-&gt;dispatch(</span><br><span class="line">        new Events\RequestHandled(<span class="variable">$request</span>, <span class="variable">$response</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$response</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>中间件过滤应用的过程就发生在<code>$this-&gt;sendRequestThroughRouter($request)</code>里：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> /**</span><br><span class="line"> * Send the given request through the middleware / router.</span><br><span class="line"> *</span><br><span class="line"> * @param  \Illuminate\Http\Request  <span class="variable">$request</span></span><br><span class="line"> * @<span class="built_in">return</span> \Illuminate\Http\Response</span><br><span class="line"> */</span><br><span class="line">protected <span class="keyword">function</span> sendRequestThroughRouter(<span class="variable">$request</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, <span class="variable">$request</span>);</span><br><span class="line"></span><br><span class="line">    Facade::clearResolvedInstance(<span class="string">'request'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$this</span>-&gt;bootstrap();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> (new Pipeline(<span class="variable">$this</span>-&gt;app))</span><br><span class="line">                -&gt;send(<span class="variable">$request</span>)</span><br><span class="line">                -&gt;through(<span class="variable">$this</span>-&gt;app-&gt;shouldSkipMiddleware() ? [] : <span class="variable">$this</span>-&gt;middleware)</span><br><span class="line">                -&gt;<span class="keyword">then</span>(<span class="variable">$this</span>-&gt;dispatchToRouter());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法的前半部分是对Application进行了初始化，在上一面讲解服务提供器的文章里有对这一部分的详细讲解。Laravel通过Pipeline（管道）对象来传输请求对象，在Pipeline中请求对象依次通过Http Kernel里定义的中间件的前置操作到达控制器的某个action或者直接闭包处理得到响应对象。</p>
<p>看下Pipeline里这几个方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> public <span class="keyword">function</span> send(<span class="variable">$passable</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;passable = <span class="variable">$passable</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">function</span> through(<span class="variable">$pipes</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;pipes = is_array(<span class="variable">$pipes</span>) ? <span class="variable">$pipes</span> : func_get_args();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">function</span> <span class="keyword">then</span>(Closure <span class="variable">$destination</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$firstSlice</span> = <span class="variable">$this</span>-&gt;getInitialSlice(<span class="variable">$destination</span>);</span><br><span class="line">    </span><br><span class="line">    //pipes 就是要通过的中间件</span><br><span class="line">    <span class="variable">$pipes</span> = array_reverse(<span class="variable">$this</span>-&gt;pipes);</span><br><span class="line"></span><br><span class="line">    //<span class="variable">$this</span>-&gt;passable就是Request对象</span><br><span class="line">    <span class="built_in">return</span> call_user_func(</span><br><span class="line">        array_reduce(<span class="variable">$pipes</span>, <span class="variable">$this</span>-&gt;getSlice(), <span class="variable">$firstSlice</span>), <span class="variable">$this</span>-&gt;passable</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">protected <span class="keyword">function</span> getInitialSlice(Closure <span class="variable">$destination</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">return</span> <span class="keyword">function</span> (<span class="variable">$passable</span>) use (<span class="variable">$destination</span>) &#123;</span><br><span class="line">        <span class="built_in">return</span> call_user_func(<span class="variable">$destination</span>, <span class="variable">$passable</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//Http Kernel的dispatchToRouter是Piple管道的终点或者叫目的地</span><br><span class="line">protected <span class="keyword">function</span> dispatchToRouter()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">return</span> <span class="keyword">function</span> (<span class="variable">$request</span>) &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, <span class="variable">$request</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$this</span>-&gt;router-&gt;dispatch(<span class="variable">$request</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的函数看起来比较晕，我们先来看下array_reduce里对它的callback函数参数的解释：</p>
<blockquote>
<p>mixed array_reduce ( array $array , callable $callback [, mixed $initial = NULL ] )</p>
</blockquote>
<blockquote>
<p>array_reduce() 将回调函数 callback 迭代地作用到 array 数组中的每一个单元中，从而将数组简化为单一的值。</p>
</blockquote>
<blockquote>
<p>callback ( mixed $carry , mixed $item )<br>carry<br>携带上次迭代里的值； 如果本次迭代是第一次，那么这个值是 initial。item 携带了本次迭代的值。</p>
</blockquote>
<p>getInitialSlice方法，他的返回值是作为传递给callbakc函数的$carry参数的初始值，这个值现在是一个闭包，我把getInitialSlice和Http Kernel的dispatchToRouter这两个方法合并一下，现在$firstSlice的值为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$destination = <span class="function"><span class="keyword">function</span> <span class="params">($request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;router-&gt;dispatch($request);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">$firstSlice = <span class="function"><span class="keyword">function</span> <span class="params">($passable)</span> <span class="title">use</span> <span class="params">($destination)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> call_user_func($destination, $passable);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>接下来我们看看array_reduce的callback:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> //Pipeline </span><br><span class="line">protected <span class="keyword">function</span> getSlice()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">return</span> <span class="keyword">function</span> (<span class="variable">$stack</span>, <span class="variable">$pipe</span>) &#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="keyword">function</span> (<span class="variable">$passable</span>) use (<span class="variable">$stack</span>, <span class="variable">$pipe</span>) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                <span class="variable">$slice</span> = parent::getSlice();</span><br><span class="line"></span><br><span class="line">                <span class="built_in">return</span> call_user_func(<span class="variable">$slice</span>(<span class="variable">$stack</span>, <span class="variable">$pipe</span>), <span class="variable">$passable</span>);</span><br><span class="line">            &#125; catch (Exception <span class="variable">$e</span>) &#123;</span><br><span class="line">                <span class="built_in">return</span> <span class="variable">$this</span>-&gt;handleException(<span class="variable">$passable</span>, <span class="variable">$e</span>);</span><br><span class="line">            &#125; catch (Throwable <span class="variable">$e</span>) &#123;</span><br><span class="line">                <span class="built_in">return</span> <span class="variable">$this</span>-&gt;handleException(<span class="variable">$passable</span>, new FatalThrowableError(<span class="variable">$e</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//Pipleline的父类BasePipeline的getSlice方法</span><br><span class="line">protected <span class="keyword">function</span> getSlice()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">return</span> <span class="keyword">function</span> (<span class="variable">$stack</span>, <span class="variable">$pipe</span>) &#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="keyword">function</span> (<span class="variable">$passable</span>) use (<span class="variable">$stack</span>, <span class="variable">$pipe</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$pipe</span> instanceof Closure) &#123;</span><br><span class="line">                <span class="built_in">return</span> call_user_func(<span class="variable">$pipe</span>, <span class="variable">$passable</span>, <span class="variable">$stack</span>);</span><br><span class="line">            &#125; elseif (! is_object(<span class="variable">$pipe</span>)) &#123;</span><br><span class="line">                //解析中间件名称和参数 (<span class="string">'throttle:60,1'</span>)</span><br><span class="line">                list(<span class="variable">$name</span>, <span class="variable">$parameters</span>) = <span class="variable">$this</span>-&gt;parsePipeString(<span class="variable">$pipe</span>);</span><br><span class="line">                <span class="variable">$pipe</span> = <span class="variable">$this</span>-&gt;container-&gt;make(<span class="variable">$name</span>);</span><br><span class="line">                <span class="variable">$parameters</span> = array_merge([<span class="variable">$passable</span>, <span class="variable">$stack</span>], <span class="variable">$parameters</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$parameters</span> = [<span class="variable">$passable</span>, <span class="variable">$stack</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            //<span class="variable">$this</span>-&gt;method = handle</span><br><span class="line">            <span class="built_in">return</span> call_user_func_array([<span class="variable">$pipe</span>, <span class="variable">$this</span>-&gt;method], <span class="variable">$parameters</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>注：在Laravel5.5版本里 getSlice这个方法的名称换成了carry, 两者在逻辑上没有区别，所以依然可以参照着5.5版本里中间件的代码来看本文。</strong></p>
<p>getSlice会返回一个闭包函数, $stack在第一次调用getSlice时它的值是$firstSlice, 之后的调用中就它的值就是这里返回的值个闭包了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="variable">$stack</span> = <span class="keyword">function</span> (<span class="variable">$passable</span>) use (<span class="variable">$stack</span>, <span class="variable">$pipe</span>) &#123;</span><br><span class="line">               try &#123;</span><br><span class="line">                   <span class="variable">$slice</span> = parent::getSlice();</span><br><span class="line"></span><br><span class="line">                   <span class="built_in">return</span> call_user_func(<span class="variable">$slice</span>(<span class="variable">$stack</span>, <span class="variable">$pipe</span>), <span class="variable">$passable</span>);</span><br><span class="line">               &#125; catch (Exception <span class="variable">$e</span>) &#123;</span><br><span class="line">                   <span class="built_in">return</span> <span class="variable">$this</span>-&gt;handleException(<span class="variable">$passable</span>, <span class="variable">$e</span>);</span><br><span class="line">               &#125; catch (Throwable <span class="variable">$e</span>) &#123;</span><br><span class="line">                   <span class="built_in">return</span> <span class="variable">$this</span>-&gt;handleException(<span class="variable">$passable</span>, new FatalThrowableError(<span class="variable">$e</span>));</span><br><span class="line">               &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<p>getSlice返回的闭包里又会去调用父类的getSlice方法，他返回的也是一个闭包，在闭包会里解析出中间件对象、中间件参数(无则为空数组), 然后把$passable(请求对象), $stack和中间件参数作为中间件handle方法的参数进行调用。</p>
<p>上面封装的有点复杂，我们简化一下，其实getSlice的返回值就是:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$stack</span> = <span class="keyword">function</span> (<span class="variable">$passable</span>) use (<span class="variable">$stack</span>, <span class="variable">$pipe</span>) &#123;</span><br><span class="line">                   //解析中间件和中间件参数，中间件参数用<span class="variable">$parameter</span>代表，无参数时为空数组</span><br><span class="line">                  <span class="variable">$parameters</span> = array_merge([<span class="variable">$passable</span>, <span class="variable">$stack</span>], <span class="variable">$parameters</span>)</span><br><span class="line">                  <span class="built_in">return</span> <span class="variable">$pipe</span>-&gt;handle(<span class="variable">$parameters</span>)</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure></p>
<p>array_reduce每次调用callback返回的闭包都会作为参数$stack传递给下一次对callback的调用，array_reduce执行完成后就会返回一个嵌套了多层闭包的闭包，每层闭包用到的外部变量$stack都是上一次之前执行reduce返回的闭包，相当于把中间件通过闭包层层包裹包成了一个洋葱。</p>
<p>在then方法里，等到array_reduce执行完返回最终结果后就会对这个洋葱闭包进行调用:<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">return</span> call_user_func( array_reduce(<span class="variable">$pipes</span>, <span class="variable">$this</span>-&gt;getSlice(), <span class="variable">$firstSlice</span>), <span class="variable">$this</span>-&gt;passable);</span><br></pre></td></tr></table></figure></p>
<p> 这样就能依次执行中间件handle方法，在handle方法里又会去再次调用之前说的reduce包装的洋葱闭包剩余的部分，这样一层层的把洋葱剥开直到最后。通过这种方式让请求对象依次流过了要通过的中间件，达到目的地Http Kernel 的<code>dispatchToRouter</code>方法。</p>
<p>通过剥洋葱的过程我们就能知道为什么在array_reduce之前要先对middleware数组进行反转, 因为包装是一个反向的过程, 数组$pipes中的第一个中间件会作为第一次reduce执行的结果被包装在洋葱闭包的最内层，所以只有反转后才能保证初始定义的中间件数组中第一个中间件的handle方法会被最先调用。</p>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2018/10/17/laravel学习之路由/">laravel学习之路由</a><a class="next" href="/2018/10/11/laravel学习之Facades/">laravel学习之Facades</a></div><div id="SOHUCS" sid="1539524432000"></div><script>(function(){var appid='cytTB77q5';var conf='';var width=window.innerWidth||document.documentElement.clientWidth;if(width<960){window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id='+appid+'&conf='+conf+'"><\/script>')}else{var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})})}})()
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://blog.xhzyxed.cn"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/408/">408</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/http/">http</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/memcached/">memcached</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vuejs/">vuejs</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web安全/">web安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端构建工具/">前端构建工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/推文/">推文</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/项目/">项目</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/11/01/nosql学习汇总/">nosql学习汇总</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/31/deployer的使用报告/">deployer的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/20/laravel学习之Response/">laravel学习之Response</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/20/laravel学习之Request/">laravel学习之Request</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/17/laravel学习之路由/">laravel学习之路由</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/14/laravel学习之中间件/">laravel学习之中间件</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/11/laravel学习之Facades/">laravel学习之Facades</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/10/laravel学习之服务提供者/">laravel学习之服务提供者</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/09/laravel学习之服务容器/">laravel学习之服务容器</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/09/laravel请求到响应的整个过程/">laravel请求到响应的整个过程</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://org.xhzyxed.cn/" title="小猴子与小耳朵" target="_blank">小猴子与小耳朵</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">其斤.匕禾页.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>