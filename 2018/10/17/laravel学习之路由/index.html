<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="努力，奋斗！"><title>laravel学习之路由 | 其斤.匕禾页</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '9a5a3ed9eb997f28f7eaa023ee5905bc';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">laravel学习之路由</h1><a id="logo" href="/.">其斤.匕禾页</a><p class="description">站在巨人的肩膀上，做只勤奋的小蜜蜂！</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/2018/10/02/lnmp技术栈文章汇总/"><i class="fa fa-archive"> LNMP技术栈</i></a><a href="/2018/10/02/速读laravel源码/"><i class="fa fa-archive"> laravel框架学习</i></a><a href="https://zhimap.com/mmap/773f7025d57f4c24b3c680bd9972c7e8"><i class="fa fa-archive"> 秒杀系统学习</i></a><a href="/2018/11/01/nosql学习汇总/"><i class="fa fa-archive"> nosql</i></a><a href="/2018/09/22/408基础/"><i class="fa fa-archive"> 计算机基础</i></a><a href="/2018/09/17/resume/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">laravel学习之路由</h1><div class="post-meta">Oct 17, 2018<span> | </span><span class="category"><a href="/categories/php/">php</a></span></div><a class="ds-thread-count" href="/2018/10/17/laravel学习之路由/#SOHUCS"><span id="changyan_count_unit" style="font-size: 15px; color: #6E7173;">0</span><span> 条评论</span></a><script src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js" async></script><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#路由"><span class="toc-number">1.</span> <span class="toc-text">路由</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#路由定义"><span class="toc-number">1.1.</span> <span class="toc-text">路由定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#路由加载"><span class="toc-number">1.2.</span> <span class="toc-text">路由加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#路由注册"><span class="toc-number">1.3.</span> <span class="toc-text">路由注册</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#路由寻址"><span class="toc-number">1.3.1.</span> <span class="toc-text">路由寻址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#路由参数绑定"><span class="toc-number">1.3.2.</span> <span class="toc-text">路由参数绑定</span></a></li></ol></li></ol></li></ol></div></div><div class="post-content"><p>laravel重要组件-路由了解一下</p>
<a id="more"></a>
<h1 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h1><p>自定义路由大概是laravel很亮眼的一个功能了，无论URI对应的处理程序是一个简单的闭包还是说是控制器方法没有对应的路由外界都访问不到他们，今天我们就来看看Laravel是如何来设计和实现路由的。</p>
<h2 id="路由定义"><a href="#路由定义" class="headerlink" title="路由定义"></a>路由定义</h2><p>我们在路由文件里通常是向下面这样来定义路由的：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Route::get(<span class="string">'/user'</span>, <span class="string">'UsersController@index'</span>);</span><br></pre></td></tr></table></figure></p>
<p>通过上面的路由我们可以知道，客户端通过以HTTP GET方式来请求 URI “/user”时，Laravel会把请求最终派发给UsersController类的index方法来进行处理，然后在index方法中返回响应给客户端。</p>
<p>上面注册路由时用到的Route类在Laravel里叫门面（Facade），它提供了一种简单的方式来访问绑定到服务容器里的服务router，至于facade我们在上一篇文章已经提过了</p>
<p>router这个服务是在实例化应用程序Application时在构造方法里通过注册RoutingServiceProvider时绑定到服务容器里的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">//bootstrap/app.php</span><br><span class="line">   <span class="variable">$app</span> = new Illuminate\Foundation\Application(</span><br><span class="line">       realpath(__DIR__.<span class="string">'/../'</span>)</span><br><span class="line">   );</span><br><span class="line"></span><br><span class="line">//Application: 构造方法</span><br><span class="line">   public <span class="keyword">function</span> __construct(<span class="variable">$basePath</span> = null)</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="variable">$basePath</span>) &#123;</span><br><span class="line">           <span class="variable">$this</span>-&gt;setBasePath(<span class="variable">$basePath</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="variable">$this</span>-&gt;registerBaseBindings();</span><br><span class="line"></span><br><span class="line">       <span class="variable">$this</span>-&gt;registerBaseServiceProviders();</span><br><span class="line"></span><br><span class="line">       <span class="variable">$this</span>-&gt;registerCoreContainerAliases();</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   //Application: 注册基础的服务提供器</span><br><span class="line">   protected <span class="keyword">function</span> registerBaseServiceProviders()</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="variable">$this</span>-&gt;register(new EventServiceProvider(<span class="variable">$this</span>));</span><br><span class="line"></span><br><span class="line">       <span class="variable">$this</span>-&gt;register(new LogServiceProvider(<span class="variable">$this</span>));</span><br><span class="line"></span><br><span class="line">       <span class="variable">$this</span>-&gt;register(new RoutingServiceProvider(<span class="variable">$this</span>));</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   //\Illuminate\Routing\RoutingServiceProvider: 绑定router到服务容器</span><br><span class="line">   protected <span class="keyword">function</span> registerRouter()</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="variable">$this</span>-&gt;app-&gt;singleton(<span class="string">'router'</span>, <span class="keyword">function</span> (<span class="variable">$app</span>) &#123;</span><br><span class="line">           <span class="built_in">return</span> new Router(<span class="variable">$app</span>[<span class="string">'events'</span>], <span class="variable">$app</span>);</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p> 通过上面的代码我们知道了Route调用的静态方法都对应于<code>\Illuminate\Routing\Router</code>类里的方法，Router这个类里包含了与路由的注册、寻址、调度相关的方法。</p>
<p>下面我们从路由的加载，注册，寻址这几个阶段来看一下laravel里是如何实现这些的。</p>
<h2 id="路由加载"><a href="#路由加载" class="headerlink" title="路由加载"></a>路由加载</h2><p>注册路由前需要先加载路由文件，路由文件的加载是在<code>App\Providers\RouteServiceProvider</code>这个服务器提供者的boot方法里加载的:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::boot();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">map</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mapApiRoutes();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;mapWebRoutes();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">mapWebRoutes</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Route::middleware(<span class="string">'web'</span>)</span><br><span class="line">             -&gt;namespace(<span class="keyword">$this</span>-&gt;namespace)</span><br><span class="line">             -&gt;group(base_path(<span class="string">'routes/web.php'</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">mapApiRoutes</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Route::prefix(<span class="string">'api'</span>)</span><br><span class="line">             -&gt;middleware(<span class="string">'api'</span>)</span><br><span class="line">             -&gt;namespace(<span class="keyword">$this</span>-&gt;namespace)</span><br><span class="line">             -&gt;group(base_path(<span class="string">'routes/api.php'</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Support</span>\<span class="title">Providers</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setRootControllerNamespace();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;app-&gt;routesAreCached()) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;loadCachedRoutes();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;loadRoutes();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;app-&gt;booted(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;app[<span class="string">'router'</span>]-&gt;getRoutes()-&gt;refreshNameLookups();</span><br><span class="line">                <span class="keyword">$this</span>-&gt;app[<span class="string">'router'</span>]-&gt;getRoutes()-&gt;refreshActionLookups();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">loadCachedRoutes</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;app-&gt;booted(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">require</span> <span class="keyword">$this</span>-&gt;app-&gt;getCachedRoutesPath();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">loadRoutes</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (method_exists(<span class="keyword">$this</span>, <span class="string">'map'</span>)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;app-&gt;call([<span class="keyword">$this</span>, <span class="string">'map'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">Container</span> <span class="keyword">implements</span> <span class="title">ApplicationContract</span>, <span class="title">HttpKernelInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">routesAreCached</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>[<span class="string">'files'</span>]-&gt;exists(<span class="keyword">$this</span>-&gt;getCachedRoutesPath());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCachedRoutesPath</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;bootstrapPath().<span class="string">'/cache/routes.php'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>laravel 首先去寻找路由的缓存文件，没有缓存文件再去进行加载路由。缓存文件一般在 bootstrap/cache/routes.php 文件中。<br>方法loadRoutes会调用map方法来加载路由文件里的路由，map这个函数在<code>App\Providers\RouteServiceProvider</code>类中，这个类继承自<code>Illuminate\Foundation\Support\Providers\RouteServiceProvider</code>。通过map方法我们能看到laravel将路由分为两个大组：api、web。这两个部分的路由分别写在两个文件中：routes/web.php、routes/api.php。</p>
<p><strong><em>Laravel5.5里是把路由分别放在了几个文件里，之前的版本是在app/Http/routes.php文件里。放在多个文件里能更方便地管理API路由和与WEB路由</em></strong></p>
<h2 id="路由注册"><a href="#路由注册" class="headerlink" title="路由注册"></a>路由注册</h2><p>我们通常都是用Route这个Facade调用静态方法get, post, head, options, put, patch, delete……等来注册路由，上面我们也说了这些静态方法其实是调用了Router类里的方法:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> get(<span class="variable">$uri</span>, <span class="variable">$action</span> = null)</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="built_in">return</span> <span class="variable">$this</span>-&gt;addRoute([<span class="string">'GET'</span>, <span class="string">'HEAD'</span>], <span class="variable">$uri</span>, <span class="variable">$action</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   public <span class="keyword">function</span> post(<span class="variable">$uri</span>, <span class="variable">$action</span> = null)</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="built_in">return</span> <span class="variable">$this</span>-&gt;addRoute(<span class="string">'POST'</span>, <span class="variable">$uri</span>, <span class="variable">$action</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到路由的注册统一都是由router类的addRoute方法来处理的：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">//注册路由到RouteCollection</span><br><span class="line">    protected <span class="keyword">function</span> addRoute(<span class="variable">$methods</span>, <span class="variable">$uri</span>, <span class="variable">$action</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$this</span>-&gt;routes-&gt;add(<span class="variable">$this</span>-&gt;createRoute(<span class="variable">$methods</span>, <span class="variable">$uri</span>, <span class="variable">$action</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //创建路由</span><br><span class="line">    protected <span class="keyword">function</span> createRoute(<span class="variable">$methods</span>, <span class="variable">$uri</span>, <span class="variable">$action</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$this</span>-&gt;actionReferencesController(<span class="variable">$action</span>)) &#123;</span><br><span class="line">        	//controller@action类型的路由在这里要进行转换</span><br><span class="line">            <span class="variable">$action</span> = <span class="variable">$this</span>-&gt;convertToControllerAction(<span class="variable">$action</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$route</span> = <span class="variable">$this</span>-&gt;newRoute(</span><br><span class="line">            <span class="variable">$methods</span>, <span class="variable">$this</span>-&gt;prefix(<span class="variable">$uri</span>), <span class="variable">$action</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$this</span>-&gt;hasGroupStack()) &#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;mergeGroupAttributesIntoRoute(<span class="variable">$route</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$this</span>-&gt;addWhereClausesToRoute(<span class="variable">$route</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$route</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    protected <span class="keyword">function</span> convertToControllerAction(<span class="variable">$action</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_string(<span class="variable">$action</span>)) &#123;</span><br><span class="line">            <span class="variable">$action</span> = [<span class="string">'uses'</span> =&gt; <span class="variable">$action</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! empty(<span class="variable">$this</span>-&gt;groupStack)) &#123;        </span><br><span class="line">            <span class="variable">$action</span>[<span class="string">'uses'</span>] = <span class="variable">$this</span>-&gt;prependGroupNamespace(<span class="variable">$action</span>[<span class="string">'uses'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$action</span>[<span class="string">'controller'</span>] = <span class="variable">$action</span>[<span class="string">'uses'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$action</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>注册路由时传递给addRoute的第三个参数action可以闭包、字符串或者数组，数组就是类似<code>[&#39;uses&#39; =&gt; &#39;Controller@action&#39;, &#39;middleware&#39; =&gt; &#39;...&#39;]</code>这种形式的。如果action是<code>Controller@action</code>类型的路由将被转换为action数组, convertToControllerAction执行完后action的内容为：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[</span><br><span class="line">		<span class="string">'uses'</span> =&gt; <span class="string">'App\Http\Controllers\SomeController@someAction'</span>,</span><br><span class="line">		<span class="string">'controller'</span> =&gt; <span class="string">'App\Http\Controllers\SomeController@someAction'</span></span><br><span class="line">	]</span><br></pre></td></tr></table></figure></p>
<p>可以看到把命名空间补充到了控制器的名称前组成了完整的控制器类名，action数组构建完成接下里就是创建路由了，创建路由即用指定的HTTP请求方法、URI字符串和action数组来创建<code>\Illuminate\Routing\Route</code>类的实例:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">protected <span class="keyword">function</span> newRoute(<span class="variable">$methods</span>, <span class="variable">$uri</span>, <span class="variable">$action</span>)</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="built_in">return</span> (new Route(<span class="variable">$methods</span>, <span class="variable">$uri</span>, <span class="variable">$action</span>))</span><br><span class="line">                   -&gt;setRouter(<span class="variable">$this</span>)</span><br><span class="line">                   -&gt;setContainer(<span class="variable">$this</span>-&gt;container);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>路由创建完成后将Route添加到RouteCollection中去：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">protected <span class="keyword">function</span> addRoute(<span class="variable">$methods</span>, <span class="variable">$uri</span>, <span class="variable">$action</span>)</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="built_in">return</span> <span class="variable">$this</span>-&gt;routes-&gt;add(<span class="variable">$this</span>-&gt;createRoute(<span class="variable">$methods</span>, <span class="variable">$uri</span>, <span class="variable">$action</span>));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>router的$routes属性就是一个RouteCollection对象，添加路由到RouteCollection对象时会更新RouteCollection对象的routes、allRoutes、nameList和actionList属性<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class RouteCollection implements Countable, IteratorAggregate</span><br><span class="line">	&#123;</span><br><span class="line">        public <span class="keyword">function</span> add(Route <span class="variable">$route</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;addToCollections(<span class="variable">$route</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable">$this</span>-&gt;addLookups(<span class="variable">$route</span>);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">return</span> <span class="variable">$route</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        protected <span class="keyword">function</span> addToCollections(<span class="variable">$route</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$domainAndUri</span> = <span class="variable">$route</span>-&gt;getDomain().<span class="variable">$route</span>-&gt;uri();</span><br><span class="line"></span><br><span class="line">            foreach (<span class="variable">$route</span>-&gt;methods() as <span class="variable">$method</span>) &#123;</span><br><span class="line">                <span class="variable">$this</span>-&gt;routes[<span class="variable">$method</span>][<span class="variable">$domainAndUri</span>] = <span class="variable">$route</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$this</span>-&gt;allRoutes[<span class="variable">$method</span>.<span class="variable">$domainAndUri</span>] = <span class="variable">$route</span>;</span><br><span class="line">    	&#125;</span><br><span class="line">    	</span><br><span class="line">        protected <span class="keyword">function</span> addLookups(<span class="variable">$route</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$action</span> = <span class="variable">$route</span>-&gt;getAction();</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span> (isset(<span class="variable">$action</span>[<span class="string">'as'</span>])) &#123;</span><br><span class="line">            	//如果时命名路由，将route对象映射到以路由名为key的数组值中方便查找</span><br><span class="line">                <span class="variable">$this</span>-&gt;nameList[<span class="variable">$action</span>[<span class="string">'as'</span>]] = <span class="variable">$route</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span> (isset(<span class="variable">$action</span>[<span class="string">'controller'</span>])) &#123;</span><br><span class="line">                <span class="variable">$this</span>-&gt;addToActionList(<span class="variable">$action</span>, <span class="variable">$route</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>RouteCollection的四个属性</p>
<p>routes中存放了HTTP请求方法与路由对象的映射:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">		<span class="string">'GET'</span> =&gt; [</span><br><span class="line">			<span class="variable">$routeUri1</span> =&gt; <span class="variable">$routeObj1</span></span><br><span class="line">			...</span><br><span class="line">		]</span><br><span class="line">		...</span><br><span class="line">	]</span><br></pre></td></tr></table></figure></p>
<p>allRoutes属性里存放的内容时将routes属性里的二维数组变成一维数组后的内容:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">		<span class="string">'GET'</span> . <span class="variable">$routeUri1</span> =&gt; <span class="variable">$routeObj1</span></span><br><span class="line">		<span class="string">'GET'</span> . <span class="variable">$routeUri2</span> =&gt; <span class="variable">$routeObj2</span></span><br><span class="line">		...</span><br><span class="line">	]</span><br></pre></td></tr></table></figure></p>
<p>nameList是路由名称与路由对象的一个映射表<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">		<span class="variable">$routeName1</span> =&gt; <span class="variable">$routeObj1</span></span><br><span class="line">		...</span><br><span class="line">	]</span><br></pre></td></tr></table></figure></p>
<p>actionList是路由控制器方法字符串与路由对象的映射表<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[</span><br><span class="line">		<span class="string">'App\Http\Controllers\ControllerOne@ActionOne'</span> =&gt; <span class="variable">$routeObj1</span></span><br><span class="line">	]</span><br></pre></td></tr></table></figure></p>
<p>这样就算注册好路由了。</p>
<h3 id="路由寻址"><a href="#路由寻址" class="headerlink" title="路由寻址"></a>路由寻址</h3><p>在后面中间件的文章里我们看到HTTP请求是在经过Pipeline通道上的中间件的前置操作后到达目的地:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Illuminate\Foundation\Http\Kernel</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Kernel</span> <span class="keyword">implements</span> <span class="title">KernelContract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendRequestThroughRouter</span><span class="params">($request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</span><br><span class="line"></span><br><span class="line">        Facade::clearResolvedInstance(<span class="string">'request'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;bootstrap();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline(<span class="keyword">$this</span>-&gt;app))</span><br><span class="line">                    -&gt;send($request)</span><br><span class="line">                    -&gt;through(<span class="keyword">$this</span>-&gt;app-&gt;shouldSkipMiddleware() ? [] : <span class="keyword">$this</span>-&gt;middleware)</span><br><span class="line">                    -&gt;then(<span class="keyword">$this</span>-&gt;dispatchToRouter());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToRouter</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($request)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;router-&gt;dispatch($request);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码可以看到Pipeline的destination就是dispatchToRouter函数返回的闭包:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$destination = <span class="function"><span class="keyword">function</span> <span class="params">($request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;router-&gt;dispatch($request);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在闭包里调用了router的dispatch方法，路由寻址就发生在dispatch的第一个阶段findRoute里：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span> <span class="keyword">implements</span> <span class="title">RegistrarContract</span>, <span class="title">BindingRegistrar</span></span></span><br><span class="line"><span class="class"></span>&#123;	</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;currentRequest = $request;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dispatchToRoute($request);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToRoute</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;runRoute($request, <span class="keyword">$this</span>-&gt;findRoute($request));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">findRoute</span><span class="params">($request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;current = $route = <span class="keyword">$this</span>-&gt;routes-&gt;match($request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;container-&gt;instance(Route::class, $route);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $route;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>寻找路由的任务由 RouteCollection 负责，这个函数负责匹配路由，并且把 request 的 url 参数绑定到路由中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteCollection</span> <span class="keyword">implements</span> <span class="title">Countable</span>, <span class="title">IteratorAggregate</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">match</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $routes = <span class="keyword">$this</span>-&gt;get($request-&gt;getMethod());</span><br><span class="line"></span><br><span class="line">        $route = <span class="keyword">$this</span>-&gt;matchAgainstRoutes($routes, $request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! is_null($route)) &#123;</span><br><span class="line">            <span class="comment">//找到匹配的路由后，将URI里的路径参数绑定赋值给路由(如果有的话)</span></span><br><span class="line">            <span class="keyword">return</span> $route-&gt;bind($request);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $others = <span class="keyword">$this</span>-&gt;checkForAlternateVerbs($request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count($others) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getRouteForMethods($request, $others);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotFoundHttpException;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">matchAgainstRoutes</span><span class="params">(array $routes, $request, $includingMethod = true)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Arr::first($routes, <span class="function"><span class="keyword">function</span> <span class="params">($value)</span> <span class="title">use</span> <span class="params">($request, $includingMethod)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $value-&gt;matches($request, $includingMethod);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Route</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">matches</span><span class="params">(Request $request, $includingMethod = true)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;compileRoute();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;getValidators() <span class="keyword">as</span> $validator) &#123;</span><br><span class="line">            <span class="keyword">if</span> (! $includingMethod &amp;&amp; $validator <span class="keyword">instanceof</span> MethodValidator) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (! $validator-&gt;matches(<span class="keyword">$this</span>, $request)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>$routes = $this-&gt;get($request-&gt;getMethod());</code>会先加载注册路由阶段在RouteCollection里生成的routes属性里的值，routes中存放了HTTP请求方法与路由对象的映射。</p>
<p>然后依次调用这堆路由里路由对象的matches方法， matches方法, matches方法里会对HTTP请求对象进行一些验证，验证对应的Validator是：UriValidator、MethodValidator、SchemeValidator、HostValidator。<br>在验证之前在<code>$this-&gt;compileRoute()</code>里会将路由的规则转换成正则表达式。</p>
<p>UriValidator主要是看请求对象的URI是否与路由的正则规则匹配能匹配上:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UriValidator</span> <span class="keyword">implements</span> <span class="title">ValidatorInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">matches</span><span class="params">(Route $route, Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $path = $request-&gt;path() == <span class="string">'/'</span> ? <span class="string">'/'</span> : <span class="string">'/'</span>.$request-&gt;path();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> preg_match($route-&gt;getCompiled()-&gt;getRegex(), rawurldecode($path));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MethodValidator验证请求方法, SchemeValidator验证协议是否正确(http|https), HostValidator验证域名, 如果路由中不设置host属性，那么这个验证不会进行。</p>
<p>一旦某个路由通过了全部的认证就将会被返回，接下来就要将请求对象URI里的路径参数绑定复制给路由参数:</p>
<h3 id="路由参数绑定"><a href="#路由参数绑定" class="headerlink" title="路由参数绑定"></a>路由参数绑定</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Route</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bind</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;compileRoute();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;parameters = (<span class="keyword">new</span> RouteParameterBinder(<span class="keyword">$this</span>))</span><br><span class="line">                        -&gt;parameters($request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteParameterBinder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parameters</span><span class="params">($request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $parameters = <span class="keyword">$this</span>-&gt;bindPathParameters($request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! is_null(<span class="keyword">$this</span>-&gt;route-&gt;compiled-&gt;getHostRegex())) &#123;</span><br><span class="line">            $parameters = <span class="keyword">$this</span>-&gt;bindHostParameters(</span><br><span class="line">                $request, $parameters</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;replaceDefaults($parameters);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">bindPathParameters</span><span class="params">($request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">            preg_match(<span class="keyword">$this</span>-&gt;route-&gt;compiled-&gt;getRegex(), <span class="string">'/'</span>.$request-&gt;decodedPath(), $matches);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;matchToKeys(array_slice($matches, <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">matchToKeys</span><span class="params">(array $matches)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($parameterNames = <span class="keyword">$this</span>-&gt;route-&gt;parameterNames())) &#123;</span><br><span class="line">            <span class="keyword">return</span> [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $parameters = array_intersect_key($matches, array_flip($parameterNames));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> array_filter($parameters, <span class="function"><span class="keyword">function</span> <span class="params">($value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> is_string($value) &amp;&amp; strlen($value) &gt; <span class="number">0</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>赋值路由参数完成后路由寻址的过程就结束了，结下来就该运行通过匹配路由中对应的控制器方法返回响应对象了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Routing</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span> <span class="keyword">implements</span> <span class="title">RegistrarContract</span>, <span class="title">BindingRegistrar</span></span></span><br><span class="line"><span class="class"></span>&#123;	</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;currentRequest = $request;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dispatchToRoute($request);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToRoute</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;runRoute($request, <span class="keyword">$this</span>-&gt;findRoute($request));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runRoute</span><span class="params">(Request $request, Route $route)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $request-&gt;setRouteResolver(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($route)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $route;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;events-&gt;dispatch(<span class="keyword">new</span> Events\RouteMatched($route, $request));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;prepareResponse($request,</span><br><span class="line">            <span class="keyword">$this</span>-&gt;runRouteWithinStack($route, $request)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runRouteWithinStack</span><span class="params">(Route $route, Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $shouldSkipMiddleware = <span class="keyword">$this</span>-&gt;container-&gt;bound(<span class="string">'middleware.disable'</span>) &amp;&amp;</span><br><span class="line">                            <span class="keyword">$this</span>-&gt;container-&gt;make(<span class="string">'middleware.disable'</span>) === <span class="keyword">true</span>;</span><br><span class="line">	<span class="comment">//收集路由和控制器里应用的中间件</span></span><br><span class="line">        $middleware = $shouldSkipMiddleware ? [] : <span class="keyword">$this</span>-&gt;gatherRouteMiddleware($route);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline(<span class="keyword">$this</span>-&gt;container))</span><br><span class="line">                    -&gt;send($request)</span><br><span class="line">                    -&gt;through($middleware)</span><br><span class="line">                    -&gt;then(<span class="function"><span class="keyword">function</span> <span class="params">($request)</span> <span class="title">use</span> <span class="params">($route)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;prepareResponse(</span><br><span class="line">                            $request, $route-&gt;run()</span><br><span class="line">                        );</span><br><span class="line">                    &#125;);</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Routing</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Route</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;container = <span class="keyword">$this</span>-&gt;container ?: <span class="keyword">new</span> Container;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isControllerAction()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;runController();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;runCallable();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (HttpResponseException $e) &#123;</span><br><span class="line">            <span class="keyword">return</span> $e-&gt;getResponse();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们主要介绍路由相关的内容，runRoute的过程通过上面的源码可以看到其实也很复杂， 会收集路由和控制器里的中间件，将请求通过中间件过滤才会最终到达目的地路由，执行目的路由地<code>run()</code>方法，里面会判断路由对应的是一个控制器方法还是闭包然后进行相应地调用，最后把执行结果包装成Response对象返回给客户端</p>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2018/10/20/laravel学习之Request/">laravel学习之Request</a><a class="next" href="/2018/10/14/laravel学习之中间件/">laravel学习之中间件</a></div><div id="SOHUCS" sid="1539790919000"></div><script>(function(){var appid='cytTB77q5';var conf='';var width=window.innerWidth||document.documentElement.clientWidth;if(width<960){window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id='+appid+'&conf='+conf+'"><\/script>')}else{var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})})}})()
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/408/">408</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/http/">http</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/memcached/">memcached</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vuejs/">vuejs</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web安全/">web安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端构建工具/">前端构建工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/推文/">推文</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/项目/">项目</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/11/01/nosql学习汇总/">nosql学习汇总</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/31/deployer的使用报告/">deployer的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/20/laravel学习之Response/">laravel学习之Response</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/20/laravel学习之Request/">laravel学习之Request</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/17/laravel学习之路由/">laravel学习之路由</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/14/laravel学习之中间件/">laravel学习之中间件</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/11/laravel学习之Facades/">laravel学习之Facades</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/10/laravel学习之服务提供者/">laravel学习之服务提供者</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/09/laravel学习之服务容器/">laravel学习之服务容器</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/09/laravel请求到响应的整个过程/">laravel请求到响应的整个过程</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://org.xhzyxed.cn/" title="小猴子与小耳朵" target="_blank">小猴子与小耳朵</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">其斤.匕禾页.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>